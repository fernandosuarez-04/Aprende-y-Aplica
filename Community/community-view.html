<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=0.6, maximum-scale=0.6, user-scalable=yes">
    <title>Comunidad - Detalle</title>
    

    
    <link rel="stylesheet" href="community.css">
    <!-- Font Awesome - usando versi√≥n compatible con CSP -->
    <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin="anonymous" />
    
    <!-- Global theme setup -->
    <script src="../scripts/global-theme-setup.js"></script>

    <meta name="supabase-url" content="https://miwbzotcuaywpdbidpwo.supabase.co">
    <meta name="supabase-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pd2J6b3RjdWF5d3BkYmlkcHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MTEyMjksImV4cCI6MjA3MDE4NzIyOX0.IKXYAe1JBFc_pcaS6OjxKUVJePwnfHgc0sRO6WpJSBY
">
    
    <!-- OPTIMIZACI√ìN: Script inline para cargar banner inmediatamente -->
    <script>
        // Cargar banner inmediatamente sin esperar DOMContentLoaded
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const communitySlug = urlParams.get('slug') || 'general';
            
            // Buscar datos en localStorage inmediatamente
            const savedCommunities = localStorage.getItem('savedCommunities');
            if (savedCommunities) {
                try {
                    const communities = JSON.parse(savedCommunities);
                    const community = communities.find(c => c.slug === communitySlug);
                    
                    if (community) {
                        // Actualizar t√≠tulo de la p√°gina inmediatamente
                        document.title = `Comunidad de ${community.name}`;
                        console.log('üöÄ Banner precargado desde localStorage:', community.name);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error precargando banner:', error);
                }
            }
        })();
    </script>

    <style>
        /* Estilos para los rangos de ligas */
        .league-ranges-container {
            margin: 30px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .league-ranges-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .league-ranges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .league-range-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--background);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .league-range-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .league-range-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            background: var(--surface);
        }
        
        .league-icon-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .league-range-info h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 5px 0;
        }
        
        .league-range-points {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: 500;
        }
        
        /* Estilos para el badge de liga del usuario */
        .league-profile-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .league-badge-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /* Layout de dos columnas superiores */
        .leagues-top-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            align-items: start;
            margin-bottom: 30px;
        }

        .league-ranges-sidebar {
            background: var(--gradient-card);
            border: 1px solid rgba(68, 229, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            height: fit-content;
        }

        .league-ranges-vertical {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .league-ranges-vertical .league-range-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(68, 229, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(68, 229, 255, 0.1);
            transition: all 0.3s ease;
        }

        .league-ranges-vertical .league-range-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(68, 229, 255, 0.2);
        }

        .league-ranges-vertical .league-range-icon {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }

        .league-ranges-vertical .league-range-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .league-ranges-vertical .league-range-points {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Sidebar de puntos por acci√≥n */
        .points-sidebar {
            background: var(--gradient-card);
            border: 1px solid rgba(68, 229, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            height: fit-content;
        }

        .points-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            text-align: center;
        }

        .points-grid-2x2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .points-grid-2x2 .points-info-card {
            background: rgba(68, 229, 255, 0.05);
            border: 1px solid rgba(68, 229, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .points-grid-2x2 .points-info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(68, 229, 255, 0.2);
        }

        .points-grid-2x2 .points-info-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
            color: white;
            font-size: 16px;
        }

        .points-grid-2x2 h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .points-grid-2x2 p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Panel de clasificaci√≥n a ancho completo */
        .leaderboard-full-width {
            width: 100%;
        }

        /* Estilos para la tabla de clasificaci√≥n */
        .leaderboard-table {
            margin-top: 20px;
            min-height: 500px;
            max-height: 600px;
            background: rgba(68, 229, 255, 0.05);
            border: 2px dashed rgba(68, 229, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            
            /* Scrollbar personalizada */
            scrollbar-width: thin;
            scrollbar-color: rgba(68, 229, 255, 0.5) rgba(68, 229, 255, 0.1);
        }

        /* Scrollbar personalizada para Webkit (Chrome, Safari, Edge) */
        .leaderboard-table::-webkit-scrollbar {
            width: 8px;
        }

        .leaderboard-table::-webkit-scrollbar-track {
            background: rgba(68, 229, 255, 0.1);
            border-radius: 4px;
            margin: 4px 0;
        }

        .leaderboard-table::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(68, 229, 255, 0.6), rgba(68, 229, 255, 0.3));
            border-radius: 4px;
            border: 1px solid rgba(68, 229, 255, 0.2);
        }

        .leaderboard-table::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(68, 229, 255, 0.8), rgba(68, 229, 255, 0.5));
            box-shadow: 0 0 8px rgba(68, 229, 255, 0.4);
        }

        .leaderboard-table::-webkit-scrollbar-corner {
            background: transparent;
        }

        .leaderboard-table:empty::before {
            content: "üîç Debug: Esperando datos de usuarios...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            text-align: center;
        }

        /* Responsive para el layout de ligas */
        @media (max-width: 1024px) {
            .leagues-top-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .points-grid-2x2 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .points-grid-2x2 {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el header del leaderboard con filtros */
        .leaderboard-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .leagues-filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .league-filter {
            padding: 8px 16px;
            background: rgba(68, 229, 255, 0.1);
            border: 1px solid rgba(68, 229, 255, 0.3);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .league-filter:hover {
            background: rgba(68, 229, 255, 0.2);
            border-color: rgba(68, 229, 255, 0.5);
            transform: translateY(-1px);
        }

        .league-filter.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(68, 229, 255, 0.3);
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .leaderboard-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .leaderboard-position {
            width: 60px;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-primary);
            text-align: center;
        }

        .leaderboard-user {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .user-league {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .leaderboard-points {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .empty-leaderboard {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-leaderboard i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-leaderboard p {
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .league-ranges-grid {
                grid-template-columns: 1fr;
            }
            
            .league-range-card {
                padding: 12px;
            }
            
            .league-range-icon {
                width: 50px;
                height: 50px;
                margin-right: 12px;
            }
            
            .league-icon-img {
                width: 100%;
                height: 100%;
            }

            .leaderboard-row {
                padding: 12px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .leaderboard-position {
                width: auto;
                order: 1;
            }

            .leaderboard-user {
                order: 2;
                flex-direction: column;
                gap: 8px;
            }

            .leaderboard-points {
                order: 3;
            }

            .user-avatar {
                width: 50px;
                height: 50px;
            }
        }

        /* OPTIMIZACI√ìN: Estilos para skeleton loading */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            display: inline-block;
            min-width: 100px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Ocultar skeleton cuando se carga el contenido real */
        .banner-loaded .loading-skeleton {
            display: none;
        }

        .banner-loaded .community-banner-title,
        .banner-loaded .community-banner-desc,
        .banner-loaded .community-banner-meta {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para im√°genes de avatar de miembros */
        .member-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }

        /* Estilos para im√°genes de avatar de comentarios */
        .comment-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }

        .member-avatar-fallback {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .member-avatar {
            position: relative;
            overflow: hidden;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--glass-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .member-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border: 2px solid var(--background);
            border-radius: 50%;
            z-index: 2;
        }

        /* Estilos para tarjetas de miembros */
        .member-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 12px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .member-card:hover {
            background: var(--hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .member-info {
            flex: 1;
            margin-left: 16px;
            min-width: 0;
        }

        .member-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .member-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .member-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .member-badge.admin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .member-badge.online {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .member-location,
        .member-status-text,
        .member-joined {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Ocultar elementos espec√≠ficos solicitados */
        .members-count .membership-btn,
        .members-count .members-ship,
        .member-status-text,
        .count-info,
        .members-chip[data-filter="online"] {
            display: none !important;
        }

        .online-dot {
            color: #4CAF50;
            font-size: 8px;
        }

        .members-count {
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            backdrop-filter: blur(20px);
        }

        .count-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .online-count {
            color: #4CAF50;
            font-weight: 600;
        }

        .total-count {
            color: var(--text-tertiary);
        }

        /* Estilos para botones de reacciones */
        .react-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .react-btn:hover {
            background: var(--surface-hover);
            transform: scale(1.05);
        }

        .react-btn.reacted {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.3);
        }

        .react-btn.reacted:hover {
            background: var(--primary-color);
            transform: scale(1.02);
        }

        /* Estilos para botones de acciones de post */
        .post-action {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .post-action:hover {
            background: var(--surface-hover);
        }

        /* Estilos para encuestas interactivas */
        .post-poll-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            backdrop-filter: blur(20px);
        }

        .poll-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .poll-header i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .poll-question {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .poll-option-interactive {
            background: var(--surface);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .poll-option-interactive:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(68, 229, 255, 0.2);
        }

        /* Estilos para opci√≥n votada por el usuario */
        .poll-option-interactive.user-voted {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(68, 229, 255, 0.15), rgba(68, 229, 255, 0.05));
            box-shadow: 0 2px 8px rgba(68, 229, 255, 0.3);
        }

        .poll-option-interactive.user-voted:hover {
            background: linear-gradient(135deg, rgba(68, 229, 255, 0.2), rgba(68, 229, 255, 0.08));
            box-shadow: 0 4px 12px rgba(68, 229, 255, 0.4);
        }

        .poll-option-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .poll-option-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .poll-option-votes {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .poll-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--surface-hover);
            border-radius: 0 0 6px 6px;
            overflow: hidden;
        }

        .poll-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), rgba(68, 229, 255, 0.6));
            transition: width 0.5s ease;
        }

        .poll-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .poll-total-votes {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .poll-user-hint {
            font-size: 12px;
            color: var(--text-tertiary);
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .poll-user-hint i {
            color: var(--primary-color);
        }

        /* Responsive para encuestas */
        @media (max-width: 768px) {
            .poll-question {
                font-size: 16px;
            }

            .poll-option-text {
                font-size: 14px;
            }

            .poll-option-votes {
                font-size: 12px;
            }
        }

        /* ===================================================================
           ESTILOS PARA SISTEMA DE CONTENIDO INTERACTIVO - ACERCA DE
           Modal de video y guideline cards clickeables
           ================================================================ */

        /* ===== MODAL DE VIDEO ===== */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .video-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }

        .video-modal-content {
            position: relative;
            background: var(--surface);
            border-radius: 16px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideUp 0.4s ease;
        }

        .video-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .video-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .video-modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .video-modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .video-modal-body {
            padding: 24px;
        }

        .video-player-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
        }

        .video-loading i {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .video-loading p {
            font-size: 1.1rem;
            margin: 0;
        }

        .video-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
        }

        .video-error i {
            font-size: 3rem;
            color: #ff6b6b;
            margin-bottom: 16px;
        }

        .video-error p {
            font-size: 1.1rem;
            margin: 0;
        }

        .video-description {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ===== GUIDELINE CARDS CLICKEABLES ===== */
        .guideline-card.clickable {
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .guideline-card.clickable:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(68, 229, 255, 0.3);
            border-color: var(--primary-color);
        }

        .guideline-card.clickable::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(68, 229, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .guideline-card.clickable:hover::after {
            opacity: 1;
        }

        .card-click-hint {
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .guideline-card.clickable:hover .card-click-hint {
            opacity: 1;
            transform: translateY(0);
        }

        .card-click-hint i {
            margin-right: 6px;
            animation: bounce 2s infinite;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .video-modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .video-modal-header {
                padding: 16px;
            }

            .video-modal-header h3 {
                font-size: 1.2rem;
            }

            .video-modal-body {
                padding: 16px;
            }

            .video-player-wrapper {
                padding-bottom: 75%; /* M√°s cuadrado en m√≥vil */
            }
        }

        /* FIN ESTILOS SISTEMA DE CONTENIDO INTERACTIVO */

        /* Estilos para bot√≥n de comentario con carga */
        .comment-btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .comment-btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .comment-btn-loading .btn-text {
            opacity: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el bot√≥n de env√≠o en modal */
        .modal-send-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .modal-send-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .modal-send-loading .btn-text {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-glow-global">
    <div class="particles-container"></div>

    <!-- Bot√≥n de regreso -->
    <button class="back-btn" onclick="window.location.href='community.html'" title="Volver a Comunidad">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>Volver</span>
    </button>


    <nav class="community-subnav">
        <div class="subnav-inner">
            <div class="subnav-tabs">
                <button class="subnav-link active" data-tab="community">Comunidad</button>
                <button class="subnav-link" data-tab="members">Miembros</button>
                <button class="subnav-link" data-tab="leagues">Ligas</button>
                <button class="subnav-link" data-tab="about">Acerca de</button>
            </div>
            <div class="subnav-search">
                <i class="fas fa-search"></i>
                <input class="subnav-input" id="viewSearch" type="text" placeholder="Buscar en esta comunidad...">
            </div>
        </div>
    </nav>

         <main class="main-content" id="main-content" style="padding-top:10px">
        <!-- Banner de la comunidad -->
        <div class="community-banner" id="communityBanner">
            <div class="community-banner-image" id="communityBannerImage"></div>
            <div class="community-banner-overlay">
                <div class="community-banner-content">
                    <div class="community-banner-icon" id="communityBannerIcon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="community-banner-info">
                        <h1 class="community-banner-title" id="communityBannerTitle">
                            <span class="loading-skeleton" id="bannerTitleSkeleton">Cargando...</span>
                        </h1>
                        <p class="community-banner-desc" id="communityBannerDesc">
                            <span class="loading-skeleton" id="bannerDescSkeleton">Cargando descripci√≥n...</span>
                        </p>
                        <div class="community-banner-meta" id="communityBannerMeta">
                            <span class="loading-skeleton" id="bannerMetaSkeleton">‚Ä¢ Cargando... ‚Ä¢ Free</span>
                        </div>
                    </div>
                    <div class="community-banner-actions" id="communityBannerActions" style="display: none;">
                        <button id="requestAccessBtn" class="btn-primary" style="display: none;">
                            Solicitar acceso
                        </button>
                        <button id="requestPendingBtn" class="btn-secondary" disabled style="display: none;">
                            Solicitud pendiente
                        </button>
                    </div>
                     <div class="community-stats" id="communityStats">
                         <div class="stat-item">
                             <span class="stat-number" id="totalPosts">0</span>
                             <span class="stat-label">Posts</span>
                         </div>
                         <div class="stat-item">
                             <span class="stat-number" id="totalComments">0</span>
                             <span class="stat-label">Comentarios</span>
                         </div>
                         <div class="stat-item">
                             <span class="stat-number" id="totalReactions">0</span>
                             <span class="stat-label">Reacciones</span>
                         </div>
                     </div>
                     

                    </div>
                </div>
            </div>
        </div>
        
        <section id="tab-community" class="feed-section">
            <div class="container">
                <div class="feed-main">
                    <div class="composer-card">
                        <div class="composer-avatar" id="composerAvatar">
                            <img id="composerAvatarImg" src="" alt="Tu foto de perfil" style="display: none;">
                            <i class="fas fa-user" id="composerAvatarIcon"></i>
                        </div>
                        <div class="composer-content">
                        <input id="composerInput" class="composer-input" type="text" placeholder="Escribe algo para la comunidad...">
                            <div class="composer-actions">
                                <button class="attach-menu-btn" id="attachMenuBtn" title="Agregar adjunto">
                                    <i class="fas fa-plus"></i>
                                    <span>Adjuntar</span>
                                </button>
                        <button id="publishPostBtn" class="composer-btn" disabled>Publicar</button>
                            </div>
                        </div>
                    </div>
                    <div class="attachments-preview" id="attachmentsPreview"></div>
                    <div id="postsList" class="posts-list"></div>
                </div>
            </div>
        </section>

        <section id="tab-members" class="members-section" style="display:none">
            <div class="container">
                <div class="members-filters">
                    <button class="members-chip active" data-filter="all">Todos</button>
                    <button class="members-chip" data-filter="online">En l√≠nea</button>
                    <button class="members-chip" data-filter="admins">Admins</button>
                </div>
                <div id="membersList"></div>
            </div>
        </section>

        <section id="tab-leagues" class="leagues-section" style="display:none">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Sistema de Ligas</h2>
                    <p class="section-subtitle">Gana puntos participando y sube de liga</p>
                </div>
                
                <!-- Tu perfil de liga -->
                <div class="league-profile-card">
                    <div class="league-profile-header">
                        <div class="league-profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="league-profile-info">
                            <h3 class="league-profile-name" id="currentUserName">Tu Nombre</h3>
                            <div class="league-profile-stats">
                                <span class="league-profile-points" id="currentUserPoints">0 puntos</span>
                                <span class="league-profile-league" id="currentUserLeague">Oro</span>
                            </div>
                        </div>
                        <div class="league-profile-badge" id="currentUserBadge">
                            <img src="images/liga-oro.png" alt="Liga Actual" id="currentUserLeagueImage" class="league-badge-img">
                        </div>
                    </div>
                    <div class="league-progress-bar">
                        <div class="league-progress-fill" id="leagueProgressFill"></div>
                        <span class="league-progress-text" id="leagueProgressText">0 / 100 puntos para subir</span>
                    </div>
                </div>



                <!-- Informaci√≥n de puntos -->
                <!-- Layout de dos columnas superiores -->
                <div class="leagues-top-layout">
                    <!-- Columna izquierda: Rangos de liga -->
                    <div class="league-ranges-sidebar">
                        <h3 class="league-ranges-title">Rangos de Puntos por Liga</h3>
                        <div class="league-ranges-vertical">
                            <div class="league-range-card">
                                <div class="league-range-icon">
                                    <img src="images/liga-oro.png" alt="Liga Oro" class="league-icon-img">
                                </div>
                                <div class="league-range-info">
                                    <h4>LIGA ORO</h4>
                                    <p class="league-range-points">0 - 499 puntos</p>
                                </div>
                            </div>
                            <div class="league-range-card">
                                <div class="league-range-icon">
                                    <img src="images/liga-platino.png" alt="Liga Platino" class="league-icon-img">
                                </div>
                                <div class="league-range-info">
                                    <h4>LIGA PLATINO</h4>
                                    <p class="league-range-points">500 - 999 puntos</p>
                                </div>
                            </div>
                            <div class="league-range-card">
                                <div class="league-range-icon">
                                    <img src="images/liga-diamante.png" alt="Liga Diamante" class="league-icon-img">
                                </div>
                                <div class="league-range-info">
                                    <h4>LIGA DIAMANTE</h4>
                                    <p class="league-range-points">1000+ puntos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Puntos por acci√≥n en matriz 2x2 -->
                    <div class="points-sidebar">
                        <h3 class="points-title">Puntos por Acci√≥n</h3>
                        <div class="points-grid-2x2">
                            <div class="points-info-card">
                                <div class="points-info-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <h4>Publicar</h4>
                                <p>+10 puntos</p>
                            </div>
                            <div class="points-info-card">
                                <div class="points-info-icon">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <h4>Comentar</h4>
                                <p>+5 puntos</p>
                            </div>
                            <div class="points-info-card">
                                <div class="points-info-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h4>Reaccionar</h4>
                                <p>+2 puntos</p>
                            </div>
                            <div class="points-info-card">
                                <div class="points-info-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h4>Post Popular</h4>
                                <p>+15 puntos extra</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de clasificaci√≥n global a ancho completo -->
                <div class="leaderboard-full-width">
                    <div class="leaderboard-container">
                        <div class="leaderboard-header">
                            <div class="leaderboard-header-top">
                                <h3>Clasificaci√≥n Global</h3>
                                <div class="leaderboard-stats">
                                    <span id="totalParticipants">0 participantes</span>
                                </div>
                            </div>
                            <!-- Filtros de liga -->
                            <div class="leagues-filters">
                                <button class="league-filter active" data-league="all">Todas las Ligas</button>
                                <button class="league-filter" data-league="gold">Oro</button>
                                <button class="league-filter" data-league="platinum">Platino</button>
                                <button class="league-filter" data-league="diamond">Diamante</button>
                            </div>
                        </div>
                        <div class="leaderboard-table" id="leaderboardTable">
                            <!-- La tabla se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-about" class="guidelines-section" style="display:none">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title" id="aboutTitle">Acerca de esta comunidad</h2>
                    <p class="section-subtitle">Descripci√≥n general y recursos.</p>
                </div>
                <div class="guidelines-grid">
                    <!-- Card "Comienza aqu√≠" - CLICKEABLE -->
                    <div class="guideline-card clickable" data-action="show-intro-video">
                        <div class="guideline-icon"><i class="fas fa-play"></i></div>
                        <h3 class="guideline-title">Comienza aqu√≠</h3>
                        <p class="guideline-description">Mira el video de introducci√≥n y conoce las reglas b√°sicas.</p>
                        <div class="card-click-hint">
                            <i class="fas fa-hand-pointer"></i> Click para ver
                        </div>
                    </div>

                    <!-- Card "Recursos" - NO CLICKEABLE (por ahora) -->
                    <div class="guideline-card">
                        <div class="guideline-icon"><i class="fas fa-bolt"></i></div>
                        <h3 class="guideline-title">Recursos</h3>
                        <p class="guideline-description">Plantillas, gu√≠as y descuentos para acelerar tu aprendizaje.</p>
                    </div>

                    <!-- Card "Mejora" - CLICKEABLE -->
                    <div class="guideline-card clickable" data-action="redirect-leagues">
                        <div class="guideline-icon"><i class="fas fa-arrow-trend-up"></i></div>
                        <h3 class="guideline-title">Mejora</h3>
                        <p class="guideline-description">Sube de nivel participando y compartiendo aportes de calidad.</p>
                        <div class="card-click-hint">
                            <i class="fas fa-hand-pointer"></i> Click para ir a Ligas
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <button class="chat-fab" id="openChat">
        <i class="fas fa-comments"></i>
        <span class="chat-fab-text">Chat</span>
        <span class="chat-notification" id="chatNotification" style="display: none;">0</span>
    </button>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-head">
            <div class="chat-head-info">
                <div class="chat-avatar">
                    <i class="fas fa-users"></i>
                </div>
                <div class="chat-info">
                    <strong class="chat-title">Chat en vivo</strong>
                    <span class="chat-status" id="chatStatus">Conectado</span>
                </div>
            </div>
            <div class="chat-head-actions">
                <button class="chat-action-btn" id="chatSettings" title="Configuraci√≥n">
                    <i class="fas fa-cog"></i>
                </button>
                 <button class="chat-action-btn" id="exportData" title="Exportar datos">
                     <i class="fas fa-download"></i>
                 </button>
                <button class="chat-action-btn" id="closeChat" title="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome" id="chatWelcome">
                <div class="welcome-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h3>¬°Bienvenido al chat!</h3>
                <p>Conecta con otros miembros de la comunidad</p>
            </div>
            <div class="chat-messages" id="chatMessages" style="display: none;"></div>
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">Alguien est√° escribiendo...</span>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-row">
                <button class="chat-attach-btn" id="chatAttachBtn" title="Adjuntar archivo">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="chat-emoji-btn" id="chatEmojiBtn" title="Emojis">
                    <i class="fas fa-smile"></i>
                </button>
                <div class="chat-input-wrapper">
                    <input id="chatInput" class="chat-input" type="text" placeholder="Escribe un mensaje..." maxlength="500">
                    <div class="chat-input-counter" id="chatInputCounter">0/500</div>
                </div>
                <button id="chatSend" class="chat-send" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="chat-attachments" id="chatAttachments"></div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-picker-header">
            <span>Emojis</span>
            <button class="emoji-picker-close" id="closeEmojiPicker">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="emoji-categories">
            <button class="emoji-category active" data-category="recent">üïí</button>
            <button class="emoji-category" data-category="smileys">üòä</button>
            <button class="emoji-category" data-category="animals">üê±</button>
            <button class="emoji-category" data-category="food">üçï</button>
            <button class="emoji-category" data-category="activities">‚öΩ</button>
            <button class="emoji-category" data-category="travel">‚úàÔ∏è</button>
            <button class="emoji-category" data-category="objects">üí°</button>
            <button class="emoji-category" data-category="symbols">‚ù§Ô∏è</button>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Emojis will be populated by JavaScript -->
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div class="chat-settings-modal" id="chatSettingsModal">
        <div class="chat-settings-card">
            <div class="chat-settings-header">
                <h3>Configuraci√≥n del Chat</h3>
                <button class="chat-settings-close" id="closeChatSettings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-settings-body">
                <div class="setting-group">
                    <label class="setting-label">
                        <input type="checkbox" id="chatNotifications" checked>
                        <span class="setting-text">Notificaciones de mensajes</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">
                        <input type="checkbox" id="chatSounds" checked>
                        <span class="setting-text">Sonidos de chat</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">
                        <input type="checkbox" id="chatTypingIndicator" checked>
                        <span class="setting-text">Indicador de escritura</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">
                        <input type="checkbox" id="chatAutoScroll" checked>
                        <span class="setting-text">Auto-scroll a nuevos mensajes</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de publicaci√≥n -->
    <div class="post-modal" id="postModal">
        <div class="post-modal-card">
            <div class="post-modal-head">
                <strong id="modalPostUser">Publicaci√≥n</strong>
                <button class="chat-send" id="closePostModal">Cerrar</button>
            </div>
            <div class="post-modal-body" id="modalPostBody"></div>
            <div class="post-modal-foot">
                <input id="modalCommentInput" class="comment-input" type="text" placeholder="Escribe un comentario...">
                <button id="modalSendComment" class="chat-send">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal de adjuntos -->
    <div class="attach-modal" id="attachModal">
        <div class="attach-modal-card">
            <div class="attach-modal-head">
                <strong>Agregar adjunto</strong>
                <button class="attach-modal-close" id="closeAttachModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="attach-modal-body">
                <div class="attach-options-grid">
                    <div class="attach-option" data-type="image">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21,15 16,10 5,21"></polyline>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Foto/Video</h3>
                            <p>Sube una imagen o video</p>
                        </div>
                        <input type="file" id="attachImage" accept="image/*,video/*" hidden>
                    </div>
                    <div class="attach-option" data-type="document">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10,9 9,9 8,9"></polyline>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Documento</h3>
                            <p>PDF, Word, PowerPoint, etc.</p>
                        </div>
                        <input type="file" id="attachDocument" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" hidden>
                    </div>
                    <div class="attach-option" data-type="link">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Enlace</h3>
                            <p>Comparte un enlace web</p>
                        </div>
                    </div>
                    <div class="attach-option" data-type="youtube">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>YouTube</h3>
                            <p>Vincular video de YouTube</p>
                        </div>
                    </div>
                    <div class="attach-option" data-type="poll">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Encuesta</h3>
                            <p>Crear una encuesta</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para enlace -->
    <div class="input-modal" id="linkModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Agregar enlace</strong>
                <button class="input-modal-close" id="closeLinkModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="linkInput">URL del enlace:</label>
                    <input type="url" id="linkInput" placeholder="https://ejemplo.com" class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelLink">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmLink">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para YouTube -->
    <div class="input-modal" id="youtubeModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Agregar video de YouTube</strong>
                <button class="input-modal-close" id="closeYoutubeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="youtubeInput">URL de YouTube:</label>
                    <input type="url" id="youtubeInput" placeholder="https://youtube.com/watch?v=..." class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelYoutube">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmYoutube">Agregar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para encuesta -->
    <div class="input-modal" id="pollModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Crear encuesta</strong>
                <button class="input-modal-close" id="closePollModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="pollQuestion">Pregunta:</label>
                    <input type="text" id="pollQuestion" placeholder="¬øCu√°l es tu opini√≥n?" class="input-field">
                </div>
                <div class="input-group">
                    <label for="pollOptions">Opciones (separadas por comas):</label>
                    <input type="text" id="pollOptions" placeholder="Opci√≥n 1, Opci√≥n 2, Opci√≥n 3" class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelPoll">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmPoll">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema de Notificaciones -->
    <div id="notificationContainer" class="notification-container"></div>

    <script>
        (function(){
            try{
                // Cargar foto de perfil del usuario
                function loadUserProfilePicture() {
                    const composerAvatarImg = document.getElementById('composerAvatarImg');
                    const composerAvatarIcon = document.getElementById('composerAvatarIcon');
                    
                    // Intentar obtener la foto de perfil del localStorage
                    const userProfile = localStorage.getItem('userProfile');
                    const avatarData = localStorage.getItem('avatarData');
                    
                    if (avatarData) {
                        try {
                            const avatar = JSON.parse(avatarData);
                            if (avatar && avatar.dataUrl) {
                                composerAvatarImg.src = avatar.dataUrl;
                                composerAvatarImg.style.display = 'block';
                                composerAvatarIcon.style.display = 'none';
                                return;
                            }
                        } catch (e) {
                            console.log('Error parsing avatar data:', e);
                        }
                    }
                    
                    // Si no hay foto, mostrar el icono por defecto
                    composerAvatarImg.style.display = 'none';
                    composerAvatarIcon.style.display = 'block';
                }
                
                // Cargar la foto de perfil al iniciar
                loadUserProfilePicture();
                
                const rawCommunity = localStorage.getItem('community.view.item');
                const rawPost = localStorage.getItem('community.view.post');
                const detail = rawCommunity ? JSON.parse(rawCommunity) : (rawPost ? JSON.parse(rawPost) : null);
                if(detail){
                    // Actualizar banner de la comunidad
                    const bannerTitle = document.getElementById('communityBannerTitle');
                    const bannerDesc = document.getElementById('communityBannerDesc');
                    const bannerMeta = document.getElementById('communityBannerMeta');
                    const bannerIcon = document.getElementById('communityBannerIcon');
                    const bannerImage = document.getElementById('communityBannerImage');
                    
                    if(bannerTitle) bannerTitle.textContent = detail.title || detail.user || 'Comunidad';
                    if(bannerDesc) bannerDesc.textContent = detail.desc || detail.content || '';
                    
                    const metaParts = [];
                    if(detail.members) metaParts.push(`${detail.members} Members`);
                    if(detail.price) metaParts.push(detail.price);
                    if(detail.category) metaParts.push(detail.category);
                    if(bannerMeta) bannerMeta.textContent = metaParts.join(' ‚Ä¢ ');
                    
                    if(detail.icon && bannerIcon) {
                        bannerIcon.innerHTML = `<i class="${detail.icon}"></i>`;
                    }
                    
                    // Cargar imagen del banner si existe
                    if(detail.thumb && bannerImage) {
                        bannerImage.style.backgroundImage = `url(${detail.thumb})`;
                        bannerImage.style.display = 'block';
                    } else if(bannerImage) {
                        bannerImage.style.display = 'none';
                    }
                    
                    // Actualizar t√≠tulo de la secci√≥n "Acerca de"
                    document.getElementById('aboutTitle').textContent = detail.title || 'Acerca de';
                }
            }catch(e){ console.error(e); }
            // Tabs
            document.querySelectorAll('.subnav-link').forEach(btn=>{
                btn.addEventListener('click', async ()=>{
                    document.querySelectorAll('.subnav-link').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    const tab = btn.getAttribute('data-tab');
                    document.querySelectorAll('main > section').forEach(s=>s.style.display='none');
                    document.getElementById('tab-'+tab).style.display='block';

                    // Si cambiamos a la pesta√±a de miembros, renderizar miembros
                    if (tab === 'members') {
                        console.log('üéØ [TAB] Cambiando a pesta√±a de miembros, renderizando...');

                        // Verificar si tenemos miembros cargados
                        if (window.members && window.members.length > 0) {
                            console.log('‚úÖ [TAB] Usando miembros de variable global:', window.members.length);
                            const activeFilter = document.querySelector('.members-chip.active')?.dataset.filter || 'all';
                            const searchQuery = document.getElementById('viewSearch')?.value || '';
                            window.renderMembers(activeFilter, searchQuery);
                        } else if (window.communitySystem && window.communitySystem.members && window.communitySystem.members.length > 0) {
                            console.log('‚úÖ [TAB] Usando miembros de CommunitySystem:', window.communitySystem.members.length);
                            window.members = [...window.communitySystem.members];
                            members = [...window.communitySystem.members]; // Sincronizar tambi√©n con variable global
                            const activeFilter = document.querySelector('.members-chip.active')?.dataset.filter || 'all';
                            const searchQuery = document.getElementById('viewSearch')?.value || '';
                            window.renderMembers(activeFilter, searchQuery);
                        } else {
                            console.log('‚ö†Ô∏è [TAB] No hay miembros cargados, intentando cargar desde CommunitySystem...');
                            if (window.communitySystem && typeof window.communitySystem.loadMembers === 'function') {
                                await window.communitySystem.loadMembers();
                            }
                        }
                    }
                    
                    // Si es la pesta√±a de ligas, actualizar el display de puntos
                    if (tab === 'leagues') {
                        console.log('üèÜ Cambiando a pesta√±a ligas...');
                        
                        // Forzar actualizaci√≥n del display de ligas
                        if (window.pointsSystem) {
                            await window.pointsSystem.getCurrentUser();
                            await window.pointsSystem.refreshPointsFromDatabase();
                            window.pointsSystem.updateLeagueDisplay();
                        }
                        
                        // Cargar y mostrar la clasificaci√≥n global
                        if (window.leagueFilterSystem) {
                            console.log('üèÜ Cargando clasificaci√≥n global...');
                            await window.leagueFilterSystem.loadAllUsers();
                            window.leagueFilterSystem.updateLeaderboard();
                        }


                    }
                });
            });

            // ===================================================================
            // SISTEMA DE CONTENIDO INTERACTIVO - ACERCA DE
            // Gestiona videos de introducci√≥n y redirecci√≥n a ligas
            // ===================================================================

            // Funci√≥n para obtener el slug de la comunidad actual
            function getCurrentCommunitySlug() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('slug') || 'profesionales';
            }

            // Funci√≥n para cargar video de introducci√≥n desde la base de datos
            async function loadCommunityIntroVideo() {
                const communitySlug = getCurrentCommunitySlug();

                try {
                    console.log('üìπ Cargando video de introducci√≥n para:', communitySlug);

                    // Intentar cargar desde Supabase
                    if (window.supabase) {
                        const { data: community, error: communityError } = await window.supabase
                            .from('communities')
                            .select('id')
                            .eq('slug', communitySlug)
                            .single();

                        if (communityError) throw communityError;

                        const { data: video, error: videoError } = await window.supabase
                            .from('community_videos')
                            .select('*')
                            .eq('community_id', community.id)
                            .eq('video_type', 'intro')
                            .eq('is_active', true)
                            .order('order_index', { ascending: true })
                            .limit(1)
                            .single();

                        if (videoError) throw videoError;

                        return video;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando video desde BD, usando fallback:', error);
                }

                // Fallback: Video demo de YouTube
                return {
                    title: 'Video de Introducci√≥n a la Comunidad',
                    description: 'Conoce c√≥mo funciona nuestra comunidad y c√≥mo puedes aprovechar al m√°ximo tu experiencia.',
                    video_url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                    video_provider: 'youtube',
                    thumbnail_url: 'https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg'
                };
            }

            // Funci√≥n para construir URL de embed seg√∫n el proveedor
            function buildEmbedUrl(videoUrl, provider) {
                if (provider === 'youtube') {
                    // Extraer video ID de diferentes formatos de URL de YouTube
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = videoUrl.match(regExp);
                    const videoId = (match && match[2].length === 11) ? match[2] : null;

                    if (videoId) {
                        return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
                    }
                } else if (provider === 'vimeo') {
                    const videoId = videoUrl.split('/').pop();
                    return `https://player.vimeo.com/video/${videoId}?autoplay=1`;
                }

                // Para videos directos, retornar la URL tal cual
                return videoUrl;
            }

            // Funci√≥n para mostrar el modal de video
            async function showVideoModal() {
                const modal = document.getElementById('introVideoModal');
                const playerWrapper = document.getElementById('videoPlayerWrapper');
                const titleElement = document.getElementById('videoModalTitle');
                const descriptionElement = document.getElementById('videoDescription');

                // Mostrar el modal con loading
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                try {
                    // Cargar datos del video
                    const videoData = await loadCommunityIntroVideo();

                    // Actualizar t√≠tulo y descripci√≥n
                    titleElement.textContent = videoData.title;
                    descriptionElement.textContent = videoData.description || '';

                    // Construir URL de embed
                    const embedUrl = buildEmbedUrl(videoData.video_url, videoData.video_provider);

                    // Crear iframe del video
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.setAttribute('frameborder', '0');
                    iframe.setAttribute('allowfullscreen', '');
                    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';

                    // Limpiar wrapper e insertar iframe
                    playerWrapper.innerHTML = '';
                    playerWrapper.appendChild(iframe);

                    console.log('‚úÖ Video modal mostrado correctamente');

                } catch (error) {
                    console.error('‚ùå Error mostrando video modal:', error);
                    playerWrapper.innerHTML = `
                        <div class="video-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error cargando el video. Por favor, intenta de nuevo m√°s tarde.</p>
                        </div>
                    `;
                }
            }

            // Funci√≥n para cerrar el modal de video
            function closeVideoModal() {
                const modal = document.getElementById('introVideoModal');
                const playerWrapper = document.getElementById('videoPlayerWrapper');

                // Ocultar modal
                modal.style.display = 'none';
                document.body.style.overflow = '';

                // Limpiar contenido del player para detener el video
                playerWrapper.innerHTML = `
                    <div class="video-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Cargando video...</p>
                    </div>
                `;

                console.log('‚ÑπÔ∏è Video modal cerrado');
            }

            // Funci√≥n para redireccionar a la pesta√±a de Ligas
            function redirectToLeaguesTab() {
                console.log('üèÜ Redireccionando a pesta√±a de Ligas...');

                // Remover clase active de todos los tabs
                document.querySelectorAll('.subnav-link').forEach(btn => btn.classList.remove('active'));

                // Activar tab de Ligas
                const leaguesTab = document.querySelector('[data-tab="leagues"]');
                if (leaguesTab) {
                    leaguesTab.classList.add('active');
                }

                // Ocultar todas las secciones
                document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');

                // Mostrar secci√≥n de Ligas
                const leaguesSection = document.getElementById('tab-leagues');
                if (leaguesSection) {
                    leaguesSection.style.display = 'block';

                    // Scroll suave a la parte superior
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    console.log('‚úÖ Redireccionado a Ligas exitosamente');
                } else {
                    console.error('‚ùå Secci√≥n de Ligas no encontrada');
                }
            }

            // Event Listeners para las guideline-cards
            document.addEventListener('DOMContentLoaded', () => {
                // Listener para cards clickeables
                document.querySelectorAll('.guideline-card.clickable').forEach(card => {
                    card.addEventListener('click', () => {
                        const action = card.getAttribute('data-action');

                        if (action === 'show-intro-video') {
                            showVideoModal();
                        } else if (action === 'redirect-leagues') {
                            redirectToLeaguesTab();
                        }
                    });

                    // Agregar efecto hover
                    card.style.cursor = 'pointer';
                });

                // Listener para cerrar modal de video
                const closeModalBtn = document.getElementById('closeVideoModal');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', closeVideoModal);
                }

                const modalOverlay = document.getElementById('videoModalOverlay');
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', closeVideoModal);
                }

                // Cerrar modal con tecla ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('introVideoModal');
                        if (modal && modal.style.display === 'flex') {
                            closeVideoModal();
                        }
                    }
                });
            });

            // FIN SISTEMA DE CONTENIDO INTERACTIVO
            // ===================================================================

                         // Feed mock con persistencia
             let posts = [];
             
            // Funci√≥n global para validar URLs de imagen
            function isValidImageUrl(url) {
                if (!url || typeof url !== 'string') return false;
                
                const cleanUrl = url.trim();
                if (cleanUrl === '' || cleanUrl === 'null' || cleanUrl === 'undefined') return false;
                
                // Verificar que no sea un archivo de audio (incluso con extensi√≥n incorrecta)
                const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
                const hasAudioExtension = audioExtensions.some(ext => cleanUrl.toLowerCase().includes(ext));
                if (hasAudioExtension) {
                    console.warn('‚ö†Ô∏è [AVATAR] URL contiene extensi√≥n de audio, rechazando:', cleanUrl);
                    return false;
                }
                
                // Verificar patrones sospechosos de archivos de audio renombrados
                const audioPatterns = [
                    /audio_[a-f0-9-]+\.(jpg|jpeg|png|gif)/i,  // audio_UUID.jpg
                    /uploads\/audio.*\.(jpg|jpeg|png|gif)/i,   // uploads/audio*.jpg
                    /_audio[_-].*\.(jpg|jpeg|png|gif)/i       // cualquier_audio_.jpg
                ];
                
                const isSuspiciousAudio = audioPatterns.some(pattern => pattern.test(cleanUrl));
                if (isSuspiciousAudio) {
                    console.warn('‚ö†Ô∏è [AVATAR] URL sospechosa de archivo de audio renombrado, rechazando:', cleanUrl);
                    return false;
                }
                
                // Verificar que sea una URL v√°lida (base64 o http/https)
                if (cleanUrl.startsWith('data:image/')) return true;
                if (cleanUrl.startsWith('http://') || cleanUrl.startsWith('https://')) return true;
                if (cleanUrl.startsWith('/') || cleanUrl.startsWith('../')) return true;
                
                return false;
            }

            // Funci√≥n para limpiar datos corruptos de avatares en la base de datos
            async function cleanCorruptedAvatars() {
                try {
                    if (!window.supabase) return;
                    
                    console.log('üßπ Iniciando limpieza de avatares corruptos...');
                    
                    // Buscar usuarios con URLs de avatar sospechosas
                    const { data: users, error } = await window.supabase
                        .from('users')
                        .select('id, profile_picture_url')
                        .not('profile_picture_url', 'is', null);
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è Error obteniendo usuarios para limpieza:', error);
                        return;
                    }
                    
                    let cleanedCount = 0;
                    for (const user of users) {
                        if (!isValidImageUrl(user.profile_picture_url)) {
                            console.log('üßπ Limpiando avatar corrupto para usuario:', user.id, 'URL:', user.profile_picture_url);
                            
                            // Limpiar el avatar corrupto
                            const { error: updateError } = await window.supabase
                                .from('users')
                                .update({ profile_picture_url: null })
                                .eq('id', user.id);
                            
                            if (!updateError) {
                                cleanedCount++;
                            } else {
                                console.warn('‚ö†Ô∏è Error limpiando avatar para usuario:', user.id, updateError);
                            }
                        }
                    }
                    
                    if (cleanedCount > 0) {
                        console.log(`‚úÖ Limpieza completada: ${cleanedCount} avatares corruptos eliminados`);
                    } else {
                        console.log('‚úÖ No se encontraron avatares corruptos para limpiar');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en limpieza de avatares:', error);
                }
            }

            // Funci√≥n para esperar que Supabase est√© disponible (GLOBAL)
            window.waitForSupabase = async function waitForSupabase(maxRetries = 10, delay = 1000) {
                for (let i = 0; i < maxRetries; i++) {
                    if (window.supabase && window.supabaseInitialized) {
                        console.log('‚úÖ Supabase est√° disponible');
                        return true;
                    }
                    console.log(`‚è≥ Esperando Supabase... intento ${i + 1}/${maxRetries}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                return false;
            }

            // Funci√≥n SIMPLIFICADA para cargar posts desde la API
            async function loadPostsFromDatabase() {
                console.log('üöÄ [SIMPLE] Cargando posts desde API...');
                try {
                    // Obtener community ID desde URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const communitySlug = urlParams.get('slug') || 'profesionales';

                    console.log('üè† Community slug:', communitySlug);

                    // Mapeo simple de slugs conocidos (CORREGIDO profesionales ID)
                    const communityMap = {
                        'profesionales': '7886aa14-35b9-41da-b099-29f11ad3516b',
                        'sif-icap': 'aa5a4c4c-ce64-4a12-b1ef-365aa0d320c8',
                        'openminder': 'b3b154e1-110e-4aa7-8998-ef208482a159',
                        'ecos-de-liderazgo': 'd2dbebb1-5b57-4da7-9fc6-8b40c732b548'
                    };

                    const communityId = communityMap[communitySlug];
                    if (!communityId) {
                        console.warn('‚ö†Ô∏è Community ID no encontrado para slug:', communitySlug);
                        return;
                    }

                    console.log('üìä Cargando posts de communityId:', communityId);

                    // ESPERAR A QUE SUPABASE EST√â DISPONIBLE
                    console.log('‚è≥ Verificando disponibilidad de Supabase...');
                    const supabaseReady = await window.waitForSupabase();

                    if (!supabaseReady) {
                        throw new Error('Supabase no se pudo inicializar despu√©s de m√∫ltiples intentos');
                    }

                    console.log('üì° Haciendo consulta directa a Supabase...');

                    const { data: dbPosts, error } = await window.supabase
                        .from('community_posts')
                        .select(`
                            *,
                            users:user_id (
                                id,
                                display_name,
                                username,
                                profile_picture_url
                            )
                        `)
                        .eq('community_id', communityId)
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (error) {
                        throw new Error(`Supabase error: ${error.message}`);
                    }

                    console.log('üìä Posts obtenidos de Supabase:', dbPosts);
                    console.log('üìä Cantidad de posts encontrados:', dbPosts ? dbPosts.length : 0);

                    // Log para verificar que est√° funcionando correctamente
                    console.log(`‚úÖ Posts cargados para ${communitySlug}: ${dbPosts ? dbPosts.length : 0} encontrados`);

                    if (!dbPosts || dbPosts.length === 0) {
                        console.log('‚ö†Ô∏è No se encontraron posts para esta comunidad');
                        posts = [];
                        // Re-renderizar con array vac√≠o para mostrar estado vac√≠o
                        renderPosts('all');
                        updateStats();
                        return;
                    }

                    // Convertir posts al formato esperado por la UI
                    posts = await Promise.all(dbPosts.map(async post => {
                        // Calcular tiempo transcurrido
                        const createdDate = new Date(post.created_at);
                        const now = new Date();
                        const diffMs = now - createdDate;
                        const diffMinutes = Math.floor(diffMs / (1000 * 60));
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                        let timeAgo;
                        if (diffMinutes < 1) {
                            timeAgo = 'Ahora mismo';
                        } else if (diffMinutes < 60) {
                            timeAgo = `Hace ${diffMinutes} minuto${diffMinutes > 1 ? 's' : ''}`;
                        } else if (diffHours < 24) {
                            timeAgo = `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
                        } else if (diffDays < 30) {
                            timeAgo = `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
                        } else {
                            timeAgo = createdDate.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        }

                        // Cargar reacciones desde la base de datos
                        console.log('üëç Cargando reacciones para post:', post.id);
                        let reactions = {like:0, love:0, wow:0, laugh:0, sad:0, angry:0};
                        let userReacted = null;

                        try {
                            const { data: reactionsData, error: reactionsError } = await window.supabase
                                .from('community_reactions')
                                .select('reaction_type, user_id')
                                .eq('post_id', post.id);

                            console.log('üîç [REACTIONS DEBUG] Post ID:', post.id);
                            console.log('  - Reactions query result:', reactionsData);
                            console.log('  - Reactions query error:', reactionsError);

                            if (!reactionsError && reactionsData) {
                                // Contar reacciones por tipo
                                reactionsData.forEach(reaction => {
                                    if (reactions.hasOwnProperty(reaction.reaction_type)) {
                                        reactions[reaction.reaction_type]++;
                                    }
                                });

                                // Verificar si el usuario actual ya reaccion√≥
                                const userResult = await getCurrentUserForCommunity();
                                if (userResult.id) {
                                    const userReaction = reactionsData.find(r => r.user_id === userResult.id);
                                    if (userReaction) {
                                        userReacted = userReaction.reaction_type;
                                    }
                                }

                                console.log('‚úÖ Reacciones cargadas para post', post.id, ':', reactions);
                                console.log('  - Datos de reacciones:', reactionsData);
                                console.log('  - Total de likes:', reactions.like);
                                console.log('  - User reacted:', userReacted);
                            } else {
                                console.log('‚ö†Ô∏è No se encontraron reacciones para post', post.id, 'Error:', reactionsError);
                                console.log('  - Error details:', reactionsError?.message);
                                console.log('  - Error code:', reactionsError?.code);
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error cargando reacciones para post', post.id, ':', error);
                            console.log('  - Error details:', error.message);
                            console.log('  - Error stack:', error.stack);
                        }

                        // Cargar comentarios desde la base de datos
                        console.log('üí¨ Cargando comentarios para post:', post.id);
                        let comments = [];
                        try {
                            const { data: commentsData, error: commentsError } = await window.supabase
                                .from('community_comments')
                                .select('*')
                                .eq('post_id', post.id)
                                .order('created_at', { ascending: true });

                            if (!commentsError && commentsData) {
                                // Cargar datos de usuarios para los comentarios
                                const userIds = [...new Set(commentsData.map(c => c.user_id))];
                                const { data: usersData, error: usersError } = await window.supabase
                                    .from('users')
                                    .select('id, display_name, username, profile_picture_url')
                                    .in('id', userIds);

                                const usersMap = {};
                                if (!usersError && usersData) {
                                    usersData.forEach(user => {
                                        usersMap[user.id] = user;
                                    });
                                }

                                comments = commentsData.map(comment => {
                                    const userData = usersMap[comment.user_id];
                                    return {
                                        id: comment.id,
                                        user: userData?.display_name || userData?.username || 'Usuario',
                                        content: comment.content,
                                        created_at: comment.created_at,
                                        avatarUrl: userData?.profile_picture_url || null
                                    };
                                });
                                
                                console.log('‚úÖ Comentarios cargados para post', post.id, ':', comments.length, 'comentarios');
                                console.log('  - Datos de comentarios:', commentsData);
                                console.log('  - Comentarios mapeados:', comments);
                            } else {
                                console.log('‚ö†Ô∏è No se encontraron comentarios para post', post.id, 'Error:', commentsError);
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error cargando comentarios para post', post.id, ':', error);
                        }

                        // Construir attachments si existen
                        let attachments = [];

                        console.log('üîç [ATTACHMENT DEBUG] Post ID:', post.id);
                        console.log('  - attachment_type:', post.attachment_type);
                        console.log('  - attachment_url:', post.attachment_url);
                        console.log('  - attachment_data:', post.attachment_data);

                        if (post.attachment_type) {
                            // CASO ESPECIAL: Encuestas (usan attachment_data en lugar de attachment_url)
                            if (post.attachment_type === 'poll' && post.attachment_data) {
                                console.log('üìä [POLL DEBUG] Procesando encuesta para post', post.id);
                                const pollData = post.attachment_data;
                                console.log('  - pollData completo:', JSON.stringify(pollData, null, 2));
                                console.log('  - question:', pollData.question);
                                console.log('  - options:', pollData.options);
                                console.log('  - votes:', pollData.votes);

                                const attachment = {
                                    type: 'poll',
                                    question: pollData.question,
                                    options: pollData.options || [],
                                    votes: pollData.votes || {},
                                    postId: post.id // Necesario para el sistema de votaci√≥n
                                };
                                attachments.push(attachment);
                                console.log('‚úÖ [POLL DEBUG] Encuesta agregada a attachments:', attachment);
                            } else if (post.attachment_type === 'poll' && !post.attachment_data) {
                                console.warn('‚ö†Ô∏è [POLL DEBUG] Post tiene tipo poll pero no tiene attachment_data');
                            }
                            // CASO NORMAL: Adjuntos con URL
                            else if (post.attachment_url) {
                                // Extraer nombre de archivo de la URL para attachments que lo necesiten
                                const fileName = post.attachment_url.split('/').pop() || 'archivo';

                                // Detectar si es un video de YouTube por la URL de embed
                                const isYouTubeEmbed = post.attachment_type === 'video' &&
                                                     post.attachment_url.includes('youtube.com/embed');

                                const attachment = {
                                    type: post.attachment_type,
                                    src: post.attachment_url,
                                    url: post.attachment_url,
                                    name: fileName
                                };

                                // Si es YouTube, agregar propiedades especiales
                                if (isYouTubeEmbed) {
                                    attachment.isYoutube = true;
                                    attachment.embed = post.attachment_url;
                                }

                                attachments.push(attachment);
                            }
                        }


                        const postObject = {
                            id: post.id,
                            user: post.users ? (post.users.display_name || post.users.username || 'Usuario') : 'Usuario',
                            avatar: 'fas fa-user',
                            avatarUrl: post.users?.profile_picture_url || null,
                            category: 'general',
                            minutesAgo: diffMinutes,
                            timeAgo: timeAgo,
                            timestamp: createdDate.getTime(),
                            content: post.content || post.title || '',
                            title: post.title || null,
                            comments: comments,
                            reactions: reactions,
                            attachments: attachments,
                            reacted: userReacted,
                            // Datos adicionales
                            user_id: post.user_id,
                            community_id: post.community_id,
                            created_at: post.created_at
                        };

                        console.log('üì¶ [POST OBJECT] Post construido:', {
                            id: postObject.id,
                            hasAttachments: attachments.length > 0,
                            attachmentsCount: attachments.length,
                            attachmentTypes: attachments.map(a => a.type),
                            attachments: attachments
                        });

                        // Calcular total de reacciones
                        const totalReactions = Object.values(postObject.reactions).reduce((sum, count) => sum + count, 0);
                        postObject.totalReactions = totalReactions;

                        // Log de debug para verificar datos
                        console.log('üîç [POST OBJECT DEBUG] Post ID:', post.id);
                        console.log('  - User:', postObject.user);
                        console.log('  - Reactions:', postObject.reactions);
                        console.log('  - Total reactions:', totalReactions);
                        console.log('  - Comments array:', postObject.comments);
                        console.log('  - Comments length:', postObject.comments?.length || 0);
                        console.log('  - Like count:', postObject.reactions?.like || 0);

                        return postObject;
                    }));

                    console.log('‚úÖ Posts convertidos para UI:', posts);

                    // Re-renderizar posts
                    renderPosts('all');

                    // Actualizar estad√≠sticas
                    updateStats();

                    // Forzar actualizaci√≥n de contadores despu√©s de cargar
                    console.log('üîÑ [INITIAL LOAD] Forzando actualizaci√≥n de contadores...');
                    setTimeout(() => {
                        updateCounters();
                        console.log('‚úÖ [INITIAL LOAD] Contadores actualizados despu√©s de carga inicial');
                    }, 500);

                } catch (error) {
                    console.error('‚ùå Error cargando posts desde API:', error);
                    console.error('Error details:', error.message);
                    // Fallback a localStorage
                    loadPosts();
                }
            }
             
             // Limpiar posts muy antiguos (m√°s de 30 d√≠as)
             function cleanupOldPosts() {
                 const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                 posts = posts.filter(post => {
                     if (post.timestamp) {
                         return post.timestamp > thirtyDaysAgo;
                     }
                     return true; // Mantener posts sin timestamp (posts iniciales)
                 });
             }
             
             // Funci√≥n para limpiar datos falsos y mantener solo posts reales
             function cleanupFakeData() {
                 // Identificar posts que fueron creados por el usuario (tienen timestamp real)
                 const realPosts = posts.filter(post => {
                     // Posts con timestamp son reales
                     if (post.timestamp) return true;
                     
                     // Posts iniciales de ejemplo (los mantenemos por ahora)
                     const initialPostIds = [Date.now() - 3600000, Date.now() - 1800000];
                     return initialPostIds.includes(post.id);
                 });
                 
                 if (realPosts.length !== posts.length) {
                     posts = realPosts;
                     savePosts();
                     console.log('Datos falsos limpiados, manteniendo solo posts reales');
                 }
             }
             
             // Cargar posts guardados
             function loadPosts() {
                 const savedPosts = localStorage.getItem('communityPosts');
                 if (savedPosts) {
                     try {
                         posts = JSON.parse(savedPosts);
                         console.log('Posts cargados desde localStorage:', posts);
                     } catch (e) {
                         console.error('Error cargando posts:', e);
                         posts = [];
                     }
                } else {
                    // Los posts ahora se cargan solo desde la base de datos
                    // No hay datos hardcodeados
                    posts = [];
                }
             }
             
             // Guardar posts
             function savePosts() {
                 try {
                     localStorage.setItem('communityPosts', JSON.stringify(posts));
                     console.log('Posts guardados en localStorage');
                 } catch (e) {
                     console.error('Error guardando posts:', e);
                 }
             }
             
             // Actualizar timestamps de posts
             function updatePostTimestamps() {
                 const now = Date.now();
                 posts.forEach(post => {
                     if (post.timestamp) {
                         // Usar la nueva funci√≥n formatTimestamp para calcular el tiempo correctamente
                         const diffSeconds = Math.floor((now - post.timestamp) / 1000);
                         
                         if (diffSeconds < 60) {
                             post.timeAgo = 'Ahora mismo';
                         } else if (diffSeconds < 3600) {
                             const minutes = Math.floor(diffSeconds / 60);
                             post.timeAgo = `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                         } else if (diffSeconds < 86400) {
                             const hours = Math.floor(diffSeconds / 3600);
                             post.timeAgo = `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
                         } else if (diffSeconds < 2592000) {
                             const days = Math.floor(diffSeconds / 86400);
                             post.timeAgo = `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
                         } else {
                             const date = new Date(post.timestamp);
                             post.timeAgo = date.toLocaleDateString('es-ES', {
                                 year: 'numeric',
                                 month: 'short',
                                 day: 'numeric'
                             });
                         }
                         
                         // Mantener minutesAgo para compatibilidad
                         post.minutesAgo = Math.floor(diffSeconds / 60);
                     }
                 });
             }
             
             // Cargar posts al iniciar (NUEVO: priorizar base de datos)
             async function initializePosts() {
                 console.log('üöÄ Inicializando carga de posts...');

                 try {
                     // 1. Intentar cargar desde base de datos primero
                     await loadPostsFromDatabase();
                     console.log('‚úÖ Posts cargados desde base de datos');
                 } catch (error) {
                     console.warn('‚ö†Ô∏è Error cargando desde BD, usando localStorage como fallback:', error);
                     // 2. Fallback a localStorage si falla la BD
                     loadPosts();
                 }

                 // 3. Limpiar posts antiguos
                 cleanupOldPosts();

                 // 4. Limpiar datos falsos
                 cleanupFakeData();

                 // 5. Actualizar timestamps al cargar
                 updatePostTimestamps();

                 // 6. Actualizar estad√≠sticas iniciales
                 updateStats();

                 console.log('‚úÖ Inicializaci√≥n de posts completada');
             }

            // Llamar funci√≥n de inicializaci√≥n
            initializePosts();
            
            // Hacer la funci√≥n disponible globalmente para uso manual
            window.cleanCorruptedAvatars = cleanCorruptedAvatars;
            
            // Limpiar avatares corruptos despu√©s de un breve delay
            setTimeout(async () => {
                if (window.supabase) {
                    await cleanCorruptedAvatars();
                }
            }, 3000); // 3 segundos despu√©s de cargar
             
             // Funci√≥n para actualizar estad√≠sticas
             function updateStats() {
                 const totalPosts = posts.length;
                 const totalComments = posts.reduce((sum, post) => sum + (post.comments?.length || 0), 0);
                 const totalReactions = posts.reduce((sum, post) => {
                     if (post.reactions) {
                         return sum + Object.values(post.reactions).reduce((a, b) => a + (b || 0), 0);
                     }
                     return sum;
                 }, 0);
                 
                 document.getElementById('totalPosts').textContent = totalPosts;
                 document.getElementById('totalComments').textContent = totalComments;
                 document.getElementById('totalReactions').textContent = totalReactions;
             }
             
             // Actualizar timestamps cada minuto
             setInterval(() => {
                 updatePostTimestamps();
                 updateStats();
                 // Re-renderizar solo si hay posts visibles
                 if (document.getElementById('postsList').children.length > 0) {
                    renderPosts('all');
                 }
             }, 60000); // Cada minuto
             
             // Actualizar estad√≠sticas iniciales
             updateStats();
            let pendingAttachments = [];
            const composerInput = document.getElementById('composerInput');
            const publishPostBtn = document.getElementById('publishPostBtn');
            function renderPosts(category='all'){
                console.log('Renderizando posts para categor√≠a:', category);
                console.log('Posts disponibles:', posts);
                const list = document.getElementById('postsList');
                const filtered = category==='all' ? posts : posts.filter(p=>p.category===category);
                console.log('Posts filtrados:', filtered);
                list.innerHTML = filtered.map(p=>{
                    console.log('üîç [COUNTER DEBUG] Post:', p.user);
                    console.log('  - Reactions object:', p.reactions);
                    console.log('  - Like count:', p.reactions?.like || 0);
                    console.log('  - Comments array:', p.comments);
                    console.log('  - Comments length:', p.comments?.length || 0);
                    console.log('  - Comments count in template:', p.comments ? p.comments.length : 0);
                    return `
                    <div class="post" data-open-post="${p.id}">
                        <div class="post-header">
                            <div class="post-user">
                                <div class="user-avatar">
                            ${p.avatarUrl ?
                                        `<img src="${p.avatarUrl}" alt="${p.user}" class="user-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <i class="${p.avatar}" style="display:none;"></i>` :
                                `<i class="${p.avatar}"></i>`
                            }
                        </div>
                                <div class="user-info">
                                    <div class="user-name">${p.user}</div>
                                    <div class="post-time">${p.timeAgo || `${p.minutesAgo} min`} ‚Ä¢ ${p.category}</div>
                            </div>
                            </div>
                            <div class="post-actions">
                                <button class="action-btn" onclick="showPostMenu('${p.id}')">
                                    <i class="fas fa-ellipsis-h"></i>
                                    </button>
                            </div>
                        </div>
                        <div class="post-content">
                            <p>${p.content}</p>
                            ${renderAttachmentsCentered(p.attachments)}
                        </div>
                        <div class="post-footer">
                            <div class="post-interactions">
                                <div class="reaction-container" data-post-id="${p.id}">
                                    <button class="interaction-btn like-btn ${p.reacted ? 'reacted' : ''}" data-react="like" data-id="${p.id}">
                                        <i class="fas fa-heart"></i>
                                        <span class="btn-text">${p.reacted ? (p.reacted === 'like' ? 'Me gusta' : p.reacted === 'love' ? 'Me encanta' : p.reacted === 'wow' ? 'Me asombra' : p.reacted === 'laugh' ? 'Me divierte' : p.reacted === 'sad' ? 'Me entristece' : p.reacted === 'angry' ? 'Me enoja' : 'Me gusta') : 'Me gusta'}</span>
                                        <span class="reaction-count">${p.totalReactions || 0}</span>
                                    </button>
                                    <div class="reaction-picker-hover" id="picker-hover-${p.id}">
                                        <div class="reaction-item" data-react="like" data-id="${p.id}">üëç</div>
                                        <div class="reaction-item" data-react="love" data-id="${p.id}">‚ù§Ô∏è</div>
                                        <div class="reaction-item" data-react="wow" data-id="${p.id}">üòÆ</div>
                                        <div class="reaction-item" data-react="laugh" data-id="${p.id}">üòÇ</div>
                                        <div class="reaction-item" data-react="sad" data-id="${p.id}">üò¢</div>
                                        <div class="reaction-item" data-react="angry" data-id="${p.id}">üò†</div>
                                    </div>
                            </div>
                                <button class="interaction-btn comment-btn" data-action="comment" data-id="${p.id}">
                                    <i class="fas fa-comment"></i>
                                    <span class="btn-text">Comentar</span>
                                    <span class="comment-count">${p.comments ? p.comments.length : 0}</span>
                                </button>
                                <button class="interaction-btn share-btn" data-share="${p.id}">
                                    <i class="fas fa-share"></i>
                                    <span class="btn-text">Compartir</span>
                                </button>
                        </div>
                    </div>
                        <div class="reaction-picker" id="picker-${p.id}" style="display: none;">
                            <div class="reaction-item" data-react="like" data-id="${p.id}">üëç</div>
                            <div class="reaction-item" data-react="love" data-id="${p.id}">‚ù§Ô∏è</div>
                            <div class="reaction-item" data-react="wow" data-id="${p.id}">üòÆ</div>
                            <div class="reaction-item" data-react="laugh" data-id="${p.id}">üòÇ</div>
                            <div class="reaction-item" data-react="sad" data-id="${p.id}">üò¢</div>
                            <div class="reaction-item" data-react="angry" data-id="${p.id}">üò†</div>
                        </div>
                    </div>
                `;
                }).join('');
                // abrir modal de post
                list.querySelectorAll('[data-open-post]').forEach(card=>{
                    card.addEventListener('click', (e)=>{
                        // evitar disparar desde botones internos
                        const target = e.target;
                        // No abrir modal si se hace click en:
                        // - Botones de interacci√≥n (like, comentar, compartir)
                        // - Botones de acciones (men√∫ de opciones)
                        // - Encuestas (opciones de votaci√≥n)
                        if(target.closest('.post-interactions') ||
                           target.closest('.post-actions') ||
                           target.closest('.post-poll-container') ||
                           target.closest('.poll-option-interactive')) {
                            return;
                        }
                        const id = card.getAttribute('data-open-post');
                        openPostModal(id);
                    });
                });
                // abrir/cerrar picker de reacciones
                list.querySelectorAll('[data-react-toggle]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        const id = btn.getAttribute('data-react-toggle');
                        const picker = document.getElementById('picker-'+id);
                        // Comparar como string ya que los IDs de BD son UUIDs
                        const post = posts.find(p=>p.id==id || p.id===Number(id));

                        console.log('üîç [REACTION] Buscando post con ID:', id, 'Posts disponibles:', posts.length);

                        if (!post) {
                            console.error('‚ùå [REACTION] Post no encontrado para ID:', id);
                            if (typeof notifications !== 'undefined') {
                                notifications.error('Error: No se encontr√≥ la publicaci√≥n');
                            }
                            return;
                        }

                        if (!picker) {
                            console.error('‚ùå [REACTION] Picker no encontrado para ID:', id);
                            return;
                        }

                        // Si ya reaccion√≥, mostrar informaci√≥n en lugar de deshabilitar completamente
                        if(post.reacted){
                            // Mostrar notificaci√≥n en lugar de deshabilitar
                            if (typeof notifications !== 'undefined') {
                                notifications.info(`Ya reaccionaste con ${post.reacted === 'like' ? 'üëç' : post.reacted === 'love' ? '‚ù§Ô∏è' : post.reacted === 'wow' ? 'üòÆ' : post.reacted === 'laugh' ? 'üòÇ' : post.reacted === 'sad' ? 'üò¢' : 'üò†'} a esta publicaci√≥n`);
                            }
                            return;
                        }

                        document.querySelectorAll('.reaction-picker').forEach(p=>{ if(p!==picker) p.classList.remove('show'); });
                        picker.classList.toggle('show');
                    });
                });
                // bot√≥n de me gusta directo
                list.querySelectorAll('[data-react="like"]').forEach(btn=>{
                    btn.addEventListener('click', async ()=>{
                        const id = btn.getAttribute('data-id');
                        const post = posts.find(p=>p.id==id || p.id===Number(id));
                        
                        if (!post) {
                            console.error('‚ùå [LIKE] Post no encontrado para ID:', id);
                                return;
                            }

                        // Si ya reaccion√≥ con like, quitar la reacci√≥n
                        if(post.reacted === 'like'){
                            await removeReaction(id, 'like');
                        } else {
                            // Aplicar reacci√≥n like
                            await applyReaction(id, 'like');
                        }
                    });
                });

                // reacciones del picker hover
                list.querySelectorAll('.reaction-picker-hover .reaction-item').forEach(el=>{
                    el.addEventListener('click', async ()=>{
                        const id = el.getAttribute('data-id');
                        const type = el.getAttribute('data-react');
                        const post = posts.find(p=>p.id==id || p.id===Number(id));
                        
                        if (!post) {
                            console.error('‚ùå [REACTION] Post no encontrado para ID:', id);
                                return;
                            }

                        // Si ya reaccion√≥ con el mismo tipo, quitar la reacci√≥n
                        if(post.reacted === type){
                            await removeReaction(id, type);
                            } else {
                            // Aplicar nueva reacci√≥n
                            await applyReaction(id, type);
                        }
                    });
                });
                
                // NOTA: Los event listeners de reacciones ya est√°n manejados por el hover picker arriba
                // No necesitamos duplicar los event listeners aqu√≠
                // bot√≥n de comentarios
                list.querySelectorAll('[data-action="comment"]').forEach(el=>{
                    el.addEventListener('click', async ()=>{
                        const id = el.getAttribute('data-id');
                        console.log('üí¨ [COMMENT] Abriendo modal para post ID:', id);
                        openPostModal(id);
                    });
                });
                // Votaci√≥n en encuestas
                list.querySelectorAll('.poll-option-interactive').forEach(optionEl => {
                    optionEl.addEventListener('click', async (e) => {
                        // Prevenir que se abra el modal de post al votar
                        e.stopPropagation();
                        e.preventDefault();

                        const postId = optionEl.getAttribute('data-poll-id');
                        const option = optionEl.getAttribute('data-option');

                        console.log('üó≥Ô∏è Votando en encuesta:', { postId, option });

                        await voteInPoll(postId, option);
                    });
                });

                // compartir
                list.querySelectorAll('[data-share]').forEach(el=>{
                    el.addEventListener('click', async ()=>{
                        const id = el.getAttribute('data-share');
                        const post = posts.find(p=>p.id==id || p.id===Number(id));
                         
                         // Crear men√∫ de compartir
                         const shareMenu = document.createElement('div');
                         shareMenu.className = 'share-menu';
                         shareMenu.innerHTML = `
                             <div class="share-menu-content">
                                 <h4>Compartir publicaci√≥n</h4>
                                 <div class="share-options">
                                     <button class="share-option" data-action="copy">
                                         <i class="fas fa-copy"></i>
                                         <span>Copiar texto</span>
                                     </button>
                                     <button class="share-option" data-action="twitter">
                                         <i class="fab fa-twitter"></i>
                                         <span>Twitter</span>
                                     </button>
                                     <button class="share-option" data-action="facebook">
                                         <i class="fab fa-facebook"></i>
                                         <span>Facebook</span>
                                     </button>
                                     <button class="share-option" data-action="linkedin">
                                         <i class="fab fa-linkedin"></i>
                                         <span>LinkedIn</span>
                                     </button>
                                     <button class="share-option" data-action="whatsapp">
                                         <i class="fab fa-whatsapp"></i>
                                         <span>WhatsApp</span>
                                     </button>
                                 </div>
                                 <button class="share-close">Cancelar</button>
                             </div>
                         `;
                         
                         document.body.appendChild(shareMenu);
                         
                         // Eventos del men√∫ de compartir
                         shareMenu.querySelectorAll('.share-option').forEach(btn => {
                             btn.addEventListener('click', async () => {
                                 const action = btn.dataset.action;
                                 const text = post.content;
                                 const url = window.location.href;
                                 
                                 switch(action) {
                                     case 'copy':
                                         try {
                                             await navigator.clipboard.writeText(text);
                                             notifications.success('Contenido copiado al portapapeles');
                                         } catch(e) {
                                             notifications.error('No se pudo copiar al portapapeles');
                                         }
                                         break;
                                     case 'twitter':
                                         window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
                                         break;
                                     case 'facebook':
                                         window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`, '_blank');
                                         break;
                                     case 'linkedin':
                                         window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank');
                                         break;
                                     case 'whatsapp':
                                         window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
                                         break;
                                 }
                                 
                                 shareMenu.remove();
                             });
                         });
                         
                         shareMenu.querySelector('.share-close').addEventListener('click', () => {
                             shareMenu.remove();
                         });
                         
                         // Cerrar al hacer clic fuera
                         shareMenu.addEventListener('click', (e) => {
                             if (e.target === shareMenu) {
                                 shareMenu.remove();
                             }
                         });
                    });
                });
            }
            // Adjuntos
            function bytesToMB(bytes){ return bytes / (1024*1024); }
            function addPreviewImage(src){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'preview-item';
                wrap.innerHTML = `<img src="${src}" class="preview-thumb"><button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.src!==src); };
                preview.appendChild(wrap);
            }
            function addPreviewPdf(name){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'pdf-chip';
                wrap.innerHTML = `<i class="fas fa-file-pdf"></i> ${name} <button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.name!==name); };
                preview.appendChild(wrap);
            }

            function addPreviewDocument(name){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'document-chip';
                const icon = getDocumentIcon(name);
                wrap.innerHTML = `<i class="${icon}"></i> ${name} <button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.name!==name); };
                preview.appendChild(wrap);
            }
            
            function getDocumentIcon(filename) {
                if (!filename || typeof filename !== 'string') {
                    return 'fas fa-file';
                }

                const parts = filename.split('.');
                if (parts.length < 2) {
                    return 'fas fa-file';
                }

                const ext = parts.pop().toLowerCase();
                switch(ext) {
                    case 'pdf': return 'fas fa-file-pdf';
                    case 'doc':
                    case 'docx': return 'fas fa-file-word';
                    case 'xls':
                    case 'xlsx': return 'fas fa-file-excel';
                    case 'ppt':
                    case 'pptx': return 'fas fa-file-powerpoint';
                    case 'txt': return 'fas fa-file-alt';
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                    case 'webp': return 'fas fa-file-image';
                    case 'mp4':
                    case 'webm':
                    case 'avi':
                    case 'mov': return 'fas fa-file-video';
                    default: return 'fas fa-file';
                }
            }
            
            function addPreviewLink(url){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'link-chip';
                const domain = new URL(url).hostname.replace('www.', '');
                wrap.innerHTML = `<i class="fas fa-link"></i> ${domain} <button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.url!==url); };
                preview.appendChild(wrap);
            }
            
            function addPreviewVideo(src){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'preview-item';
                wrap.innerHTML = `<video src="${src}" class="preview-thumb" controls muted></video><button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.src!==src); };
                preview.appendChild(wrap);
            }

            function addPreviewYoutube(embed){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'youtube-chip';
                wrap.innerHTML = `<i class="fab fa-youtube"></i> Video de YouTube <button class="preview-remove">‚úï</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.embed!==embed); };
                preview.appendChild(wrap);
            }
            
            
            function addPreviewPoll(question, options){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'poll-chip';
                wrap.innerHTML = `
                    <div class="poll-preview">
                        <i class="fas fa-poll"></i>
                        <div class="poll-content">
                            <div class="poll-question">${question}</div>
                            <div class="poll-options">${options.map(opt => `<div class="poll-option">${opt}</div>`).join('')}</div>
                        </div>
                        <button class="preview-remove">‚úï</button>
                    </div>
                `;
                wrap.querySelector('.preview-remove').onclick = ()=>{ 
                    preview.removeChild(wrap); 
                    pendingAttachments = pendingAttachments.filter(a=>a.question!==question); 
                };
                preview.appendChild(wrap);
            }

            // Manejo del modal de adjuntos
            const attachMenuBtn = document.getElementById('attachMenuBtn');
            const attachModal = document.getElementById('attachModal');
            const closeAttachModal = document.getElementById('closeAttachModal');
            
            // Abrir modal
            attachMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                attachModal.classList.add('show');
            });
            
            // Cerrar modal
            closeAttachModal.addEventListener('click', () => {
                attachModal.classList.remove('show');
            });
            
            // Cerrar modal al hacer clic fuera
            attachModal.addEventListener('click', (e) => {
                if (e.target === attachModal) {
                    attachModal.classList.remove('show');
                }
            });
            
            // Manejo de opciones del modal
            document.querySelectorAll('.attach-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const type = option.getAttribute('data-type');
                    handleAttachmentType(type);
                    attachModal.classList.remove('show');
                });
            });
            
            function handleAttachmentType(type) {
                console.log('Manejando tipo de adjunto:', type);
                switch(type) {
                    case 'image':
                        console.log('Abriendo selector de imagen');
                        document.getElementById('attachImage').click();
                        break;
                    case 'document':
                        console.log('Abriendo selector de documento');
                        document.getElementById('attachDocument').click();
                        break;
                    case 'link':
                        console.log('Abriendo modal de enlace');
                        document.getElementById('linkModal').classList.add('show');
                        break;
                    case 'youtube':
                        console.log('Abriendo modal de YouTube');
                        document.getElementById('youtubeModal').classList.add('show');
                        break;
                    case 'poll':
                        console.log('Abriendo modal de encuesta');
                        document.getElementById('pollModal').classList.add('show');
                        break;
                }
            }
            document.getElementById('attachImage').addEventListener('change', async (e)=>{
                console.log('Archivo de imagen/video seleccionado:', e.target.files?.[0]);
                const file = e.target.files?.[0];
                if(!file) return;

                if(bytesToMB(file.size) > 10){
                    notifications.warning('Archivo supera 10MB');
                    return;
                }

                console.log('Procesando archivo:', file.name, 'Tama√±o:', bytesToMB(file.size), 'MB');

                try {
                    // Mostrar indicador de carga
                    notifications.info('Subiendo archivo...');

                    // Determinar el tipo de archivo
                    const isVideo = file.type.startsWith('video/');
                    const fileType = isVideo ? 'video' : 'image';
                    const folder = isVideo ? 'videos/' : 'images/';

                    // Subir archivo al bucket de Supabase Storage
                    const uploadResult = await uploadFileToStorage(file, folder);

                    console.log('Archivo subido exitosamente, agregando adjunto');

                    // Agregar a adjuntos pendientes con la URL del storage
                    pendingAttachments.push({
                        type: fileType,
                        src: uploadResult.url,
                        url: uploadResult.url,
                        path: uploadResult.path,
                        name: file.name
                    });

                    // Mostrar preview
                    if (isVideo) {
                        addPreviewVideo(uploadResult.url);
                    } else {
                        addPreviewImage(uploadResult.url);
                    }

                    notifications.success('Archivo subido correctamente');

                } catch (error) {
                    console.error('Error subiendo archivo:', error);
                    notifications.error('Error subiendo archivo. Int√©ntalo de nuevo.');
                }

                e.target.value='';
            });
            // Remover esta l√≠nea ya que no existe el input attachPdf
            
            document.getElementById('attachDocument').addEventListener('change', async (e)=>{
                console.log('Archivo de documento seleccionado:', e.target.files?.[0]);
                const file = e.target.files?.[0];
                if(!file) return;

                if(bytesToMB(file.size) > 10){
                    notifications.warning('Documento supera 10MB');
                    return;
                }

                console.log('Procesando documento:', file.name, 'Tama√±o:', bytesToMB(file.size), 'MB');

                try {
                    // Mostrar indicador de carga
                    notifications.info('Subiendo documento...');

                    // Subir archivo al bucket de Supabase Storage
                    const uploadResult = await uploadFileToStorage(file, 'documents/');

                    console.log('Documento subido exitosamente, agregando adjunto');

                    // Agregar a adjuntos pendientes con la URL del storage
                    pendingAttachments.push({
                        type: 'document',
                        name: file.name,
                        url: uploadResult.url,
                        dataUrl: uploadResult.url, // Mantener compatibilidad con c√≥digo existente
                        path: uploadResult.path
                    });

                    addPreviewDocument(file.name);
                    notifications.success('Documento subido correctamente');

                } catch (error) {
                    console.error('Error subiendo documento:', error);
                    notifications.error('Error subiendo documento. Int√©ntalo de nuevo.');
                }

                e.target.value='';
            });

            // Funci√≥n para subir archivos a Supabase Storage (MODO P√öBLICO)
            async function uploadFileToStorage(file, folder = '') {
                try {
                    // Verificar que Supabase est√© disponible
                    if (!window.supabase) {
                        throw new Error('Supabase client no est√° disponible');
                    }

                    console.log('üîÑ [UPLOAD] Iniciando subida en modo p√∫blico (sin autenticaci√≥n requerida)');

                    // MODO P√öBLICO: Verificar autenticaci√≥n de forma opcional
                    let userInfo = 'an√≥nimo';
                    try {
                        const { data: { session }, error: authError } = await window.supabase.auth.getSession();
                        if (!authError && session?.user) {
                            userInfo = session.user.email || session.user.id;
                            console.log('‚úÖ Usuario autenticado encontrado:', userInfo);
                        } else {
                            console.log('‚ÑπÔ∏è Subiendo como usuario an√≥nimo (bucket p√∫blico)');
                        }
                    } catch (authError) {
                        console.log('‚ÑπÔ∏è Error verificando sesi√≥n (continuando en modo p√∫blico):', authError.message);
                    }

                    // Generar nombre √∫nico para el archivo
                    const timestamp = Date.now();
                    const randomId = Math.random().toString(36).substring(2, 15);
                    const fileExtension = file.name.split('.').pop();
                    const fileName = `${folder}${timestamp}_${randomId}.${fileExtension}`;

                    console.log(`üì§ Subiendo archivo ${file.name} como ${fileName} al bucket community-thinks...`);
                    console.log(`üìä Tama√±o del archivo: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                    console.log(`üë§ Usuario: ${userInfo}`);

                    // Verificar que el bucket existe
                    try {
                        const { data: buckets, error: bucketsError } = await window.supabase.storage.listBuckets();
                        if (bucketsError) {
                            console.warn('‚ö†Ô∏è Error verificando buckets:', bucketsError);
                        } else {
                            const bucket = buckets.find(b => b.name === 'community-thinks');
                            if (!bucket) {
                                throw new Error('Bucket community-thinks no encontrado');
                            }
                            console.log('‚úÖ Bucket community-thinks verificado');
                        }
                    } catch (bucketError) {
                        console.warn('‚ö†Ô∏è No se pudo verificar bucket, continuando:', bucketError.message);
                    }

                    // Subir archivo al bucket
                    const { data, error } = await window.supabase.storage
                        .from('community-thinks')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) {
                        console.error('‚ùå Error subiendo archivo:', error);
                        console.error('üìã Detalles del error:', {
                            message: error.message,
                            statusCode: error.statusCode,
                            error: error.error
                        });

                        // Proporcionar mensaje m√°s espec√≠fico seg√∫n el error
                        if (error.message && error.message.includes('row-level security policy')) {
                            throw new Error('Error de permisos: El bucket no tiene las pol√≠ticas de seguridad configuradas correctamente. Contacta al administrador.');
                        } else if (error.message && error.message.includes('not found')) {
                            throw new Error('Bucket no encontrado: Verifica que el bucket community-thinks existe en Supabase Storage.');
                        } else {
                            throw new Error(`Error subiendo archivo: ${error.message}`);
                        }
                    }

                    console.log('‚úÖ Archivo subido exitosamente al path:', data.path);

                    // Obtener URL p√∫blica del archivo
                    const { data: urlData } = window.supabase.storage
                        .from('community-thinks')
                        .getPublicUrl(fileName);

                    console.log('‚úÖ URL p√∫blica generada:', urlData.publicUrl);

                    return {
                        url: urlData.publicUrl,
                        path: fileName
                    };

                } catch (error) {
                    console.error('‚ùå Error en uploadFileToStorage:', error);
                    throw error;
                }
            }

            function youtubeEmbed(url){
                console.log('üîç Validando URL de YouTube:', url);
                
                // Limpiar URL de espacios y caracteres extra√±os
                const cleanUrl = url.trim();
                
                // Regex m√°s flexible que soporta m√∫ltiples formatos de YouTube
                const patterns = [
                    // youtube.com/watch?v= (con o sin www, http/https, con par√°metros adicionales)
                    /(?:https?:\/\/)?(?:www\.)?(?:m\.)?youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/i,
                    // youtu.be/ (formato corto)
                    /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/i,
                    // youtube.com/embed/ (formato embed)
                    /(?:https?:\/\/)?(?:www\.)?(?:m\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/i,
                    // youtube.com/v/ (formato antiguo)
                    /(?:https?:\/\/)?(?:www\.)?(?:m\.)?youtube\.com\/v\/([a-zA-Z0-9_-]{11})/i,
                    // youtube.com/shorts/ (formato shorts)
                    /(?:https?:\/\/)?(?:www\.)?(?:m\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/i,
                    // youtube.com/live/ (formato live/streaming)
                    /(?:https?:\/\/)?(?:www\.)?(?:m\.)?youtube\.com\/live\/([a-zA-Z0-9_-]{11})/i
                ];
                
                for (let i = 0; i < patterns.length; i++) {
                    const pattern = patterns[i];
                    console.log(`üß™ Probando patr√≥n ${i + 1}:`, pattern);
                    const match = cleanUrl.match(pattern);
                    console.log('üéØ Resultado del match:', match);
                    
                    if (match && match[1]) {
                        const videoId = match[1];
                        const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        console.log('‚úÖ URL v√°lida encontrada. Video ID:', videoId);
                        console.log('üé¨ URL de embed generada:', embedUrl);
                        return embedUrl;
                    }
                }
                
                console.log('‚ùå No se encontr√≥ un patr√≥n v√°lido para la URL');
                return null;
            }

            function renderAttachments(att){
                if(!att || att.length===0) return '';
                return `<div class='attachments-preview'>` + att.map(a=>{
                     if(a.type==='image') return `<img src='${a.src || a.url}' class='preview-thumb' loading='lazy' alt='Imagen adjunta'>`;
                     if(a.type==='video' && a.isYoutube) return `<iframe width='240' height='135' src='${a.embed}' frameborder='0' allowfullscreen loading='lazy'></iframe>`;
                     if(a.type==='video') return `<video src='${a.src || a.url}' class='preview-thumb' controls loading='lazy' style='max-width: 240px; max-height: 135px;'></video>`;
                    if(a.type==='pdf') return `<a href='${a.dataUrl || a.url}' target='_blank' class='pdf-chip'><i class='fas fa-file-pdf'></i> ${a.name}</a>`;
                    if(a.type==='document') return `<a href='${a.dataUrl || a.url}' target='_blank' class='document-chip'><i class='${getDocumentIcon(a.name)}'></i> ${a.name}</a>`;
                    if(a.type==='link') return `<a href='${a.url}' target='_blank' class='link-chip'><i class='fas fa-link'></i> ${new URL(a.url).hostname.replace('www.', '')}</a>`;
                    if(a.type==='poll') return `<div class='poll-chip'><i class='fas fa-poll'></i> ${a.question} (${a.options.length} opciones)</div>`;
                    return '';
                }).join('') + `</div>`;
            }

            function renderAttachmentsCentered(att){
                console.log('üé® [RENDER] renderAttachmentsCentered llamado con:', att);

                if(!att || att.length===0) {
                    console.log('‚ö†Ô∏è [RENDER] No hay attachments para renderizar');
                    return '';
                }

                console.log(`üìé [RENDER] Renderizando ${att.length} attachment(s)`);

                return att.map((a, index) => {
                    console.log(`  ${index + 1}. Tipo: ${a.type}`, a);

                     if(a.type==='image') return `<div class="post-media-container"><img src='${a.src || a.url}' class='post-image' loading='lazy' alt='Imagen adjunta'></div>`;
                     if(a.type==='video' && a.isYoutube) return `<div class="post-media-container"><iframe width='100%' height='315' src='${a.embed}' frameborder='0' allowfullscreen loading='lazy'></iframe></div>`;
                     if(a.type==='video') return `<div class="post-media-container"><video src='${a.src || a.url}' class='post-video' controls loading='lazy'></video></div>`;
                    if(a.type==='pdf') return `<div class="post-document-container"><a href='${a.dataUrl || a.url}' target='_blank' class='attachment-link'><i class='fas fa-file-pdf'></i> ${a.name}</a></div>`;
                    if(a.type==='document') return `<div class="post-document-container"><a href='${a.dataUrl || a.url}' target='_blank' class='attachment-link'><i class='${getDocumentIcon(a.name)}'></i> ${a.name}</a></div>`;
                    if(a.type==='link') return `<div class="post-link-container"><a href='${a.url}' target='_blank' class='attachment-link'><i class='fas fa-link'></i> ${new URL(a.url).hostname.replace('www.', '')}</a></div>`;
                    if(a.type==='poll') {
                        console.log('üìä [RENDER] Renderizando encuesta:', a);
                        // Nota: renderPollInteractive es async, pero no podemos usar await en map
                        // La encuesta se renderizar√° y luego se actualizar√° con el voto del usuario
                        const placeholderId = `poll-placeholder-${a.postId}`;
                        // Renderizar la encuesta de forma as√≠ncrona despu√©s de que se inserte el placeholder
                        setTimeout(async () => {
                            const placeholder = document.getElementById(placeholderId);
                            if (placeholder) {
                                const pollHtml = await renderPollInteractive(a);
                                placeholder.outerHTML = pollHtml;

                                // Re-agregar event listeners para votaci√≥n
                                document.querySelectorAll(`.poll-option-interactive[data-poll-id="${a.postId}"]`).forEach(optionEl => {
                                    optionEl.addEventListener('click', async (e) => {
                                        // Prevenir que se abra el modal de post al votar
                                        e.stopPropagation();
                                        e.preventDefault();

                                        const postId = optionEl.getAttribute('data-poll-id');
                                        const option = optionEl.getAttribute('data-option');
                                        await voteInPoll(postId, option);
                                    });
                                });
                            }
                        }, 100);
                        return `<div id="${placeholderId}" class="poll-placeholder" data-poll-id="${a.postId}"><div style="text-align: center; padding: 20px; color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Cargando encuesta...</div></div>`;
                    }
                    console.warn('‚ö†Ô∏è [RENDER] Tipo de attachment desconocido:', a.type);
                    return '';
                }).join('');
            }

            // Funci√≥n para renderizar encuesta interactiva (MEJORADA: muestra voto del usuario)
            async function renderPollInteractive(poll) {
                console.log('üìä [POLL RENDER] Iniciando renderizado de encuesta:', poll);
                console.log('  - Poll ID:', poll.postId);
                console.log('  - Question:', poll.question);
                console.log('  - Options:', poll.options);
                console.log('  - Votes (raw):', poll.votes);
                console.log('  - Votes type:', typeof poll.votes);

                // Obtener el voto del usuario actual
                let userVote = null;
                try {
                    const userResult = await getCurrentUserForCommunity();
                    if (userResult.id) {
                        userVote = await getUserPollVote(poll.postId, userResult.id);
                        console.log('üìä [POLL RENDER] Voto del usuario:', userVote);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error obteniendo voto del usuario:', error);
                }

                // SANITIZAR Y VALIDAR datos de votos
                let votes = {};

                // Si votes es un objeto v√°lido
                if (poll.votes && typeof poll.votes === 'object' && !Array.isArray(poll.votes)) {
                    console.log('üîç [VOTES DEBUG] Analizando estructura de votes...');

                    // Recorrer cada clave en votes
                    Object.keys(poll.votes).forEach(key => {
                        console.log(`  - Key: "${key}", Value:`, poll.votes[key], `Type: ${typeof poll.votes[key]}`);

                        // SOLO incluir claves que sean opciones v√°lidas de la encuesta
                        if (poll.options.includes(key)) {
                            const value = poll.votes[key];

                            // Validar que el valor sea un n√∫mero v√°lido
                            if (typeof value === 'number' && !isNaN(value) && value >= 0) {
                                votes[key] = value;
                                console.log(`    ‚úÖ Voto v√°lido para "${key}": ${value}`);
                            } else if (typeof value === 'string') {
                                const parsed = parseInt(value, 10);
                                if (!isNaN(parsed) && parsed >= 0) {
                                    votes[key] = parsed;
                                    console.log(`    ‚úÖ Voto convertido para "${key}": ${parsed}`);
                                } else {
                                    console.warn(`    ‚ö†Ô∏è Valor no v√°lido para "${key}":`, value);
                                    votes[key] = 0;
                                }
                            } else {
                                console.warn(`    ‚ö†Ô∏è Tipo no v√°lido para "${key}":`, typeof value, value);
                                votes[key] = 0;
                            }
                        } else {
                            console.warn(`    ‚ö†Ô∏è Key "${key}" no es una opci√≥n v√°lida de la encuesta`);
                        }
                    });

                    // Inicializar opciones que no tienen votos
                    poll.options.forEach(option => {
                        if (!(option in votes)) {
                            votes[option] = 0;
                            console.log(`    ‚ÑπÔ∏è Inicializando "${option}" con 0 votos`);
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è [VOTES DEBUG] votes no es un objeto v√°lido, inicializando con 0s');
                    // Inicializar todos con 0
                    poll.options.forEach(option => {
                        votes[option] = 0;
                    });
                }

                console.log('‚úÖ [VOTES DEBUG] Votos sanitizados:', votes);

                // Calcular votos totales SOLO de las opciones v√°lidas
                const totalVotes = Object.values(votes).reduce((sum, count) => sum + count, 0);
                console.log('üìä [VOTES DEBUG] Total de votos calculado:', totalVotes);

                // Generar HTML de opciones con barras de progreso
                const optionsHtml = poll.options.map((option, index) => {
                    const voteCount = votes[option] || 0;
                    const percentage = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
                    const isUserVoted = userVote === option;

                    console.log(`  Opci√≥n ${index + 1}: "${option}" - ${voteCount} votos (${percentage}%)${isUserVoted ? ' [VOTADA]' : ''}`);

                    return `
                        <div class="poll-option-interactive ${isUserVoted ? 'user-voted' : ''}" data-poll-id="${poll.postId}" data-option="${option}">
                            <div class="poll-option-content">
                                <span class="poll-option-text">
                                    ${isUserVoted ? '<i class="fas fa-check-circle" style="color: var(--primary-color); margin-right: 8px;"></i>' : ''}
                                    ${option}
                                </span>
                                <span class="poll-option-votes">${voteCount} votos (${percentage}%)</span>
                            </div>
                            <div class="poll-progress-bar">
                                <div class="poll-progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="post-poll-container">
                        <div class="poll-header">
                            <i class="fas fa-poll"></i>
                            <h4 class="poll-question">${poll.question}</h4>
                        </div>
                        <div class="poll-options-list">
                            ${optionsHtml}
                        </div>
                        <div class="poll-footer">
                            <span class="poll-total-votes">${totalVotes} votos totales</span>
                            ${userVote ? `<span class="poll-user-hint"><i class="fas fa-info-circle"></i> Haz click en tu voto para cancelarlo o en otra opci√≥n para cambiar</span>` : ''}
                        </div>
                    </div>
                `;
            }

            // Funci√≥n auxiliar para limpiar datos de encuestas corruptas
            async function cleanCorruptedPollData(postId) {
                try {
                    console.log('üßπ [POLL CLEANUP] Intentando limpiar datos corruptos del post:', postId);

                    // Obtener datos actuales
                    const { data: currentPost, error: fetchError } = await window.supabase
                        .from('community_posts')
                        .select('attachment_data')
                        .eq('id', postId)
                        .single();

                    if (fetchError || !currentPost) {
                        console.error('‚ùå Error obteniendo post:', fetchError);
                        return false;
                    }

                    const pollData = currentPost.attachment_data;
                    if (!pollData || !pollData.options || !Array.isArray(pollData.options)) {
                        console.error('‚ùå Datos de encuesta inv√°lidos');
                        return false;
                    }

                    console.log('üìä Datos actuales:', pollData);

                    // Crear objeto de votos limpio basado en las opciones v√°lidas
                    const cleanVotes = {};
                    pollData.options.forEach(option => {
                        // Si existe un voto para esta opci√≥n y es v√°lido, mantenerlo
                        if (pollData.votes && pollData.votes[option]) {
                            const value = pollData.votes[option];
                            if (typeof value === 'number' && !isNaN(value) && value >= 0) {
                                cleanVotes[option] = value;
                            } else if (typeof value === 'string') {
                                const parsed = parseInt(value, 10);
                                if (!isNaN(parsed) && parsed >= 0) {
                                    cleanVotes[option] = parsed;
                                } else {
                                    cleanVotes[option] = 0;
                                }
                            } else {
                                cleanVotes[option] = 0;
                            }
                        } else {
                            cleanVotes[option] = 0;
                        }
                    });

                    console.log('‚úÖ Votos limpiados:', cleanVotes);

                    // Actualizar en la base de datos
                    const cleanedPollData = {
                        question: pollData.question,
                        options: pollData.options,
                        votes: cleanVotes
                    };

                    const { error: updateError } = await window.supabase
                        .from('community_posts')
                        .update({ attachment_data: cleanedPollData })
                        .eq('id', postId);

                    if (updateError) {
                        console.error('‚ùå Error actualizando datos limpios:', updateError);
                        return false;
                    }

                    console.log('‚úÖ Datos de encuesta limpiados exitosamente');
                    return true;

                } catch (error) {
                    console.error('‚ùå Error en cleanCorruptedPollData:', error);
                    return false;
                }
            }

            // Hacer funci√≥n disponible globalmente para uso manual
            window.cleanCorruptedPollData = cleanCorruptedPollData;

            // Funci√≥n para limpiar autom√°ticamente TODAS las encuestas corruptas
            async function cleanAllCorruptedPolls() {
                try {
                    console.log('üßπ [POLL CLEANUP] Buscando encuestas corruptas en la comunidad...');

                    if (!currentCommunity) {
                        console.warn('‚ö†Ô∏è No hay comunidad activa');
                        return;
                    }

                    // Obtener TODOS los posts con encuestas
                    const { data: pollPosts, error } = await window.supabase
                        .from('community_posts')
                        .select('id, attachment_data')
                        .eq('community_id', currentCommunity.id)
                        .eq('attachment_type', 'poll');

                    if (error) {
                        console.error('‚ùå Error obteniendo encuestas:', error);
                        return;
                    }

                    if (!pollPosts || pollPosts.length === 0) {
                        console.log('‚ÑπÔ∏è No hay encuestas en esta comunidad');
                        return;
                    }

                    console.log(`üìä Encontradas ${pollPosts.length} encuestas, verificando integridad...`);

                    let corruptedCount = 0;
                    let cleanedCount = 0;

                    for (const post of pollPosts) {
                        const pollData = post.attachment_data;

                        // Verificar si tiene datos corruptos
                        if (!pollData || !pollData.votes || !pollData.options) {
                            console.log(`‚ö†Ô∏è Post ${post.id}: Faltan datos b√°sicos, omitiendo...`);
                            continue;
                        }

                        // Verificar si hay claves extra√±as en votes
                        const voteKeys = Object.keys(pollData.votes);
                        const invalidKeys = voteKeys.filter(key => !pollData.options.includes(key));

                        if (invalidKeys.length > 0) {
                            console.warn(`üîç Post ${post.id}: Encontradas ${invalidKeys.length} claves inv√°lidas:`, invalidKeys);
                            corruptedCount++;

                            // Limpiar autom√°ticamente
                            const cleaned = await cleanCorruptedPollData(post.id);
                            if (cleaned) {
                                cleanedCount++;
                                console.log(`‚úÖ Post ${post.id}: Datos limpiados`);
                            }
                        }
                    }

                    if (corruptedCount === 0) {
                        console.log('‚úÖ Todas las encuestas tienen datos v√°lidos');
                    } else {
                        console.log(`üßπ Limpieza completada: ${cleanedCount}/${corruptedCount} encuestas limpiadas`);

                        // Recargar posts para mostrar datos limpios
                        await loadPostsFromDatabase();
                        notifications.success(`${cleanedCount} encuestas limpiadas exitosamente`);
                    }

                } catch (error) {
                    console.error('‚ùå Error en cleanAllCorruptedPolls:', error);
                }
            }

            // Hacer funci√≥n disponible globalmente
            window.cleanAllCorruptedPolls = cleanAllCorruptedPolls;

            // Funci√≥n para obtener el voto del usuario en una encuesta espec√≠fica
            async function getUserPollVote(postId, userId) {
                try {
                    const voteKey = `poll_vote_${postId}_${userId}`;

                    // Primero intentar obtener desde localStorage
                    const localVote = localStorage.getItem(voteKey);
                    if (localVote) {
                        console.log('üìä [POLL] Voto encontrado en localStorage:', localVote);
                        return localVote;
                    }

                    // Si hay Supabase, intentar obtener desde base de datos
                    if (window.supabase) {
                        const { data, error } = await window.supabase
                            .from('community_poll_votes')
                            .select('option')
                            .eq('post_id', postId)
                            .eq('user_id', userId)
                            .maybeSingle();

                        if (!error && data) {
                            // Guardar en localStorage para cache
                            localStorage.setItem(voteKey, data.option);
                            console.log('üìä [POLL] Voto encontrado en BD:', data.option);
                            return data.option;
                        }
                    }

                    return null;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error obteniendo voto del usuario:', error);
                    return null;
                }
            }

            // Funci√≥n para guardar el voto del usuario
            async function saveUserPollVote(postId, userId, option) {
                try {
                    const voteKey = `poll_vote_${postId}_${userId}`;

                    // Guardar en localStorage
                    localStorage.setItem(voteKey, option);
                    console.log('üìä [POLL] Voto guardado en localStorage:', option);

                    // Si hay Supabase, guardar tambi√©n en BD
                    if (window.supabase) {
                        // Usar upsert para insertar o actualizar
                        const { error } = await window.supabase
                            .from('community_poll_votes')
                            .upsert({
                                post_id: postId,
                                user_id: userId,
                                option: option
                            }, {
                                onConflict: 'post_id,user_id'
                            });

                        if (error) {
                            console.warn('‚ö†Ô∏è Error guardando voto en BD:', error);
                        } else {
                            console.log('üìä [POLL] Voto guardado en BD exitosamente');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error guardando voto del usuario:', error);
                }
            }

            // Funci√≥n para eliminar el voto del usuario
            async function removeUserPollVote(postId, userId) {
                try {
                    const voteKey = `poll_vote_${postId}_${userId}`;

                    // Eliminar de localStorage
                    localStorage.removeItem(voteKey);
                    console.log('üìä [POLL] Voto eliminado de localStorage');

                    // Si hay Supabase, eliminar tambi√©n de BD
                    if (window.supabase) {
                        const { error } = await window.supabase
                            .from('community_poll_votes')
                            .delete()
                            .eq('post_id', postId)
                            .eq('user_id', userId);

                        if (error) {
                            console.warn('‚ö†Ô∏è Error eliminando voto en BD:', error);
                        } else {
                            console.log('üìä [POLL] Voto eliminado de BD exitosamente');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error eliminando voto del usuario:', error);
                }
            }

            // Funci√≥n para votar en encuestas (MEJORADA: permitir cambiar y cancelar voto)
            async function voteInPoll(postId, option) {
                try {
                    console.log('üó≥Ô∏è [POLL] Iniciando votaci√≥n en encuesta:', { postId, option });

                    // Verificar autenticaci√≥n
                    const userResult = await getCurrentUserForCommunity();
                    if (!userResult.id) {
                        notifications.error('Debes iniciar sesi√≥n para votar');
                        return;
                    }

                    // Verificar que el post existe localmente
                    const post = posts.find(p => p.id == postId || p.id === Number(postId));
                    if (!post) {
                        notifications.error('No se encontr√≥ la encuesta');
                        return;
                    }

                    // Obtener el voto anterior del usuario (si existe)
                    const previousVote = await getUserPollVote(postId, userResult.id);
                    console.log('üìä [POLL] Voto anterior del usuario:', previousVote);

                    // Obtener datos actuales de la encuesta desde la base de datos
                    const { data: currentPost, error: fetchError } = await window.supabase
                        .from('community_posts')
                        .select('attachment_data')
                        .eq('id', postId)
                        .single();

                    if (fetchError) {
                        console.error('‚ùå Error obteniendo datos de encuesta:', fetchError);
                        notifications.error('Error al cargar la encuesta');
                        return;
                    }

                    const pollData = currentPost.attachment_data || { votes: {} };
                    const votes = pollData.votes || {};

                    // CASO 1: Usuario hace click en la opci√≥n que ya vot√≥ (CANCELAR VOTO)
                    if (previousVote === option) {
                        console.log('üó≥Ô∏è [POLL] Cancelando voto en:', option);

                        // Decrementar el contador de la opci√≥n
                        votes[option] = Math.max(0, (parseInt(votes[option]) || 0) - 1);

                        // Eliminar el registro del voto del usuario
                        await removeUserPollVote(postId, userResult.id);

                        notifications.info('Voto cancelado');
                    }
                    // CASO 2: Usuario hace click en una opci√≥n diferente (CAMBIAR VOTO)
                    else if (previousVote) {
                        console.log('üó≥Ô∏è [POLL] Cambiando voto de:', previousVote, 'a:', option);

                        // Decrementar el contador de la opci√≥n anterior
                        votes[previousVote] = Math.max(0, (parseInt(votes[previousVote]) || 0) - 1);

                        // Incrementar el contador de la nueva opci√≥n
                        votes[option] = (parseInt(votes[option]) || 0) + 1;

                        // Actualizar el registro del voto del usuario
                        await saveUserPollVote(postId, userResult.id, option);

                        notifications.success(`Voto cambiado a: ${option}`);
                    }
                    // CASO 3: Usuario vota por primera vez (NUEVO VOTO)
                    else {
                        console.log('üó≥Ô∏è [POLL] Nuevo voto en:', option);

                        // Incrementar el contador de votos para la opci√≥n seleccionada
                        votes[option] = (parseInt(votes[option]) || 0) + 1;

                        // Guardar el registro del voto del usuario
                        await saveUserPollVote(postId, userResult.id, option);

                        notifications.success(`Votaste por: ${option}`);
                    }

                    // Actualizar attachment_data en la base de datos
                    const updatedPollData = {
                        ...pollData,
                        votes: votes
                    };

                    const { error: updateError } = await window.supabase
                        .from('community_posts')
                        .update({ attachment_data: updatedPollData })
                        .eq('id', postId);

                    if (updateError) {
                        console.error('‚ùå Error actualizando voto:', updateError);
                        notifications.error('Error al registrar voto');
                        return;
                    }

                    console.log('‚úÖ Voto registrado exitosamente');

                    // Recargar posts para mostrar resultados actualizados
                    await loadPostsFromDatabase();

                } catch (error) {
                    console.error('‚ùå Error en voteInPoll:', error);
                    notifications.error('Error al votar. Int√©ntalo de nuevo.');
                }
            }

            // resumen de reacciones
            function reactionSummary(r){
                if(!r) return '';
                const total = Object.values(r).reduce((a,b)=>a+(b||0),0);
                if(total===0) return '';
                const icons = [];
                if(r.like) icons.push('üëç');
                if(r.love) icons.push('‚ù§Ô∏è');
                if(r.angry) icons.push('üò†');
                if(r.wow) icons.push('üòÆ');
                if(r.laugh) icons.push('üòÇ');
                if(r.sad) icons.push('üò¢');
                return icons.join(' ') + ' ' + total;
            }

            // resumen de otras reacciones (excluyendo like)
            function otherReactionsSummary(r){
                if(!r) return '';
                const otherReactions = {love: r.love, angry: r.angry, wow: r.wow, laugh: r.laugh, sad: r.sad};
                const total = Object.values(otherReactions).reduce((a,b)=>a+(b||0),0);
                if(total===0) return '';
                const icons = [];
                if(r.love) icons.push('‚ù§Ô∏è');
                if(r.angry) icons.push('üò†');
                if(r.wow) icons.push('üòÆ');
                if(r.laugh) icons.push('üòÇ');
                if(r.sad) icons.push('üò¢');
                return icons.join(' ') + ' ' + total;
            }

            // Variable para prevenir duplicaciones
            const reactionInProgress = new Set();

            // Aplicar reacci√≥n
            async function applyReaction(postId, reactionType) {
                // Crear una clave √∫nica para esta reacci√≥n
                const reactionKey = `${postId}-${reactionType}`;
                
                // Si ya est√° en progreso, ignorar
                if (reactionInProgress.has(reactionKey)) {
                    console.log('‚ö†Ô∏è [REACTION] Reacci√≥n ya en progreso, ignorando:', reactionKey);
                    return;
                }
                
                // Marcar como en progreso
                reactionInProgress.add(reactionKey);
                
                try {
                    console.log('üëç [REACTION] Aplicando reacci√≥n:', { postId, reactionType });
                    
                    const supabaseReady = await window.waitForSupabase();
                    if (!supabaseReady) {
                        throw new Error('Supabase no disponible');
                    }

                    const userResult = await getCurrentUserForCommunity();
                    if (!userResult.id) {
                        throw new Error('Usuario no autenticado');
                    }

                    // Verificar si ya existe una reacci√≥n del usuario
                    const { data: existingReaction, error: checkError } = await window.supabase
                        .from('community_reactions')
                        .select('*')
                        .eq('post_id', postId)
                        .eq('user_id', userResult.id)
                        .maybeSingle();

                    if (checkError) {
                        throw checkError;
                    }

                    if (existingReaction) {
                        // Si ya existe una reacci√≥n, actualizarla
                        if (existingReaction.reaction_type === reactionType) {
                            // Si es la misma reacci√≥n, quitarla (toggle)
                            const { error: deleteError } = await window.supabase
                                .from('community_reactions')
                                .delete()
                                .eq('post_id', postId)
                                .eq('user_id', userResult.id);

                            if (deleteError) {
                                throw deleteError;
                            }

                            // Actualizar el post local
                            const post = posts.find(p => p.id == postId || p.id === Number(postId));
                            if (post) {
                                post.reactions[reactionType] = Math.max(0, (post.reactions[reactionType] || 0) - 1);
                                post.reacted = null;
                                // Recalcular total de reacciones
                                post.totalReactions = Object.values(post.reactions).reduce((sum, count) => sum + count, 0);
                            }
                        } else {
                            // Si es una reacci√≥n diferente, actualizarla
                            const { error: updateError } = await window.supabase
                                .from('community_reactions')
                                .update({ reaction_type: reactionType })
                                .eq('post_id', postId)
                                .eq('user_id', userResult.id);

                            if (updateError) {
                                throw updateError;
                            }

                            // Actualizar el post local
                            const post = posts.find(p => p.id == postId || p.id === Number(postId));
                            if (post) {
                                // Restar la reacci√≥n anterior
                                post.reactions[existingReaction.reaction_type] = Math.max(0, (post.reactions[existingReaction.reaction_type] || 0) - 1);
                                // Sumar la nueva reacci√≥n
                                post.reactions[reactionType] = (post.reactions[reactionType] || 0) + 1;
                                post.reacted = reactionType;
                                // Recalcular total de reacciones
                                post.totalReactions = Object.values(post.reactions).reduce((sum, count) => sum + count, 0);
                            }
                        }
                    } else {
                        // Si no existe reacci√≥n, crear una nueva
                        const { error: insertError } = await window.supabase
                            .from('community_reactions')
                            .insert({
                                post_id: postId,
                                user_id: userResult.id,
                                reaction_type: reactionType
                            });

                        if (insertError) {
                            throw insertError;
                        }

                        // Actualizar el post local
                        const post = posts.find(p => p.id == postId || p.id === Number(postId));
                        if (post) {
                            post.reactions[reactionType] = (post.reactions[reactionType] || 0) + 1;
                            post.reacted = reactionType;
                            // Recalcular total de reacciones
                            post.totalReactions = Object.values(post.reactions).reduce((sum, count) => sum + count, 0);
                        }
                    }

                    // Actualizar contadores en tiempo real
                    updateReactionCounters(postId);
                    
                    console.log('‚úÖ [REACTION] Reacci√≥n aplicada exitosamente');
                } catch (error) {
                    console.error('‚ùå [REACTION] Error aplicando reacci√≥n:', error);
                    if (typeof notifications !== 'undefined') {
                        notifications.error('Error al aplicar reacci√≥n');
                    }
                } finally {
                    // Limpiar el estado de progreso
                    reactionInProgress.delete(reactionKey);
                }
            }

            // Remover reacci√≥n
            async function removeReaction(postId, reactionType) {
                try {
                    console.log('üëç [REACTION] Removiendo reacci√≥n:', { postId, reactionType });
                    
                    const supabaseReady = await window.waitForSupabase();
                    if (!supabaseReady) {
                        throw new Error('Supabase no disponible');
                    }

                    const userResult = await getCurrentUserForCommunity();
                    if (!userResult.id) {
                        throw new Error('Usuario no autenticado');
                    }

                    const { error } = await window.supabase
                        .from('community_reactions')
                        .delete()
                        .eq('post_id', postId)
                        .eq('user_id', userResult.id)
                        .eq('reaction_type', reactionType);

                    if (error) {
                        throw error;
                    }

                    // Actualizar el post local
                    const post = posts.find(p => p.id == postId || p.id === Number(postId));
                    if (post) {
                        post.reactions[reactionType] = Math.max(0, (post.reactions[reactionType] || 0) - 1);
                        post.reacted = null;
                    }

                    // Re-renderizar posts
                    renderPosts('all');
                    
                    console.log('‚úÖ [REACTION] Reacci√≥n removida exitosamente');
                } catch (error) {
                    console.error('‚ùå [REACTION] Error removiendo reacci√≥n:', error);
                    if (typeof notifications !== 'undefined') {
                        notifications.error('Error al remover reacci√≥n');
                    }
                }
            }

            // Modal de post
            async function openPostModal(id){
                const modal = document.getElementById('postModal');
                const body = document.getElementById('modalPostBody');
                const userEl = document.getElementById('modalPostUser');
                const post = posts.find(p=>p.id==id || p.id===Number(id));

                console.log('üí¨ [MODAL] Buscando post con ID:', id, 'Encontrado:', !!post);

                // Preservar contadores antes de abrir el modal
                preserveCountersOnModalOpen(id);

                if(!post) {
                    console.error('‚ùå [MODAL] Post no encontrado para ID:', id);
                    if (typeof notifications !== 'undefined') {
                        notifications.error('No se pudo encontrar la publicaci√≥n');
                    }
                    return;
                }

                // Mostrar el t√≠tulo de la publicaci√≥n (contenido truncado) en lugar del nombre del usuario
                const title = post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content;
                userEl.textContent = title;

                // Cargar comentarios desde la base de datos
                console.log('üí¨ Cargando comentarios desde BD para post:', id);
                let comments = [];
                try {
                    const { data: commentsData, error } = await window.supabase
                        .from('community_comments')
                        .select('*')
                        .eq('post_id', id)
                        .order('created_at', { ascending: true });

                    if (error) {
                        console.warn('‚ö†Ô∏è Error cargando comentarios de BD:', error);
                        // Usar comentarios locales como fallback
                        comments = post.comments || [];
                    } else {
                        // Convertir comentarios de BD al formato local y obtener nombres de usuario
                        comments = await Promise.all(commentsData.map(async comment => {
                            let userName = 'Usuario';
                            let userData = null;

                            // Intentar obtener datos del usuario
                            if (comment.user_id) {
                                try {
                                    const { data: userDataResponse } = await window.supabase
                                        .from('users')
                                        .select('display_name, first_name, username, profile_picture_url')
                                        .eq('id', comment.user_id)
                                        .single();

                                    if (userDataResponse) {
                                        userData = userDataResponse;
                                        userName = userData.display_name || userData.first_name || userData.username || 'Usuario';
                                    }
                                } catch (userError) {
                                    console.log('‚ö†Ô∏è No se pudieron obtener datos del usuario para comentario:', userError);
                                }
                            }

                            return {
                                id: comment.id,
                                user: userName,
                                time: formatTimeAgo(comment.created_at),
                                text: comment.content,
                                created_at: comment.created_at,
                                avatarUrl: userData?.profile_picture_url || null
                            };
                        }));
                        console.log('‚úÖ Comentarios cargados desde BD:', comments.length);
                        
                        // Actualizar el contador en el post principal
                        const postInMainView = posts.find(p => p.id === id);
                        if (postInMainView) {
                            postInMainView.comments = comments;
                            console.log('üîÑ Actualizando contador de comentarios en vista principal:', comments.length);
                            
                            // Actualizar el contador en el DOM
                            const commentCountEl = document.querySelector(`[data-id="${id}"] .comment-count`);
                            if (commentCountEl) {
                                commentCountEl.textContent = comments.length;
                                console.log('‚úÖ Contador de comentarios actualizado en DOM:', comments.length);
                            }
                            
                            // Tambi√©n actualizar el contador de reacciones si es necesario
                            const reactionCountEl = document.querySelector(`[data-id="${id}"] .reaction-count`);
                            if (reactionCountEl && postInMainView.reactions) {
                                const totalReactions = postInMainView.totalReactions || Object.values(postInMainView.reactions || {}).reduce((sum, count) => sum + count, 0);
                                reactionCountEl.textContent = totalReactions;
                                console.log('‚úÖ Contador de reacciones actualizado en DOM:', totalReactions);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error inesperado cargando comentarios:', error);
                    comments = post.comments || [];
                }

                body.innerHTML = `
                    <div class="post-card">
                        <div class="post-avatar">
                            ${post.avatarUrl ?
                                `<img src="${post.avatarUrl}" alt="${post.user}" class="post-avatar-img" onerror="console.warn('‚ö†Ô∏è Avatar de post no se pudo cargar'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <i class="${post.avatar}" style="display:none;"></i>` :
                                `<i class="${post.avatar}"></i>`
                            }
                        </div>
                        <div class="post-body">
                            <div class="post-header">
                                <span class="post-name">${post.user}</span>
                                <span class="post-meta">${post.timeAgo || `${post.minutesAgo} min`} <span>‚Ä¢</span> ${post.category}</span>
                            </div>
                            <div class="post-content">${post.content}</div>
                            ${renderAttachments(post.attachments)}
                            <div class="post-modal-actions">
                                <span class="shares" data-share="${post.id}"><i class="fas fa-share"></i> Compartir</span>
                                <span>${reactionSummary(post.reactions)}</span>
                            </div>
                            <div id="modalComments" class="comment-list">
                                ${comments.map(c=>commentTemplate(c)).join('')}
                            </div>
                        </div>
                    </div>
                `;
                // comentar desde modal
                document.getElementById('modalSendComment').onclick = async ()=>{
                    const input = document.getElementById('modalCommentInput');
                    const sendBtn = document.getElementById('modalSendComment');
                    const txt = (input.value||'').trim();
                    if(!txt) return;

                    // Prevenir m√∫ltiples env√≠os y mostrar indicador de carga
                    if (sendBtn.classList.contains('modal-send-loading')) {
                        console.log('‚ö†Ô∏è Comentario ya siendo enviado, ignorando click duplicado');
                        return;
                    }

                    // Agregar clase de carga y deshabilitar bot√≥n
                    sendBtn.classList.add('modal-send-loading');
                    sendBtn.disabled = true;
                    const originalText = sendBtn.textContent;
                    sendBtn.innerHTML = '<span class="btn-text">Publicando...</span>';

                    try {
                        console.log('üí¨ [MODAL] Creando comentario en BD...');

                        // Obtener usuario actual de manera consistente
                        const userResult = await getCurrentUserForCommunity();
                        if (!userResult.id) {
                            notifications.error('No se pudo verificar tu identidad. Int√©ntalo de nuevo.');
                            return;
                        }
                        const { user: currentUser, id: userId } = userResult;

                        // Obtener community_id del post
                        let communityId = null;

                        // Intentar obtener desde el post (si viene de BD)
                        if (post.community_id) {
                            communityId = post.community_id;
                        } else {
                            // Usar el mismo m√©todo que el sistema de posts
                            if (window.communitySystem && window.communitySystem.currentCommunity) {
                                communityId = window.communitySystem.currentCommunity.id;
                            } else {
                                // Fallback usando URL
                                const urlParams = new URLSearchParams(window.location.search);
                                const communitySlug = urlParams.get('slug') || 'profesionales';
                                const communityMap = {
                                    'profesionales': '7886aa14-35b9-41da-b099-29f11ad3516b',
                                    'sif-icap': 'aa5a4c4c-ce64-4a12-b1ef-365aa0d320c8',
                                    'openminder': 'b3b154e1-110e-4aa7-8998-ef208482a159',
                                    'ecos-de-liderazgo': 'd2dbebb1-5b57-4da7-9fc6-8b40c732b548'
                                };
                                communityId = communityMap[communitySlug];
                            }
                        }

                        if (!communityId) {
                            console.error('‚ùå No se pudo obtener el ID de la comunidad');
                            notifications.error('Error: No se pudo identificar la comunidad');
                            return;
                        }

                        // Crear comentario en la base de datos
                        const { data: newComment, error } = await window.supabase
                            .from('community_comments')
                            .insert({
                                post_id: post.id,
                                community_id: communityId,
                                user_id: userId,
                                content: txt
                            })
                            .select('*')
                            .single();

                        if (error) {
                            console.error('‚ùå [MODAL] Error creando comentario:', error);
                            notifications.error('Error al crear comentario: ' + error.message);

                            // Fallback a localStorage
                            console.log('‚ö†Ô∏è [MODAL] Usando fallback a localStorage...');
                            if (!post.comments) post.comments = [];
                            post.comments.push({
                                id: Date.now(),
                                user: currentUser?.name || 'Usuario',
                                time: 'ahora',
                                text: txt
                            });
                            input.value='';
                            document.getElementById('modalComments').innerHTML = (post.comments||[]).map(c=>commentTemplate(c)).join('');
                            savePosts();
                            updateStats();
                            notifications.success('Comentario agregado (modo local)');
                            return;
                        }

                        console.log('‚úÖ [MODAL] Comentario creado:', newComment);

                        // Obtener datos del usuario si es necesario
                        let userName = currentUser?.name || 'Usuario';
                        let userData = null;
                        if (currentUser && currentUser.id) {
                            try {
                                const { data: userDataResponse } = await window.supabase
                                    .from('users')
                                    .select('display_name, first_name, username, profile_picture_url')
                                    .eq('id', currentUser.id)
                                    .single();

                                if (userDataResponse) {
                                    userData = userDataResponse;
                                    userName = userData.display_name || userData.first_name || userData.username || userName;
                                }
                            } catch (userError) {
                                console.log('‚ö†Ô∏è No se pudieron obtener datos adicionales del usuario:', userError);
                                // Usar el nombre que ya tenemos
                            }
                        }

                        // Agregar comentario al post local
                        if (!post.comments) post.comments = [];
                        post.                        comments.push({
                            id: newComment.id,
                            user: userName,
                            time: 'ahora',
                            text: newComment.content,
                            created_at: newComment.created_at,
                            avatarUrl: userData?.profile_picture_url || null
                        });

                        // Agregar puntos por comentar
                        if (window.pointsSystem) {
                            await window.pointsSystem.addPoints(null, 'comment');
                        }

                        // Actualizar UI
                        input.value='';
                        document.getElementById('modalComments').innerHTML = (post.comments||[]).map(c=>commentTemplate(c)).join('');

                        // Actualizar estad√≠sticas
                        updateStats();

                        notifications.success('Comentario agregado correctamente');

                    } catch (error) {
                        console.error('‚ùå [MODAL] Error inesperado:', error);
                        notifications.error('Error inesperado al crear comentario');
                    } finally {
                        // Restaurar bot√≥n en todos los casos
                        sendBtn.classList.remove('modal-send-loading');
                        sendBtn.disabled = false;
                        sendBtn.textContent = originalText;
                    }
                };
                document.getElementById('closePostModal').onclick = ()=> modal.classList.remove('show');
                modal.classList.add('show');
            }

            // Funci√≥n para formatear tiempo desde timestamp
            function formatTimeAgo(dateString) {
                const now = Date.now();
                const timestamp = new Date(dateString).getTime();
                const diffSeconds = Math.floor((now - timestamp) / 1000);

                if (diffSeconds < 60) {
                    return 'Ahora mismo';
                } else if (diffSeconds < 3600) {
                    const minutes = Math.floor(diffSeconds / 60);
                    return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                } else if (diffSeconds < 86400) {
                    const hours = Math.floor(diffSeconds / 3600);
                    return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
                } else if (diffSeconds < 2592000) {
                    const days = Math.floor(diffSeconds / 86400);
                    return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
                } else {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }

            function commentTemplate(c){
                if(typeof c === 'string') {
                    return `<div class='comment-item'>
                        <div class='comment-avatar'>
                            <i class="fas fa-user"></i>
                        </div>
                        <div class='comment-bubble'>
                            <div class='comment-head'>
                                <span class='comment-name'>Usuario</span>
                                <span class='comment-time'>ahora</span>
                            </div>
                            <div>${c}</div>
                        </div>
                    </div>`;
                }

                return `<div class='comment-item'>
                    <div class='comment-avatar'>
                        ${c.avatarUrl ?
                            `<img src="${c.avatarUrl}" alt="${c.user}" class="comment-avatar-img" onerror="console.warn('‚ö†Ô∏è Avatar de comentario no se pudo cargar'); this.style.display='none';">
                             <i class="fas fa-user" style="display:none;"></i>` :
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class='comment-bubble'>
                        <div class='comment-head'>
                            <span class='comment-name'>${c.user||'Usuario'}</span>
                            <span class='comment-time'>${c.time||''}</span>
                        </div>
                        <div>${c.text||c}</div>
                    </div>
                </div>`;
            }

            if(composerInput && publishPostBtn){
                composerInput.addEventListener('input', ()=>{
                    const ok = composerInput.value.trim().length>0;
                    publishPostBtn.disabled = !ok;
                    publishPostBtn.classList.toggle('enabled', ok);
                });
                publishPostBtn.addEventListener('click', async ()=>{
                    console.log('Bot√≥n de publicar clickeado');

                    // Verificar autenticaci√≥n primero
                    const isAuthenticated = await checkAuthenticationForPosts();
                    if (!isAuthenticated) {
                        console.warn('‚ö†Ô∏è No se detect√≥ autenticaci√≥n, pero intentando crear post de todas formas...');
                        // No bloquear inmediatamente, intentar crear el post
                        // notifications.error('Debes iniciar sesi√≥n para publicar en la comunidad.');
                        // return;
                    }

                    const txt = composerInput.value.trim();
                    if(!txt) {
                        console.log('Texto vac√≠o, no se puede publicar');
                        notifications.warning('Escribe algo antes de publicar.');
                        return;
                    }

                    console.log('Creando publicaci√≥n con texto:', txt);
                    console.log('Adjuntos pendientes:', pendingAttachments);

                    try {
                        // Deshabilitar bot√≥n durante el proceso
                        publishPostBtn.disabled = true;
                        publishPostBtn.textContent = 'Publicando...';

                        // Usar CommunitySystem que ya est√° cargado y funciona con el banner
                        console.log('üè† Obteniendo comunidad desde CommunitySystem...');

                        let currentCommunity = null;
                        let communityId = null;

                        // M√âTODO 1: Usar CommunitySystem que ya carg√≥ el banner
                        if (window.communitySystem && window.communitySystem.currentCommunity) {
                            currentCommunity = window.communitySystem.currentCommunity;
                            communityId = currentCommunity.id;
                            console.log(`‚úÖ Comunidad obtenida desde CommunitySystem: ${currentCommunity.name} (ID: ${communityId})`);
                        }

                        // M√âTODO 2: Usar datos del localStorage (mismo que usa el banner)
                        if (!communityId) {
                            console.log('üîÑ CommunitySystem no disponible, usando localStorage...');
                            const urlParams = new URLSearchParams(window.location.search);
                            const communitySlug = urlParams.get('slug') || 'profesionales';

                            const savedCommunities = localStorage.getItem('savedCommunities');
                            if (savedCommunities) {
                                const communities = JSON.parse(savedCommunities);
                                currentCommunity = communities.find(c => c.slug === communitySlug);
                                if (currentCommunity) {
                                    communityId = currentCommunity.id;
                                    console.log(`‚úÖ Comunidad obtenida desde localStorage: ${currentCommunity.name} (ID: ${communityId})`);
                                }
                            }
                        }

                        // M√âTODO 3: Fallback hardcodeado para comunidades conocidas
                        if (!communityId) {
                            console.log('üîÑ Usando fallback hardcodeado...');
                            const urlParams = new URLSearchParams(window.location.search);
                            const communitySlug = urlParams.get('slug') || 'profesionales';

                            const hardcodedCommunities = {
                                'profesionales': { id: '7886aa14-35b9-41da-b099-29f11ad3516b', name: 'Profesionales' },
                                'sif-icap': { id: 'aa5a4c4c-ce64-4a12-b1ef-365aa0d320c8', name: 'SIF ICAP' },
                                'openminder': { id: 'b3b154e1-110e-4aa7-8998-ef208482a159', name: 'Openminder' },
                                'ecos-de-liderazgo': { id: 'd2dbebb1-5b57-4da7-9fc6-8b40c732b548', name: 'Ecos de Liderazgo' }
                            };

                            if (hardcodedCommunities[communitySlug]) {
                                currentCommunity = hardcodedCommunities[communitySlug];
                                communityId = currentCommunity.id;
                                console.log(`‚úÖ Comunidad obtenida desde fallback: ${currentCommunity.name} (ID: ${communityId})`);
                            }
                        }

                        if (!communityId) {
                            console.error('‚ùå Debug - Estado del sistema:');
                            console.error('  - window.communitySystem:', !!window.communitySystem);
                            console.error('  - window.communitySystem.currentCommunity:', window.communitySystem?.currentCommunity);
                            console.error('  - localStorage savedCommunities:', !!localStorage.getItem('savedCommunities'));
                            console.error('  - URL slug:', new URLSearchParams(window.location.search).get('slug'));
                            throw new Error('No se pudo obtener el ID de la comunidad con ning√∫n m√©todo');
                        }

                        // Verificar que tenemos CommunityDatabase
                        if (!window.CommunityDatabase) {
                            throw new Error('CommunityDatabase no est√° disponible');
                        }

                        // Crear instancia de la base de datos
                        const db = new window.CommunityDatabase();
                        await db.initialize();

                        // M√©todo alternativo para obtener usuario si CommunityDatabase falla
                        let currentUser = null;
                        try {
                            currentUser = await db.getCurrentUser();
                        } catch (userError) {
                            console.warn('‚ö†Ô∏è Error obteniendo usuario con CommunityDatabase:', userError);
                        }

                        // Si CommunityDatabase no funciona, intentar obtener usuario directamente
                        if (!currentUser) {
                            console.log('üîÑ Intentando obtener usuario directamente de Supabase...');
                            try {
                                const { data: { session } } = await window.supabase.auth.getSession();
                                if (session && session.user) {
                                    currentUser = {
                                        id: session.user.id,
                                        email: session.user.email,
                                        display_name: session.user.user_metadata?.full_name || session.user.email
                                    };
                                    console.log('‚úÖ Usuario obtenido directamente de Supabase:', currentUser.email);
                                }
                            } catch (directError) {
                                console.warn('‚ö†Ô∏è Error obteniendo usuario directamente:', directError);
                            }
                        }

                        if (!currentUser) {
                            console.warn('‚ö†Ô∏è No se pudo obtener usuario con ning√∫n m√©todo');
                            // Continuar de todas formas, el error se mostrar√° en createPost
                        }

                        // Preparar datos para adjuntos
                        let attachmentUrl = null;
                        let attachmentType = null;
                        let attachmentData = null;

                        if (pendingAttachments.length > 0) {
                            const firstAttachment = pendingAttachments[0];

                            // Para encuestas, preparar los datos especiales
                            if (firstAttachment.type === 'poll') {
                                attachmentType = 'poll';
                                attachmentUrl = null; // Las encuestas no usan URL
                                // Crear estructura de datos para la encuesta
                                attachmentData = {
                                    question: firstAttachment.question,
                                    options: firstAttachment.options,
                                    votes: {} // Inicializar objeto vac√≠o de votos
                                };
                                console.log('üìä Preparando datos de encuesta:', attachmentData);
                            }
                            // Para videos de YouTube, usar el embed URL
                            else if (firstAttachment.isYoutube && firstAttachment.embed) {
                                attachmentUrl = firstAttachment.embed;
                                attachmentType = firstAttachment.type;
                            } else {
                                attachmentUrl = firstAttachment.url || firstAttachment.src;
                                attachmentType = firstAttachment.type;
                            }
                        }

                        // Crear publicaci√≥n en la base de datos
                        console.log('üöÄ Guardando publicaci√≥n en base de datos...');
                        let createdPost = null;

                        try {
                            createdPost = await db.createPost(
                                communityId,
                                txt,
                                null, // title - no estamos usando t√≠tulos por ahora
                                attachmentUrl,
                                attachmentType,
                                attachmentData // Agregar datos de encuesta
                            );
                        } catch (createError) {
                            console.warn('‚ö†Ô∏è Error con db.createPost, intentando m√©todo directo:', createError);

                            // M√©todo directo si CommunityDatabase falla
                            const { data: { session } } = await window.supabase.auth.getSession();
                            if (session && session.user) {
                                const postData = {
                                    community_id: communityId,
                                    user_id: session.user.id,
                                    content: txt,
                                    title: null,
                                    attachment_url: attachmentUrl,
                                    attachment_type: attachmentType,
                                    attachment_data: attachmentData // Agregar datos de encuesta
                                };

                                const { data, error } = await window.supabase
                                    .from('community_posts')
                                    .insert(postData)
                                    .select(`
                                        *,
                                        users!community_posts_user_id_fkey (
                                            id,
                                            display_name,
                                            first_name,
                                            username,
                                            profile_picture_url
                                        )
                                    `)
                                    .single();

                                if (error) {
                                    throw new Error(`Error creando post directamente: ${error.message}`);
                                }

                                createdPost = data;
                                console.log('‚úÖ Post creado usando m√©todo directo');
                            } else {
                                throw new Error('No hay sesi√≥n v√°lida para crear post');
                            }
                        }

                        if (!createdPost) {
                            throw new Error('No se pudo crear la publicaci√≥n en la base de datos');
                        }

                        console.log('‚úÖ Publicaci√≥n guardada en base de datos:', createdPost);

                        // Agregar puntos por publicar
                        if (window.pointsSystem) {
                            console.log('üéØ Adding points for publication...');
                            await window.pointsSystem.addPoints(null, 'publish');
                        }

                        // Limpiar formulario
                        composerInput.value='';
                        publishPostBtn.disabled = true;
                        publishPostBtn.classList.remove('enabled');
                        publishPostBtn.textContent = 'Publicar';

                        // Limpiar adjuntos
                        pendingAttachments = [];
                        document.getElementById('attachmentsPreview').innerHTML='';

                        // Recargar posts desde la base de datos
                        console.log('üîÑ Recargando posts desde base de datos...');
                        await loadPostsFromDatabase();

                        // Mostrar confirmaci√≥n
                        notifications.success('¬°Publicaci√≥n creada exitosamente!');
                        console.log('‚úÖ Publicaci√≥n completada');

                    } catch (error) {
                        console.error('‚ùå Error creando publicaci√≥n:', error);

                        // Restaurar bot√≥n
                        publishPostBtn.disabled = false;
                        publishPostBtn.textContent = 'Publicar';
                        publishPostBtn.classList.add('enabled');

                        // Mostrar error al usuario
                        notifications.error('No se pudo crear la publicaci√≥n. Int√©ntalo de nuevo.');

                        // Como fallback, usar el m√©todo anterior de localStorage
                        console.log('‚ö†Ô∏è Usando fallback a localStorage...');
                        const newPost = {
                            id: Date.now(),
                            user:'T√∫',
                            avatar:'fas fa-user',
                            category:'general',
                            minutesAgo:0,
                            timeAgo: 'Ahora mismo',
                            timestamp: Date.now(),
                            content:txt,
                            comments:[],
                            reactions:{like:0, love:0, wow:0, laugh:0, sad:0, angry:0},
                            attachments: [...pendingAttachments],
                            reacted: null
                        };

                        posts.unshift(newPost);
                        savePosts();

                        // Limpiar formulario en fallback tambi√©n
                        composerInput.value='';
                        pendingAttachments = [];
                        document.getElementById('attachmentsPreview').innerHTML='';

                        renderPosts('all');
                    }
                });
            }
            // Funci√≥n auxiliar para obtener el usuario actual de manera consistente
            async function getCurrentUserForCommunity() {
                console.log('üîç Obteniendo usuario actual para operaciones de comunidad...');

                let currentUser = null;
                let userId = null;

                // M√âTODO 1: Usar PointsSystem si est√° disponible (m√°s confiable)
                if (window.pointsSystem) {
                    console.log('üéØ Obteniendo usuario desde PointsSystem...');
                    try {
                        currentUser = await window.pointsSystem.getCurrentUser();
                        if (currentUser && currentUser.id) {
                            userId = currentUser.id;
                            console.log('‚úÖ Usuario obtenido desde PointsSystem:', currentUser.name);
                            return { user: currentUser, id: userId };
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error con PointsSystem:', error);
                    }
                }

                // M√âTODO 2: Fallback a Supabase Auth
                if (!userId && window.supabase) {
                    console.log('üîÑ Fallback a Supabase Auth...');
                    try {
                        const { data: { session } } = await window.supabase.auth.getSession();
                        if (session && session.user) {
                            userId = session.user.id;
                            currentUser = {
                                id: session.user.id,
                                name: session.user.user_metadata?.full_name || session.user.email || 'Usuario',
                                email: session.user.email
                            };
                            console.log('‚úÖ Usuario obtenido desde Supabase session');
                            return { user: currentUser, id: userId };
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error con Supabase Auth:', error);
                    }
                }

                console.error('‚ùå No se pudo obtener el usuario con ning√∫n m√©todo');
                return { user: null, id: null };
            }

            // Funci√≥n para verificar autenticaci√≥n antes de operaciones de base de datos
            async function checkAuthenticationForPosts() {
                console.log('üîê Verificando autenticaci√≥n para posts...');
                try {
                    // M√âTODO 1: Verificar sesi√≥n de Supabase directamente (m√°s confiable)
                    if (window.supabase && window.supabase.auth) {
                        const { data: { session }, error } = await window.supabase.auth.getSession();
                        if (session && session.user) {
                            console.log('‚úÖ Usuario autenticado v√≠a Supabase session:', session.user.email);
                            return true;
                        }
                    }

                    // M√âTODO 2: Verificar localStorage (mismo m√©todo que usa el men√∫ de perfil)
                    const localStorageSources = ['currentUser', 'userData', 'user'];
                    for (const source of localStorageSources) {
                        try {
                            const data = localStorage.getItem(source);
                            if (data && data !== 'null' && data !== 'undefined') {
                                const user = JSON.parse(data);
                                if (user && (user.id || user.user_id || user.email)) {
                                    console.log(`‚úÖ Usuario autenticado v√≠a localStorage.${source}:`, user.email || user.id);
                                    return true;
                                }
                            }
                        } catch (parseError) {
                            continue;
                        }
                    }

                    // M√âTODO 3: Usar CommunityAuth si est√° disponible
                    if (window.CommunityAuth) {
                        const authResult = await window.CommunityAuth.getCurrentUserId();
                        if (authResult) {
                            console.log('‚úÖ Usuario autenticado v√≠a CommunityAuth:', authResult);
                            return true;
                        }
                    }

                    // M√âTODO 4: Verificar si puede acceder a comunidades (si est√° aqu√≠, probablemente est√© autenticado)
                    if (window.location.search.includes('slug=') && !window.location.search.includes('profesionales')) {
                        // Si est√° accediendo a una comunidad por invitaci√≥n, debe estar autenticado
                        console.log('‚úÖ Usuario autenticado (acceso a comunidad por invitaci√≥n)');
                        return true;
                    }

                    console.warn('‚ö†Ô∏è No se pudo verificar autenticaci√≥n con ning√∫n m√©todo');
                    return false;

                } catch (error) {
                    console.error('‚ùå Error verificando autenticaci√≥n:', error);
                    // En caso de error, asumir que est√° autenticado si puede acceder a la p√°gina
                    return true;
                }
            }

            // Inicializar carga de posts
            async function initializePosts() {
                console.log('üöÄ Inicializando sistema de posts...');

                // Verificar si CommunitySystem ya carg√≥ la comunidad
                if (window.communitySystem && window.communitySystem.currentCommunity) {
                    console.log('‚úÖ CommunitySystem ya tiene la comunidad cargada:', window.communitySystem.currentCommunity.name);
                } else {
                    console.log('‚ö†Ô∏è CommunitySystem no disponible a√∫n, el banner se encargar√° de cargar la comunidad');
                }

                // Intentar cargar desde base de datos primero
                try {
                    console.log('üìä Intentando cargar posts desde base de datos...');
                    await loadPostsFromDatabase();
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde BD, usando localStorage:', error);
                    loadPosts();
                    renderPosts('all');
                }

                // Verificar autenticaci√≥n para configurar el formulario
                const isAuthenticated = await checkAuthenticationForPosts();
                const composerInput = document.getElementById('composerInput');
                const publishPostBtn = document.getElementById('publishPostBtn');

                // Habilitar formulario por defecto (ya que el usuario puede acceder a la p√°gina)
                if (composerInput && publishPostBtn) {
                    console.log('‚úÖ Habilitando formulario de posts (usuario tiene acceso a la p√°gina)');
                    composerInput.disabled = false;
                    publishPostBtn.disabled = true; // Se habilita cuando escriban algo
                    publishPostBtn.textContent = 'Publicar';
                    composerInput.placeholder = 'Escribe algo para la comunidad...';

                    // Solo deshabilitar si definitivamente no hay autenticaci√≥n
                    if (!isAuthenticated && !window.supabase) {
                        console.warn('‚ö†Ô∏è Sin Supabase disponible - deshabilitando formulario');
                        composerInput.placeholder = 'Sistema no disponible...';
                        composerInput.disabled = true;
                        publishPostBtn.disabled = true;
                        publishPostBtn.textContent = 'No Disponible';
                    }
                }
            }

            // Cargar posts al inicializar
            initializePosts();

            // Funci√≥n de prueba para verificar contadores
            window.testCounters = function() {
                console.log('üß™ [TEST] Verificando contadores...');
                console.log('Posts cargados:', posts.length);
                posts.forEach((post, index) => {
                    console.log(`Post ${index + 1}:`, {
                        id: post.id,
                        user: post.user,
                        reactions: post.reactions,
                        comments: post.comments,
                        commentsLength: post.comments?.length || 0,
                        likeCount: post.reactions?.like || 0
                    });
                });
            };

            // Funci√≥n para forzar actualizaci√≥n de contadores
            window.updateCounters = function() {
                console.log('üîÑ [UPDATE] Actualizando contadores en el DOM...');
                posts.forEach(post => {
                    const reactionCountEl = document.querySelector(`[data-id="${post.id}"] .reaction-count`);
                    const commentCountEl = document.querySelector(`[data-id="${post.id}"] .comment-count`);
                    
                    if (reactionCountEl) {
                        const totalReactions = post.totalReactions || Object.values(post.reactions || {}).reduce((sum, count) => sum + count, 0);
                        reactionCountEl.textContent = totalReactions;
                        console.log(`‚úÖ Actualizado contador de reacciones para post ${post.id}: ${totalReactions}`);
                    }
                    
                    if (commentCountEl) {
                        const commentCount = post.comments?.length || 0;
                        commentCountEl.textContent = commentCount;
                        console.log(`‚úÖ Actualizado contador de comentarios para post ${post.id}: ${commentCount}`);
                    }
                });
            };

            // Funci√≥n para actualizar contadores despu√©s de cerrar modal
            window.updateCountersAfterModal = function() {
                console.log('üîÑ [MODAL CLOSE] Actualizando contadores despu√©s de cerrar modal...');
                setTimeout(() => {
                    updateCounters();
                }, 100);
            };

    // Funci√≥n para preservar contadores al abrir modal
    window.preserveCountersOnModalOpen = function(postId) {
        console.log('üîÑ [MODAL OPEN] Preservando contadores para post:', postId);
        const post = posts.find(p => p.id === postId);
        if (post) {
            // Asegurar que el total de reacciones est√© calculado
            if (!post.totalReactions) {
                post.totalReactions = Object.values(post.reactions || {}).reduce((sum, count) => sum + count, 0);
            }
            console.log('‚úÖ Contadores preservados - Total reacciones:', post.totalReactions, 'Comentarios:', post.comments?.length || 0);
        }
    };

    // Funci√≥n para actualizar contadores en tiempo real
    window.updateReactionCounters = function(postId) {
        console.log('üîÑ [REALTIME] Actualizando contadores para post:', postId);
        const post = posts.find(p => p.id === postId);
        if (!post) {
            console.error('‚ùå [REALTIME] Post no encontrado:', postId);
            return;
        }

        // Actualizar contador de reacciones
        const reactionCountEl = document.querySelector(`[data-id="${postId}"] .reaction-count`);
        if (reactionCountEl) {
            reactionCountEl.textContent = post.totalReactions || 0;
            console.log('‚úÖ [REALTIME] Contador de reacciones actualizado:', post.totalReactions);
        }

        // Actualizar texto del bot√≥n seg√∫n la reacci√≥n
        const btnTextEl = document.querySelector(`[data-id="${postId}"] .btn-text`);
        if (btnTextEl) {
            const reactionTexts = {
                'like': 'Me gusta',
                'love': 'Me encanta',
                'wow': 'Me asombra',
                'laugh': 'Me divierte',
                'sad': 'Me entristece',
                'angry': 'Me enoja'
            };
            btnTextEl.textContent = post.reacted ? reactionTexts[post.reacted] || 'Me gusta' : 'Me gusta';
        }

        // Actualizar clase del bot√≥n
        const buttonEl = document.querySelector(`[data-id="${postId}"]`);
        if (buttonEl) {
            if (post.reacted) {
                buttonEl.classList.add('reacted');
            } else {
                buttonEl.classList.remove('reacted');
            }
        }

        console.log('‚úÖ [REALTIME] Contadores actualizados para post:', postId);
    };

            // Funci√≥n de debug espec√≠fica para verificar datos de posts
            window.debugPostData = function() {
                console.log('üîç [DEBUG] Verificando datos de posts...');
                console.log('Total de posts:', posts.length);
                
                posts.forEach((post, index) => {
                    console.log(`\nüìù Post ${index + 1} (ID: ${post.id}):`);
                    console.log('  - User:', post.user);
                    console.log('  - Reactions object:', post.reactions);
                    console.log('  - Like count:', post.reactions?.like || 0);
                    console.log('  - Comments array:', post.comments);
                    console.log('  - Comments length:', post.comments?.length || 0);
                    
                    // Verificar elementos en el DOM
                    const reactionCountEl = document.querySelector(`[data-id="${post.id}"] .reaction-count`);
                    const commentCountEl = document.querySelector(`[data-id="${post.id}"] .comment-count`);
                    
                    console.log('  - DOM reaction count element:', reactionCountEl);
                    console.log('  - DOM reaction count text:', reactionCountEl?.textContent);
                    console.log('  - DOM comment count element:', commentCountEl);
                    console.log('  - DOM comment count text:', commentCountEl?.textContent);
                });
            };

            // Variable GLOBAL para almacenar miembros
            window.members = [];
            var members = window.members; // Referencia local para compatibilidad

            // Funci√≥n para inicializar miembros
            async function initializeMembers() {
                console.log('üöÄ [MEMBERS] Inicializando sistema de miembros...');

                try {
                    // Intentar cargar desde base de datos
                    await loadMembersFromDatabase();
                    console.log('‚úÖ [MEMBERS] Miembros cargados desde base de datos');
                } catch (error) {
                    console.warn('‚ö†Ô∏è [MEMBERS] Error cargando desde BD, usando array vac√≠o:', error);
                    window.members.length = 0;
                    window.renderMembers('all', '');
                }

                console.log('‚úÖ [MEMBERS] Inicializaci√≥n de miembros completada');
            }

            // NO cargar miembros aqu√≠ - el CommunitySystem se encargar√°
            // initializeMembers();

            // Funci√≥n para cargar miembros desde la base de datos
            async function loadMembersFromDatabase() {
                console.log('üöÄ [MEMBERS] Cargando miembros desde BD...');
                try {
                    // Obtener community ID desde URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const communitySlug = urlParams.get('slug') || 'profesionales';

                    // Mapeo de slugs conocidos
                    const communityMap = {
                        'profesionales': '7886aa14-35b9-41da-b099-29f11ad3516b',
                        'sif-icap': 'aa5a4c4c-ce64-4a12-b1ef-365aa0d320c8',
                        'openminder': 'b3b154e1-110e-4aa7-8998-ef208482a159',
                        'ecos-de-liderazgo': 'd2dbebb1-5b57-4da7-9fc6-8b40c732b548'
                    };

                    const communityId = communityMap[communitySlug];
                    if (!communityId) {
                        console.warn('‚ö†Ô∏è [MEMBERS] Community ID no encontrado para slug:', communitySlug);
                        return;
                    }

                    console.log('üë• [MEMBERS] Cargando miembros de communityId:', communityId);

                    // Esperar a que Supabase est√© disponible
                    const supabaseReady = await window.waitForSupabase();
                    if (!supabaseReady) {
                        throw new Error('Supabase no se pudo inicializar para miembros');
                    }

                    // Consultar miembros con datos de usuario
                    const { data: dbMembers, error } = await window.supabase
                        .from('community_members')
                        .select(`
                            *,
                            users:user_id (
                                id,
                                email,
                                display_name,
                                first_name,
                                last_name,
                                username,
                                profile_picture_url,
                                created_at
                            )
                        `)
                        .eq('community_id', communityId)
                        .eq('is_active', true)
                        .order('joined_at', { ascending: false });

                    if (error) {
                        throw new Error(`Supabase error al cargar miembros: ${error.message}`);
                    }

                    console.log('üë• [MEMBERS] Miembros obtenidos de Supabase:', dbMembers);
                    console.log('üë• [MEMBERS] Cantidad de miembros encontrados:', dbMembers ? dbMembers.length : 0);

                    if (!dbMembers || dbMembers.length === 0) {
                        console.log('‚ö†Ô∏è [MEMBERS] No se encontraron miembros para esta comunidad');
                        window.members.length = 0;
                        return;
                    }

                    // Convertir miembros al formato esperado por la UI
                    members = dbMembers.map(member => {
                        const user = member.users;

                        // Calcular tiempo desde que se uni√≥
                        const joinedDate = new Date(member.joined_at || member.created_at);
                        const now = new Date();
                        const diffMs = now - joinedDate;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                        // Estado online real se maneja por el sistema de presencia
                        const isOnline = false; // Se actualiza por presencia real

                        return {
                            id: member.id || user?.id,
                            name: user?.display_name || user?.first_name || user?.username || user?.email?.split('@')[0] || 'Usuario',
                            email: user?.email,
                            online: isOnline,
                            admin: member.role === 'admin' || member.role === 'moderator',
                            location: user?.user_metadata?.location || 'No especificado',
                            joined: member.joined_at || member.created_at,
                            lastSeen: 'Calculando...',
                            avatar: user?.profile_picture_url || 'fas fa-user',
                            status: isOnline ? 'online' : 'offline',
                            // Datos adicionales
                            user_id: user?.id,
                            community_id: member.community_id,
                            role: member.role || 'member'
                        };
                    });

                    console.log('‚úÖ [MEMBERS] Miembros convertidos para UI:', members);

                    // Re-renderizar miembros
                    const activeChip = document.querySelector('.members-chip.active');
                    const activeFilter = activeChip ? activeChip.dataset.filter : 'all';
                    const searchQuery = document.getElementById('viewSearch')?.value || '';
                    renderMembers(activeFilter, searchQuery);

                } catch (error) {
                    console.error('‚ùå [MEMBERS] Error cargando miembros desde BD:', error);
                    // Fallback a array vac√≠o
                    window.members.length = 0;
                    window.renderMembers('all', '');
                }
            }

            // Los miembros ahora se cargan solo desde la base de datos
            function generateRealisticMembers() {
                // Funci√≥n vac√≠a - los miembros se cargan desde la base de datos
                return [];
            }
            
            const mockMembers = []; // Mantener por compatibilidad, pero se usar√° members[]
            
            // Funci√≥n para simular actividad real en la comunidad
            function simulateCommunityActivity() {
                // Ocasionalmente agregar un nuevo miembro
                if (Math.random() < 0.05 && mockMembers.length < 50) { // 5% de probabilidad
                    const newNames = [
                        'Luc√≠a Fern√°ndez', 'Mateo R√≠os', 'Valeria Cruz', 'Sebasti√°n Mora',
                        'Emma Torres', 'Lucas Herrera', 'Sara Jim√©nez', 'Adri√°n Vega'
                    ];
                    
                    const newMember = {
                        id: mockMembers.length + 1,
                        name: newNames[Math.floor(Math.random() * newNames.length)],
                        online: true,
                        admin: false,
                        location: ['Ciudad de M√©xico', 'Buenos Aires', 'Bogot√°', 'Santiago'][Math.floor(Math.random() * 4)],
                        joined: new Date().toISOString().split('T')[0],
                        lastSeen: 'Ahora',
                        avatar: 'fas fa-user',
                        status: 'online'
                    };
                    
                    mockMembers.push(newMember);
                    
                    // Mostrar notificaci√≥n de nuevo miembro
                    if (document.getElementById('tab-members').style.display !== 'none') {
                        notifications.info(`¬°${newMember.name} se uni√≥ a la comunidad!`);
                    }
                }
                
                // Simular actividad de posts (ocasionalmente)
                if (Math.random() < 0.02) { // 2% de probabilidad
                    const activityMessages = [
                        'Alguien reaccion√≥ a una publicaci√≥n',
                        'Nuevo comentario en la comunidad',
                        'Se comparti√≥ un recurso interesante'
                    ];
                    
                    const message = activityMessages[Math.floor(Math.random() * activityMessages.length)];
                    notifications.info(message);
                }
            }
            
            // Ejecutar simulaci√≥n de actividad cada 2 minutos
            setInterval(simulateCommunityActivity, 120000);
            window.renderMembers = function renderMembers(filter='all', q=''){
                console.log('üé® [RENDER] renderMembers llamada con:', { filter, q });
                console.log('üîç [RENDER] Variable members:', {
                    exists: typeof members !== 'undefined',
                    isArray: Array.isArray(members),
                    length: members?.length || 0,
                    value: members
                });
                console.log('üîç [RENDER] window.members:', {
                    exists: typeof window.members !== 'undefined',
                    isArray: Array.isArray(window.members),
                    length: window.members?.length || 0,
                    value: window.members
                });

                const list = document.getElementById('membersList');
                console.log('üîç [RENDER] membersList container:', list);

                let data = [...members];
                
                // Estados online reales se manejan por el sistema de presencia
                // Ya no hay simulaci√≥n de estados aleatorios
                
                if(filter==='online') data = data.filter(m=>m.online);
                if(filter==='admins') data = data.filter(m=>m.admin);
                if(q) data = data.filter(m => (m.name+ ' ' + m.location).toLowerCase().includes(q.toLowerCase()));
                
                // Ordenar: online primero, luego por nombre
                data.sort((a, b) => {
                    if (a.online && !b.online) return -1;
                    if (!a.online && b.online) return 1;
                    return a.name.localeCompare(b.name);
                });

                console.log('üîç [RENDER] data despu√©s de ordenar:', data);
                console.log('üîç [RENDER] Generando HTML...');
                
                list.innerHTML = data.map(m=>`
                    <div class="member-card" data-user-id="${m.id || m.user_id}" style="cursor: pointer;">
                        <div class="member-avatar">
                            ${m.avatar && m.avatar !== 'fas fa-user' && (m.avatar.startsWith('http') || m.avatar.startsWith('data:')) ?
                                `<img src="${m.avatar}" alt="${m.name}" class="member-avatar-img" onerror="this.src='../assets/images/default-avatar.svg'; this.onerror=null;">` :
                                `<i class="fas fa-user"></i>`
                            }
                            ${m.online ? '<span class="member-status"></span>' : ''}
                        </div>
                        <div class="member-info">
                            <div class="member-name">
                                ${m.name} 
                                ${m.admin ? '<span class="member-badge admin">Admin</span>':''}
                                ${m.online ? '<span class="member-badge online">En l√≠nea</span>':''}
                            </div>
                            <div class="member-meta">
                                <div class="member-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${m.location}</span>
                            </div>
                                <div class="member-status-text" style="display: none;">
                                    ${m.online ? '<i class="fas fa-circle online-dot"></i>' : '<i class="fas fa-clock"></i>'}
                                    <span>${m.online ? 'En l√≠nea' : `Visto ${m.lastSeen}`}</span>
                                </div>
                                <div class="member-joined">
                                    <i class="fas fa-calendar"></i>
                                    <span>Se uni√≥ ${formatJoinDate(m.joined)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                console.log('‚úÖ [RENDER] HTML asignado al contenedor');
                console.log('üîç [RENDER] list.innerHTML length:', list.innerHTML?.length || 0);
                console.log('üîç [RENDER] Cantidad de miembros renderizados:', data.length);
                
                // Mostrar contador de miembros
                const onlineCount = data.filter(m => m.online).length;
                const totalCount = data.length;
                const membersHeader = document.querySelector('.members-section .container');
                if (membersHeader && !document.querySelector('.members-count')) {
                    const countElement = document.createElement('div');
                    countElement.className = 'members-count';
                    countElement.innerHTML = `
                       <div class="count-info">
                            <span class="online-count">${onlineCount} en l√≠nea</span>
                            <span class="total-count">‚Ä¢ ${totalCount} miembros total</span>
                        </div>
                    `;
                    membersHeader.insertBefore(countElement, membersHeader.firstChild);
                } else if (document.querySelector('.members-count')) {
                    const countElement = document.querySelector('.members-count');
                    countElement.innerHTML = `
                        <div class="count-info">
                            <span class="online-count">${onlineCount} en l√≠nea</span>
                            <span class="total-count">‚Ä¢ ${totalCount} miembros total</span>
                        </div>
                    `;
                }
            }
            
            // Funci√≥n para formatear fechas de uni√≥n
            function formatJoinDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) return 'hoy';
                if (diffDays <= 7) return `hace ${diffDays} d√≠as`;
                if (diffDays <= 30) return `hace ${Math.floor(diffDays / 7)} semanas`;
                if (diffDays <= 365) return `hace ${Math.floor(diffDays / 30)} meses`;
                return `hace ${Math.floor(diffDays / 365)} a√±os`;
            }
            document.querySelectorAll('.members-chip').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    document.querySelectorAll('.members-chip').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    window.renderMembers(btn.dataset.filter, document.getElementById('viewSearch').value);
                });
            });
            const search = document.getElementById('viewSearch');
             let searchTimeout;
             
            search.addEventListener('input', ()=>{
                 clearTimeout(searchTimeout);
                 searchTimeout = setTimeout(() => {
                const active = document.querySelector('.members-chip.active');
                window.renderMembers(active?active.dataset.filter:'all', search.value);
                 }, 300); // Debounce de 300ms
             });
             
             // B√∫squeda en posts
             search.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                     const query = search.value.trim();
                     if (query) {
                         // Cambiar a la pesta√±a de comunidad y buscar en posts
                         document.querySelectorAll('.subnav-link').forEach(btn => btn.classList.remove('active'));
                         document.querySelector('[data-tab="community"]').classList.add('active');
                         document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
                         document.getElementById('tab-community').style.display = 'block';
                         
                         // Filtrar posts por b√∫squeda
                         const filteredPosts = posts.filter(post => 
                             post.content.toLowerCase().includes(query.toLowerCase()) ||
                             post.user.toLowerCase().includes(query.toLowerCase()) ||
                             post.category.toLowerCase().includes(query.toLowerCase())
                         );
                         
                         // Mostrar resultados
                         const list = document.getElementById('postsList');
                         if (filteredPosts.length > 0) {
                             list.innerHTML = filteredPosts.map(p => `
                                 <div class="post-card" data-open-post="${p.id}">
                                     <div class="post-avatar">
                                         ${p.avatarUrl ?
                                             `<img src="${p.avatarUrl}" alt="${p.user}" class="post-avatar-img" onerror="console.warn('‚ö†Ô∏è Avatar de post filtrado no se pudo cargar'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                              <i class="${p.avatar}" style="display:none;"></i>` :
                                             `<i class="${p.avatar}"></i>`
                                         }
                                     </div>
                                     <div class="post-body">
                                         <div class="post-header">
                                             <span class="post-name">${p.user}</span>
                                             <span class="post-meta">‚Ä¢ ${p.timeAgo || `${p.minutesAgo} min`} ‚Ä¢ ${p.category}</span>
                                         </div>
                                         <div class="post-content">${p.content}</div>
                                         ${renderAttachments(p.attachments)}
                                         <div class="post-actions">
                                             <span class="post-action" data-action="comment" data-id="${p.id}"><i class="fas fa-comment"></i> Comentar</span>
                                             <span class="post-action shares" data-share="${p.id}"><i class="fas fa-share"></i> Compartir</span>
                                             <span class="react-area">
                                                 <button class="react-btn ${p.reacted ? 'reacted' : ''}" data-react-toggle="${p.id}" title="${p.reacted ? 'Ya reaccionaste con ' + (p.reacted === 'like' ? 'üëç' : p.reacted === 'love' ? '‚ù§Ô∏è' : p.reacted === 'wow' ? 'üòÆ' : p.reacted === 'laugh' ? 'üòÇ' : p.reacted === 'sad' ? 'üò¢' : 'üò†') : 'Reaccionar'}">
                                                     ${p.reacted ? (p.reacted === 'like' ? 'üëç' : p.reacted === 'love' ? '‚ù§Ô∏è' : p.reacted === 'wow' ? 'üòÆ' : p.reacted === 'laugh' ? 'üòÇ' : p.reacted === 'sad' ? 'üò¢' : p.reacted === 'angry' ? 'üò†' : 'üëç') : 'üëç'}
                                                 </button>
                                                 <div class="reaction-picker" id="picker-${p.id}">
                                                     <div class="reaction-item" data-react="like" data-id="${p.id}">üëç</div>
                                                     <div class="reaction-item" data-react="love" data-id="${p.id}">‚ù§Ô∏è</div>
                                                     <div class="reaction-item" data-react="wow" data-id="${p.id}">üòÆ</div>
                                                     <div class="reaction-item" data-react="laugh" data-id="${p.id}">üòÇ</div>
                                                     <div class="reaction-item" data-react="sad" data-id="${p.id}">üò¢</div>
                                                     <div class="reaction-item" data-react="angry" data-id="${p.id}">üò†</div>
                                                 </div>
                                                 <span class="reaction-summary">${reactionSummary(p.reactions)}</span>
                                             </span>
                                         </div>
                                     </div>
                                 </div>
                             `).join('');
                             
                             notifications.info(`Se encontraron ${filteredPosts.length} resultados para "${query}"`);
                         } else {
                             list.innerHTML = `
                                 <div class="no-results">
                                     <i class="fas fa-search"></i>
                                     <h3>No se encontraron resultados</h3>
                                     <p>No hay posts que coincidan con "${query}"</p>
                                 </div>
                             `;
                         }
                     }
                 }
            });
            window.renderMembers();
            
            // Actualizar estados de miembros din√°micamente
            setInterval(() => {
                // Simular cambios de estado online/offline
                mockMembers.forEach(member => {
                    if (Math.random() < 0.1) { // 10% de probabilidad de cambiar estado
                        member.online = !member.online;
                        if (!member.online) {
                            member.lastSeen = 'Ahora';
                        }
                    }
                });
                
                // Re-renderizar si estamos en la pesta√±a de miembros
                const membersSection = document.getElementById('tab-members');
                if (membersSection && membersSection.style.display !== 'none') {
                    const activeFilter = document.querySelector('.members-chip.active')?.dataset.filter || 'all';
                    window.renderMembers(activeFilter, document.getElementById('viewSearch').value);
                }
            }, 30000); // Cada 30 segundos

            // Enhanced Chat System
            class ChatSystem {
                constructor() {
                    this.messages = [];
                    this.isTyping = false;
                    this.typingTimeout = null;
                    this.settings = {
                        notifications: true,
                        sounds: true,
                        typingIndicator: true,
                        autoScroll: true
                    };
                    this.currentUser = this.getCurrentUser();
                    this.init();
                }

                init() {
                    this.loadSettings();
                    this.setupEventListeners();
                    this.loadMessages();
                    this.setupEmojiPicker();
                    this.startTypingSimulation();
                }

                getCurrentUser() {
                    try {
                        const userProfile = localStorage.getItem('userProfile');
                        const avatarData = localStorage.getItem('avatarData');
                        
                        let avatar = null;
                        if (avatarData) {
                            const avatarObj = JSON.parse(avatarData);
                            if (avatarObj && avatarObj.dataUrl) {
                                avatar = avatarObj.dataUrl;
                            }
                        }

                        return {
                            id: Date.now(),
                            name: userProfile ? JSON.parse(userProfile).display_name || 'Usuario' : 'Usuario',
                            avatar: avatar,
                            isOnline: true
                        };
                    } catch (e) {
                        return {
                            id: Date.now(),
                            name: 'Usuario',
                            avatar: null,
                            isOnline: true
                        };
                    }
                }

                loadSettings() {
                    const saved = localStorage.getItem('chatSettings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                    this.applySettings();
                }

                applySettings() {
                    document.getElementById('chatNotifications').checked = this.settings.notifications;
                    document.getElementById('chatSounds').checked = this.settings.sounds;
                    document.getElementById('chatTypingIndicator').checked = this.settings.typingIndicator;
                    document.getElementById('chatAutoScroll').checked = this.settings.autoScroll;
                }

                setupEventListeners() {
                    // Chat panel controls
                    document.getElementById('openChat').addEventListener('click', () => this.openChat());
                    document.getElementById('closeChat').addEventListener('click', () => this.closeChat());
                    document.getElementById('chatSettings').addEventListener('click', () => this.openSettings());
                    document.getElementById('closeChatSettings').addEventListener('click', () => this.closeSettings());
                     
                     // Exportar datos
                     document.getElementById('exportData').addEventListener('click', () => this.exportData());

                    // Message input
                    const chatInput = document.getElementById('chatInput');
                    const chatSend = document.getElementById('chatSend');
                    
                    chatInput.addEventListener('input', (e) => {
                        this.updateInputCounter(e.target.value.length);
                        this.toggleSendButton(e.target.value.trim().length > 0);
                        this.handleTyping();
                    });

                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    chatSend.addEventListener('click', () => this.sendMessage());

                    // Emoji picker
                    document.getElementById('chatEmojiBtn').addEventListener('click', () => this.toggleEmojiPicker());
                    document.getElementById('closeEmojiPicker').addEventListener('click', () => this.closeEmojiPicker());

                    // Settings
                    document.getElementById('chatNotifications').addEventListener('change', (e) => {
                        this.settings.notifications = e.target.checked;
                        this.saveSettings();
                    });

                    document.getElementById('chatSounds').addEventListener('change', (e) => {
                        this.settings.sounds = e.target.checked;
                        this.saveSettings();
                    });

                    document.getElementById('chatTypingIndicator').addEventListener('change', (e) => {
                        this.settings.typingIndicator = e.target.checked;
                        this.saveSettings();
                    });

                    document.getElementById('chatAutoScroll').addEventListener('change', (e) => {
                        this.settings.autoScroll = e.target.checked;
                        this.saveSettings();
                    });

                    // Close modals when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#emojiPicker') && !e.target.closest('#chatEmojiBtn')) {
                            this.closeEmojiPicker();
                        }
                        if (!e.target.closest('#chatSettingsModal') && !e.target.closest('#chatSettings')) {
                            this.closeSettings();
                        }
                    });
                }

                openChat() {
                    const chatPanel = document.getElementById('chatPanel');
                    chatPanel.classList.add('show');
                    document.getElementById('chatInput').focus();
                    this.hideNotification();
                }

                closeChat() {
                    document.getElementById('chatPanel').classList.remove('show');
                }

                openSettings() {
                    document.getElementById('chatSettingsModal').classList.add('show');
                }

                closeSettings() {
                    document.getElementById('chatSettingsModal').classList.remove('show');
                }

                updateInputCounter(length) {
                    document.getElementById('chatInputCounter').textContent = `${length}/500`;
                }

                toggleSendButton(enabled) {
                    const sendBtn = document.getElementById('chatSend');
                    sendBtn.disabled = !enabled;
                    sendBtn.classList.toggle('enabled', enabled);
                }

                handleTyping() {
                    if (!this.settings.typingIndicator) return;
                    
                    if (this.typingTimeout) {
                        clearTimeout(this.typingTimeout);
                    }
                    
                    this.typingTimeout = setTimeout(() => {
                        this.stopTyping();
                    }, 3000);
                }

                startTyping() {
                    if (!this.settings.typingIndicator) return;
                    this.isTyping = true;
                    document.getElementById('typingIndicator').style.display = 'flex';
                }

                stopTyping() {
                    this.isTyping = false;
                    document.getElementById('typingIndicator').style.display = 'none';
                }

                sendMessage() {
                    const input = document.getElementById('chatInput');
                    const text = input.value.trim();
                    
                    if (!text) return;

                    const message = {
                        id: Date.now(),
                        text: text,
                        user: this.currentUser,
                        timestamp: new Date(),
                        type: 'text'
                    };

                    this.addMessage(message);
                    input.value = '';
                    this.updateInputCounter(0);
                    this.toggleSendButton(false);
                    this.stopTyping();

                    // Simulate response
                    setTimeout(() => {
                        this.simulateResponse();
                    }, 1000 + Math.random() * 2000);
                }

                addMessage(message) {
                    this.messages.push(message);
                    this.renderMessage(message);
                    this.saveMessages();
                    
                    if (this.settings.autoScroll) {
                        this.scrollToBottom();
                    }

                    if (this.settings.sounds) {
                        this.playMessageSound();
                    }
                }

                renderMessage(message) {
                    const messagesContainer = document.getElementById('chatMessages');
                    const welcome = document.getElementById('chatWelcome');
                    
                    if (welcome.style.display !== 'none') {
                        welcome.style.display = 'none';
                        messagesContainer.style.display = 'block';
                    }

                    const messageEl = document.createElement('div');
                    messageEl.className = `chat-msg ${message.user.id === this.currentUser.id ? 'own' : ''}`;
                    messageEl.dataset.messageId = message.id;

                    const time = this.formatTime(message.timestamp);
                    const avatar = message.user.avatar ? 
                        `<img src="${message.user.avatar}" alt="${message.user.name}" class="chat-user-avatar">` :
                        `<i class="fas fa-user chat-user-avatar-icon"></i>`;

                    messageEl.innerHTML = `
                        <div class="chat-msg-header">
                            <div class="chat-msg-avatar">${avatar}</div>
                            <div class="chat-msg-info">
                                <span class="chat-msg-user">${message.user.name}</span>
                                <span class="chat-msg-time">${time}</span>
                            </div>
                        </div>
                        <div class="chat-msg-content">${this.formatMessage(message.text)}</div>
                    `;

                    messagesContainer.appendChild(messageEl);
                }

                formatMessage(text) {
                    // Convert URLs to links
                    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="chat-link">$1</a>');
                    
                    // Convert emojis (basic support)
                    text = text.replace(/:\)/g, 'üòä')
                               .replace(/:\(/g, 'üò¢')
                               .replace(/;\)/g, 'üòâ')
                               .replace(/:D/g, 'üòÑ')
                               .replace(/:P/g, 'üòõ');
                    
                    return text;
                }

                formatTime(date) {
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    
                    if (minutes < 1) return 'Ahora';
                    if (minutes < 60) return `Hace ${minutes} min`;
                    
                    return date.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }

                scrollToBottom() {
                    const chatBody = document.getElementById('chatBody');
                    setTimeout(() => {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }, 100);
                }

                playMessageSound() {
                    // Simple beep sound using Web Audio API
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.1);
                    } catch (e) {
                        console.log('Audio not supported');
                    }
                }

                showNotification() {
                    if (!this.settings.notifications) return;
                    
                    const notification = document.getElementById('chatNotification');
                    const currentCount = parseInt(notification.textContent) || 0;
                    notification.textContent = currentCount + 1;
                    notification.style.display = 'inline-block';
                }

                hideNotification() {
                    document.getElementById('chatNotification').style.display = 'none';
                }

                simulateResponse() {
                    const responses = [
                        '¬°Excelente punto! üëç',
                        'Gracias por compartir eso',
                        'Interesante perspectiva',
                        '¬øAlguien m√°s tiene experiencia con esto?',
                        '¬°Muy √∫til!',
                        'Completamente de acuerdo',
                        '¬øPodr√≠as explicar m√°s sobre eso?',
                        '¬°Genial idea!'
                    ];

                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    const message = {
                        id: Date.now(),
                        text: randomResponse,
                        user: {
                            id: 'other',
                            name: ['Ana', 'Carlos', 'Mar√≠a', 'Luis', 'Sofia'][Math.floor(Math.random() * 5)],
                            avatar: null,
                            isOnline: true
                        },
                        timestamp: new Date(),
                        type: 'text'
                    };

                    this.addMessage(message);
                }

                startTypingSimulation() {
                    setInterval(() => {
                        if (Math.random() < 0.1 && this.messages.length > 0) {
                            this.startTyping();
                            setTimeout(() => {
                                this.stopTyping();
                                this.simulateResponse();
                            }, 2000 + Math.random() * 3000);
                        }
                    }, 10000);
                }

                setupEmojiPicker() {
                    const emojis = {
                        recent: ['üòä', 'üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ'],
                        smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö'],
                        animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ'],
                        food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù'],
                        activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë'],
                        travel: ['‚úàÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'üõ¥'],
                        objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé'],
                        symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó']
                    };

                    const emojiGrid = document.getElementById('emojiGrid');
                    let currentCategory = 'recent';

                    // Populate emoji grid
                    function showEmojis(category) {
                        emojiGrid.innerHTML = emojis[category].map(emoji => 
                            `<button class="emoji-item" data-emoji="${emoji}">${emoji}</button>`
                        ).join('');
                    }

                    // Category switching
                    document.querySelectorAll('.emoji-category').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.emoji-category').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            currentCategory = btn.dataset.category;
                            showEmojis(currentCategory);
                        });
                    });

                    // Emoji selection
                    emojiGrid.addEventListener('click', (e) => {
                        if (e.target.classList.contains('emoji-item')) {
                            const emoji = e.target.dataset.emoji;
                            const input = document.getElementById('chatInput');
                            input.value += emoji;
                            input.focus();
                            this.closeEmojiPicker();
                            this.updateInputCounter(input.value.length);
                            this.toggleSendButton(input.value.trim().length > 0);
                        }
                    });

                    showEmojis('recent');
                }

                toggleEmojiPicker() {
                    const picker = document.getElementById('emojiPicker');
                    picker.classList.toggle('show');
                }

                closeEmojiPicker() {
                    document.getElementById('emojiPicker').classList.remove('show');
                }

                loadMessages() {
                    const saved = localStorage.getItem('communityChatMessages');
                    if (saved) {
                        try {
                            this.messages = JSON.parse(saved);
                            this.messages.forEach(msg => this.renderMessage(msg));
                        } catch (e) {
                            console.log('Error loading messages:', e);
                        }
                    }
                }

                saveMessages() {
                    localStorage.setItem('communityChatMessages', JSON.stringify(this.messages));
                }

                saveSettings() {
                    localStorage.setItem('chatSettings', JSON.stringify(this.settings));
                }
                 
                 exportData() {
                     const data = {
                         posts: posts,
                         chatMessages: this.messages,
                         settings: this.settings,
                         exportDate: new Date().toISOString(),
                         version: '1.0'
                     };
                     
                     const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `community-data-${new Date().toISOString().split('T')[0]}.json`;
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);
                     
                     notifications.success('Datos exportados exitosamente');
                 }
            }

            // Initialize chat system
            const chatSystem = new ChatSystem();

            // Manejo de modales de entrada personalizados
            function setupInputModals() {
                // Modal de enlace
                const linkModal = document.getElementById('linkModal');
                const linkInput = document.getElementById('linkInput');
                const confirmLink = document.getElementById('confirmLink');
                const cancelLink = document.getElementById('cancelLink');
                const closeLinkModal = document.getElementById('closeLinkModal');

                function closeLinkModalFunc() {
                    linkModal.classList.remove('show');
                    linkInput.value = '';
                }

                if (confirmLink) {
                confirmLink.addEventListener('click', () => {
                        console.log('Bot√≥n confirmar enlace clickeado');
                    const url = linkInput.value.trim();
                        console.log('URL ingresada:', url);
                    if (url) {
                            try {
                                // Validar URL
                                new URL(url);
                                console.log('URL v√°lida, agregando adjunto');
                        pendingAttachments.push({ type: 'link', url });
                        addPreviewLink(url);
                        closeLinkModalFunc();
                                                         } catch (e) {
                                 console.log('URL inv√°lida:', e);
                                 notifications.error('Por favor ingresa una URL v√°lida (ej: https://ejemplo.com)');
                             }
                         } else {
                             console.log('URL vac√≠a');
                             notifications.warning('Por favor ingresa una URL');
                         }
                    });
                }

                if (cancelLink) {
                cancelLink.addEventListener('click', closeLinkModalFunc);
                }
                if (closeLinkModal) {
                closeLinkModal.addEventListener('click', closeLinkModalFunc);
                }
                if (linkModal) {
                linkModal.addEventListener('click', (e) => {
                    if (e.target === linkModal) closeLinkModalFunc();
                });
                }

                // Modal de YouTube
                const youtubeModal = document.getElementById('youtubeModal');
                const youtubeInput = document.getElementById('youtubeInput');
                const confirmYoutube = document.getElementById('confirmYoutube');
                const cancelYoutube = document.getElementById('cancelYoutube');
                const closeYoutubeModal = document.getElementById('closeYoutubeModal');

                function closeYoutubeModalFunc() {
                    youtubeModal.classList.remove('show');
                    youtubeInput.value = '';
                }

                if (confirmYoutube) {
                confirmYoutube.addEventListener('click', () => {
                    const ytUrl = youtubeInput.value.trim();
                    console.log('üöÄ Bot√≥n YouTube confirmado. URL ingresada:', ytUrl);
                    
                    if (ytUrl) {
                        const embed = youtubeEmbed(ytUrl);
                        console.log('üé• Resultado de youtubeEmbed:', embed);
                        
                        if (embed) {
                            console.log('‚úÖ URL v√°lida, agregando adjunto');
                            pendingAttachments.push({ type: 'video', embed, isYoutube: true });
                            addPreviewYoutube(embed);
                            closeYoutubeModalFunc();
                        } else {
                            console.log('‚ùå URL inv√°lida, mostrando error');
                            notifications.error('Enlace de YouTube inv√°lido. Aseg√∫rate de que sea una URL v√°lida de YouTube');
                        }
                    } else {
                        console.log('‚ö†Ô∏è URL vac√≠a');
                        notifications.warning('Por favor ingresa una URL de YouTube');
                    }
                });
                }

                if (cancelYoutube) {
                cancelYoutube.addEventListener('click', closeYoutubeModalFunc);
                }
                if (closeYoutubeModal) {
                closeYoutubeModal.addEventListener('click', closeYoutubeModalFunc);
                }
                if (youtubeModal) {
                youtubeModal.addEventListener('click', (e) => {
                    if (e.target === youtubeModal) closeYoutubeModalFunc();
                });
                }


                // Modal de encuesta
                const pollModal = document.getElementById('pollModal');
                const pollQuestion = document.getElementById('pollQuestion');
                const pollOptions = document.getElementById('pollOptions');
                const confirmPoll = document.getElementById('confirmPoll');
                const cancelPoll = document.getElementById('cancelPoll');
                const closePollModal = document.getElementById('closePollModal');

                function closePollModalFunc() {
                    pollModal.classList.remove('show');
                    pollQuestion.value = '';
                    pollOptions.value = '';
                }

                if (confirmPoll) {
                confirmPoll.addEventListener('click', () => {
                    const question = pollQuestion.value.trim();
                    const options = pollOptions.value.trim();
                    if (question && options) {
                        const pollOptionsArray = options.split(',').map(opt => opt.trim()).filter(opt => opt);
                        if (pollOptionsArray.length >= 2) {
                            pendingAttachments.push({ 
                                type: 'poll', 
                                question, 
                                options: pollOptionsArray 
                            });
                            addPreviewPoll(question, pollOptionsArray);
                            closePollModalFunc();
                        } else {
                                 notifications.warning('Necesitas al menos 2 opciones para la encuesta');
                        }
                         } else {
                             notifications.error('Por favor completa tanto la pregunta como las opciones');
                    }
                });
                }

                if (cancelPoll) {
                cancelPoll.addEventListener('click', closePollModalFunc);
                }
                if (closePollModal) {
                closePollModal.addEventListener('click', closePollModalFunc);
                }
                if (pollModal) {
                pollModal.addEventListener('click', (e) => {
                    if (e.target === pollModal) closePollModalFunc();
                });
                }
            }

            // Inicializar modales de entrada
            setupInputModals();
            
            // Verificar que los elementos existan (solo en desarrollo)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('Elementos de publicaci√≥n:', {
                    composerInput: !!document.getElementById('composerInput'),
                    publishPostBtn: !!document.getElementById('publishPostBtn'),
                    attachMenuBtn: !!document.getElementById('attachMenuBtn'),
                    attachModal: !!document.getElementById('attachModal')
                });
            }
            
            // Escuchar cambios en el localStorage para actualizar la foto de perfil
            window.addEventListener('storage', function(e) {
                if (e.key === 'avatarData' || e.key === 'userProfile') {
                    loadUserProfilePicture();
                }
            });
            
            // Tambi√©n escuchar cambios locales (misma pesta√±a)
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                originalSetItem.apply(this, arguments);
                if (key === 'avatarData' || key === 'userProfile') {
                    loadUserProfilePicture();
                }
            };
             
             // Mejorar el sistema de cambio de tema
             const themeToggleBtn = document.getElementById('themeToggleBtn');
             if (themeToggleBtn) {
                 themeToggleBtn.addEventListener('click', () => {
                     const currentTheme = document.documentElement.getAttribute('data-theme');
                     const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                 
                 document.documentElement.setAttribute('data-theme', newTheme);
                 localStorage.setItem('theme', newTheme);
                 
                 // Animaci√≥n suave del cambio
                 document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
                 setTimeout(() => {
                     document.body.style.transition = '';
                 }, 300);
                 
                     notifications.info(`Tema cambiado a ${newTheme === 'light' ? 'claro' : 'oscuro'}`);
                 });
             }
        })();
    </script>
         <!-- Funcionalidades de accesibilidad -->
     <script>
         // Mejoras de accesibilidad
         document.addEventListener('DOMContentLoaded', function() {
             // Navegaci√≥n por teclado
             document.addEventListener('keydown', function(e) {
                 // ESC para cerrar modales
                 if (e.key === 'Escape') {
                     const modals = document.querySelectorAll('.attach-modal.show, .input-modal.show, .post-modal.show, .chat-settings-modal.show');
                     modals.forEach(modal => modal.classList.remove('show'));
                 }
                 
                 // Ctrl/Cmd + K para buscar
                 if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                     e.preventDefault();
                     const searchInput = document.getElementById('viewSearch');
                     if (searchInput) {
                         searchInput.focus();
                     }
                 }
                 
                 // Ctrl/Cmd + Enter para publicar
                 if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                     const publishBtn = document.getElementById('publishPostBtn');
                     if (publishBtn && !publishBtn.disabled) {
                         publishBtn.click();
                     }
                 }
             });
             
             // Mejorar focus visible
             const focusableElements = document.querySelectorAll('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
             focusableElements.forEach(element => {
                 element.addEventListener('focus', function() {
                     this.style.outline = '2px solid var(--primary-color)';
                     this.style.outlineOffset = '2px';
                 });
                 
                 element.addEventListener('blur', function() {
                     this.style.outline = '';
                     this.style.outlineOffset = '';
                 });
             });
             
             // Skip to main content
             const skipLink = document.createElement('a');
             skipLink.href = '#main-content';
             skipLink.textContent = 'Saltar al contenido principal';
             skipLink.className = 'skip-link';
             skipLink.style.cssText = `
                 position: absolute;
                 top: -40px;
                 left: 6px;
                 background: var(--primary-color);
                 color: white;
                 padding: 8px 16px;
                 text-decoration: none;
                 border-radius: 4px;
                 z-index: 10000;
                 transition: top 0.3s;
             `;
             
             skipLink.addEventListener('focus', function() {
                 this.style.top = '6px';
             });
             
             skipLink.addEventListener('blur', function() {
                 this.style.top = '-40px';
             });
             
             document.body.insertBefore(skipLink, document.body.firstChild);
         });
     </script>
     
    <script src="../scripts/theme-toggle.js"></script>
    <script src="../scripts/supabase-client.js"></script>
    <script src="community-identifier.js"></script>

    <script>
        // Sistema de notificaciones elegante
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                if (!this.container) {
                    this.container = document.createElement('div');
                    this.container.id = 'notificationContainer';
                    this.container.className = 'notification-container';
                    document.body.appendChild(this.container);
                }
            }

            show(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                const icon = this.getIcon(type);
                notification.innerHTML = `
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-content">
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                this.container.appendChild(notification);

                // Animaci√≥n de entrada
                setTimeout(() => notification.classList.add('show'), 10);

                // Auto-remover
                if (duration > 0) {
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, duration);
                }

                return notification;
            }

            success(message, duration = 4000) {
                return this.show(message, 'success', duration);
            }

            error(message, duration = 6000) {
                return this.show(message, 'error', duration);
            }

            warning(message, duration = 5000) {
                return this.show(message, 'warning', duration);
            }

            info(message, duration = 4000) {
                return this.show(message, 'info', duration);
            }

            getIcon(type) {
                const icons = {
                    success: '<i class="fas fa-check-circle"></i>',
                    error: '<i class="fas fa-exclamation-circle"></i>',
                    warning: '<i class="fas fa-exclamation-triangle"></i>',
                    info: '<i class="fas fa-info-circle"></i>'
                };
                return icons[type] || icons.info;
            }
        }

        // Instanciar sistema de notificaciones
        const notifications = new NotificationSystem();
    </script>

    <!-- Community Auth - Sistema robusto de autenticaci√≥n para comunidades -->
    <script src="community-auth.js"></script>

    <script src="../scripts/community-database.js"></script>
    <script>
        // Sistema de comunidad con base de datos
        class CommunitySystem {
            constructor() {
                this.db = new CommunityDatabase();
                this.currentCommunity = null;
                this.posts = [];
                this.comments = {};
                this.reactions = {};
                this.members = [];
                this.init();
            }

            async init() {
                console.log('üöÄ Inicializando sistema de comunidad...');
                console.log('üîç URL actual:', window.location.href);
                console.log('üîç Slug de la URL:', new URLSearchParams(window.location.search).get('slug'));
                
                await this.db.initialize();
                
                // Obtener comunidad actual desde URL
                const urlParams = new URLSearchParams(window.location.search);
                const communitySlug = urlParams.get('slug') || 'general';
                
                console.log('üîç Slug a cargar:', communitySlug);
                
                // OPTIMIZACI√ìN: Cargar banner primero, luego el resto en paralelo
                await this.loadBannerOnly(communitySlug);
                
                // Cargar el resto de datos en paralelo (no cr√≠ticos para el banner)
                this.loadRemainingData(communitySlug);
                
                console.log('‚úÖ Sistema de comunidad inicializado');
            }

            // OPTIMIZACI√ìN: Funci√≥n para cargar solo los datos del banner (r√°pida)
            async loadBannerOnly(slug) {
                console.log(`üöÄ Cargando banner de comunidad: ${slug}`);
                this.currentCommunity = await this.db.getCommunityBySlugWithFallback(slug);
                
                if (this.currentCommunity) {
                    console.log('‚úÖ Comunidad cargada para banner:', this.currentCommunity);
                    
                    // Actualizar banner inmediatamente con datos b√°sicos
                    this.updateBannerBasic();
                    
                    // Actualizar t√≠tulo de la p√°gina
                    document.title = `Comunidad de ${this.currentCommunity.name}`;
                } else {
                    console.error('‚ùå No se pudo cargar la comunidad:', slug);
                }
            }

            // OPTIMIZACI√ìN: Funci√≥n para cargar datos restantes en paralelo
            async loadRemainingData(slug) {
                console.log('üîÑ Cargando datos restantes en paralelo...');
                
                // Cargar posts y miembros en paralelo
                const [postsResult, membersResult] = await Promise.allSettled([
                    this.loadPosts(),
                    this.loadMembers()
                ]);
                
                // Actualizar banner con conteo de miembros (despu√©s de cargar miembros)
                if (membersResult.status === 'fulfilled') {
                    this.updateBannerWithMemberCount();
                }
                
                console.log('‚úÖ Datos restantes cargados');
            }

            // OPTIMIZACI√ìN: Actualizar banner con datos b√°sicos (sin conteo de miembros)
            updateBannerBasic() {
                const bannerTitle = document.getElementById('communityBannerTitle');
                const bannerDesc = document.getElementById('communityBannerDesc');
                const bannerMeta = document.getElementById('communityBannerMeta');
                const bannerContainer = document.getElementById('communityBanner');
                const bannerImage = document.getElementById('communityBannerImage');
                
                if (bannerTitle) {
                    bannerTitle.textContent = this.currentCommunity.name;
                }
                if (bannerDesc) {
                    bannerDesc.textContent = this.currentCommunity.description || 'Descripci√≥n de la comunidad';
                }
                if (bannerMeta) {
                    const accessType = this.currentCommunity.access_type || 'Free';
                    bannerMeta.textContent = `‚Ä¢ Cargando... ‚Ä¢ ${accessType}`;
                }
                
                // Cargar imagen del banner desde image_url de la base de datos
                if (bannerImage && this.currentCommunity.image_url) {
                    console.log('üñºÔ∏è Cargando imagen del banner:', this.currentCommunity.image_url);
                    bannerImage.style.backgroundImage = `url(${this.currentCommunity.image_url})`;
                    bannerImage.style.display = 'block';
                } else if (bannerImage) {
                    console.log('‚ö†Ô∏è No hay image_url disponible para la comunidad');
                    bannerImage.style.display = 'none';
                }
                
                // Marcar banner como cargado para ocultar skeleton (solo si no est√° ya cargado)
                if (bannerContainer && !bannerContainer.classList.contains('banner-loaded')) {
                    bannerContainer.classList.add('banner-loaded');
                }
                
                console.log('‚úÖ Banner actualizado con datos de Supabase');
            }

            // OPTIMIZACI√ìN: Actualizar banner con conteo de miembros (despu√©s de cargar)
            updateBannerWithMemberCount() {
                const bannerMeta = document.getElementById('communityBannerMeta');
                if (bannerMeta && this.members) {
                    const memberCount = this.members.length;
                    const accessType = this.currentCommunity.access_type || 'Free';
                    bannerMeta.textContent = `‚Ä¢ ${memberCount} Members ‚Ä¢ ${accessType}`;
                }
            }

            async loadCommunity(slug) {
                console.log(`üèòÔ∏è Cargando comunidad: ${slug}`);
                this.currentCommunity = await this.db.getCommunityBySlugWithFallback(slug);
                
                if (this.currentCommunity) {
                    console.log('‚úÖ Comunidad cargada:', this.currentCommunity);
                    
                    // Calcular el n√∫mero real de miembros (igual que en community.js)
                    let memberCount = 0;
                    console.log('üîç Calculando n√∫mero real de miembros...');
                    console.log('üîç Community ID:', this.currentCommunity.id);
                    console.log('üîç countCommunityMembers disponible:', typeof this.db.countCommunityMembers === 'function');
                    console.log('üîç getCommunityMembers disponible:', typeof this.db.getCommunityMembers === 'function');
                    console.log('üîç Supabase disponible:', !!this.db.supabase);
                    
                    try {
                        if (typeof this.db.countCommunityMembers === 'function') {
                            console.log('üîç Usando countCommunityMembers...');
                            console.log('üîç Community ID que se est√° pasando:', this.currentCommunity.id);
                            console.log('üîç Tipo de Community ID:', typeof this.currentCommunity.id);
                            memberCount = await this.db.countCommunityMembers(this.currentCommunity.id);
                            console.log('üîç Resultado countCommunityMembers:', memberCount);
                        } else if (typeof this.db.getCommunityMembers === 'function') {
                            console.log('üîç Usando getCommunityMembers...');
                            const members = await this.db.getCommunityMembers(this.currentCommunity.id);
                            console.log('üîç Miembros obtenidos:', members);
                            memberCount = Array.isArray(members) ? members.length : 0;
                            console.log('üîç N√∫mero calculado de miembros:', memberCount);
                        } else {
                            console.warn('‚ö†Ô∏è Ning√∫n m√©todo de conteo disponible');
                            memberCount = this.currentCommunity.member_count || 0;
                        }
                    } catch (memberError) {
                        console.warn('[COMMUNITY-VIEW] Error obteniendo miembros:', memberError);
                        memberCount = this.currentCommunity.member_count || 0; // Fallback a BD
                        console.log('üîç Usando fallback member_count:', memberCount);
                    }
                    
                    console.log('üîç N√∫mero final de miembros:', memberCount);
                    
                    // Actualizar el banner de la comunidad
                    const bannerTitle = document.getElementById('communityBannerTitle');
                    const bannerDesc = document.getElementById('communityBannerDesc');
                    const bannerMeta = document.getElementById('communityBannerMeta');
                    
                    console.log('üîç Elementos del banner encontrados:');
                    console.log('  - bannerTitle:', !!bannerTitle);
                    console.log('  - bannerDesc:', !!bannerDesc);
                    console.log('  - bannerMeta:', !!bannerMeta);
                    
                    if (bannerTitle) {
                        bannerTitle.textContent = this.currentCommunity.name;
                        console.log('‚úÖ T√≠tulo actualizado:', this.currentCommunity.name);
                    }
                    if (bannerDesc) {
                        bannerDesc.textContent = this.currentCommunity.description || 'Descripci√≥n de la comunidad';
                        console.log('‚úÖ Descripci√≥n actualizada:', this.currentCommunity.description);
                    }
                    if (bannerMeta) {
                        const accessType = this.currentCommunity.access_type || 'Free';
                        const bannerText = `‚Ä¢ ${memberCount} Members ‚Ä¢ ${accessType}`;
                        bannerMeta.textContent = bannerText;
                        console.log('‚úÖ Banner actualizado:', bannerText);
                        console.log('üîç Elemento bannerMeta despu√©s de actualizar:', bannerMeta);
                        console.log('üîç Texto del elemento:', bannerMeta.textContent);
                    } else {
                        console.warn('‚ö†Ô∏è Elemento bannerMeta no encontrado');
                    }
                    
                    // Actualizar el t√≠tulo de la p√°gina
                    document.title = `Comunidad de ${this.currentCommunity.name}`;
                } else {
                    console.error('‚ùå No se pudo cargar la comunidad:', slug);
                }
            }

            async loadPosts() {
                if (!this.currentCommunity) return;
                
                console.log('üìù Cargando publicaciones...');
                this.posts = await this.db.getPosts(this.currentCommunity.id);
                this.renderPosts();
            }

            async loadMembers() {
                if (!this.currentCommunity) return;
                
                console.log('üë• [CommunitySystem] Cargando miembros desde BD...');
                console.log('üîç [CommunitySystem] Community ID:', this.currentCommunity?.id);
                console.log('üîç [CommunitySystem] Community Name:', this.currentCommunity?.name);

                try {
                    // Esperar a que Supabase est√© disponible
                    console.log('‚è≥ [CommunitySystem] Esperando que Supabase est√© disponible...');
                    const supabaseReady = await window.waitForSupabase();
                    if (!supabaseReady) {
                        throw new Error('Supabase no disponible para CommunitySystem');
                    }
                    console.log('‚úÖ [CommunitySystem] Supabase disponible, iniciando consulta...');

                    // Consultar miembros con datos de usuario
                    const { data: dbMembers, error } = await window.supabase
                        .from('community_members')
                        .select(`
                            *,
                            users:user_id (
                                id,
                                email,
                                display_name,
                                first_name,
                                last_name,
                                username,
                                profile_picture_url,
                                created_at
                            )
                        `)
                        .eq('community_id', this.currentCommunity.id)
                        .eq('is_active', true)
                        .order('joined_at', { ascending: false });

                    console.log('üìä [CommunitySystem] Resultado de consulta:', {
                        data: dbMembers,
                        error: error,
                        length: dbMembers?.length || 0
                    });

                    if (error) {
                        console.error('‚ùå [CommunitySystem] Error en consulta Supabase:', error);
                        throw new Error(`Error cargando miembros: ${error.message}`);
                    }

                    console.log('üë• [CommunitySystem] Miembros obtenidos:', dbMembers?.length || 0);

                    if (!dbMembers || dbMembers.length === 0) {
                        console.log('‚ö†Ô∏è [CommunitySystem] No se encontraron miembros para la comunidad');
                        console.log('üîç [CommunitySystem] Verificando si existen miembros sin filtros...');

                        // Verificar si hay miembros sin el filtro is_active
                        const { data: allMembers } = await window.supabase
                            .from('community_members')
                            .select('id, is_active, role')
                            .eq('community_id', this.currentCommunity.id);

                        console.log('üìã [CommunitySystem] Todos los miembros de la comunidad:', allMembers);

                        this.members = [];
                        // Sincronizar con variable global
                        window.members.length = 0;
                        return;
                    }

                    // Convertir formato para la UI
                    this.members = dbMembers.map(member => {
                        const user = member.users;
                        const userName = user?.display_name || user?.first_name || user?.username || user?.email?.split('@')[0] || 'Usuario';

                        return {
                            id: member.id,
                            name: userName,
                            avatar: user?.profile_picture_url || null,
                            admin: member.role === 'admin' || member.role === 'moderator',
                            online: false, // Se calcular√° con presencia real
                            location: 'Miembro de la comunidad',
                            lastSeen: 'Calculando...',
                            joined: member.joined_at || member.created_at || new Date().toISOString(),
                            points: member.points || 0
                        };
                    });

                    // Sincronizar con variable global (ahora apuntan al mismo objeto)
                    window.members.length = 0; // Limpiar array existente
                    window.members.push(...this.members); // Llenar con nuevos datos

                    console.log('üîÑ [CommunitySystem] Sincronizaci√≥n completada:');
                    console.log('  - this.members.length:', this.members.length);
                    console.log('  - window.members.length:', window.members.length);
                    console.log('  - members.length:', members.length);
                    console.log('  - Datos de miembros:', this.members);

                    console.log(`‚úÖ [CommunitySystem] ${this.members.length} miembros procesados`);

                    // Renderizar miembros inmediatamente despu√©s de cargarlos
                this.renderMembers();
                
                // OPTIMIZACI√ìN: Actualizar banner con conteo de miembros despu√©s de cargar
                this.updateBannerWithMemberCount();
                } catch (error) {
                    console.error('‚ùå [CommunitySystem] Error cargando miembros:', error);
                    this.members = [];
                    window.members.length = 0;
                }
            }

            async createPost(content, title = null, attachmentUrl = null, attachmentType = null) {
                if (!this.currentCommunity) return null;
                
                console.log('üìù Creando nueva publicaci√≥n...');
                const post = await this.db.createPost(
                    this.currentCommunity.id,
                    content,
                    title,
                    attachmentUrl,
                    attachmentType
                );
                
                if (post) {
                    // Agregar puntos al usuario
                    if (window.pointsSystem) {
                        await window.pointsSystem.addPoints(null, 'publish');
                    }
                    
                    // Recargar publicaciones
                    await this.loadPosts();
                    
                    // Mostrar notificaci√≥n
                    this.showNotification('Publicaci√≥n creada exitosamente', 'success');
                } else {
                    this.showNotification('Error al crear la publicaci√≥n', 'error');
                }
                
                return post;
            }

            async createComment(postId, content) {
                console.log('üí¨ Creando nuevo comentario...');
                
                // Validaci√≥n para prevenir comentarios duplicados
                const existingComments = this.comments[postId] || [];
                const recentComment = existingComments.find(c => 
                    c.content === content && 
                    (Date.now() - new Date(c.created_at).getTime()) < 5000 // 5 segundos
                );
                
                if (recentComment) {
                    console.log('‚ö†Ô∏è Comentario duplicado detectado, ignorando');
                    this.showNotification('Comentario duplicado detectado', 'warning');
                    return null;
                }
                
                const comment = await this.db.createComment(postId, content);
                
                if (comment) {
                    // Agregar puntos al usuario
                    if (window.pointsSystem) {
                        await window.pointsSystem.addPoints(null, 'comment');
                    }
                    
                    // Recargar comentarios del post
                    await this.loadComments(postId);
                    
                    // Mostrar notificaci√≥n
                    this.showNotification('Comentario agregado', 'success');
                } else {
                    this.showNotification('Error al agregar comentario', 'error');
                }
                
                return comment;
            }

            async toggleReaction(postId, reactionType = 'like') {
                console.log(`üëç Alternando reacci√≥n: ${reactionType}`);
                const success = await this.db.toggleReaction(postId, null, reactionType);
                
                if (success) {
                    // Agregar puntos al usuario
                    if (window.pointsSystem) {
                        await window.pointsSystem.addPoints(null, 'react');
                    }
                    
                    // Recargar reacciones del post
                    await this.loadReactions(postId);
                    
                    // Mostrar notificaci√≥n
                    this.showNotification('Reacci√≥n actualizada', 'success');
                } else {
                    this.showNotification('Error al actualizar reacci√≥n', 'error');
                }
                
                return success;
            }

            async loadComments(postId) {
                console.log(`üí¨ Cargando comentarios para post ${postId}...`);
                this.comments[postId] = await this.db.getComments(postId);
                this.renderComments(postId);
            }

            async loadReactions(postId) {
                console.log(`üëç Cargando reacciones para post ${postId}...`);
                this.reactions[postId] = await this.db.getReactions(postId);
                this.renderReactions(postId);
            }

            renderPosts() {
                const postsContainer = document.getElementById('postsContainer');
                if (!postsContainer) return;
                
                postsContainer.innerHTML = '';
                
                this.posts.forEach(post => {
                    const postElement = this.createPostElement(post);
                    postsContainer.appendChild(postElement);
                });
            }

            createPostElement(post) {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                postDiv.dataset.postId = post.id;
                
                const userName = post.users?.display_name || post.users?.first_name || post.users?.username || 'Usuario';
                
                // Usar la nueva funci√≥n formatTimestamp para formatear correctamente el tiempo
                let timestamp;
                if (post.created_at) {
                    timestamp = this.db.formatTimestamp(post.created_at);
                } else if (post.timestamp) {
                    // Para posts del sistema anterior que usan timestamp en milisegundos
                    timestamp = this.db.formatTimestamp(post.timestamp);
                } else {
                    timestamp = 'Reci√©n publicado';
                }
                
                postDiv.innerHTML = `
                    <div class="post-header">
                        <div class="post-user">
                            <img src="${isValidImageUrl(post.users?.profile_picture_url) ? post.users.profile_picture_url : '../assets/images/default-avatar.jpg'}" alt="${userName}" class="user-avatar">
                            <div class="user-info">
                                <div class="user-name">${userName}</div>
                                <div class="post-time">${timestamp}</div>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="action-btn" onclick="communitySystem.showPostMenu('${post.id}')">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                    <div class="post-content">
                        ${post.title ? `<h3 class="post-title">${post.title}</h3>` : ''}
                        <p>${post.content}</p>
                        ${post.attachment_url ? this.renderAttachment(post) : ''}
                    </div>
                    <div class="post-footer">
                        <div class="post-interactions">
                            <button class="interaction-btn like-btn" onclick="communitySystem.toggleReaction('${post.id}', 'like')">
                                <i class="fas fa-heart"></i>
                                <span class="btn-text">Me gusta</span>
                                <span class="reaction-count" id="reaction-count-${post.id}">${post.likes_count || 0}</span>
                            </button>
                            <button class="interaction-btn comment-btn" onclick="communitySystem.showComments('${post.id}')">
                                <i class="fas fa-comment"></i>
                                <span class="btn-text">Comentar</span>
                                <span class="comment-count" id="comment-count-${post.id}">${post.comments_count || 0}</span>
                            </button>
                            <button class="interaction-btn share-btn" onclick="communitySystem.sharePost('${post.id}')">
                                <i class="fas fa-share"></i>
                                <span class="btn-text">Compartir</span>
                            </button>
                        </div>
                    </div>
                    <div class="comments-section" id="comments-${post.id}" style="display: none;">
                        <div class="comment-input">
                            <textarea placeholder="Escribe un comentario..." id="comment-input-${post.id}"></textarea>
                            <button onclick="communitySystem.submitComment('${post.id}')">Comentar</button>
                        </div>
                        <div class="comments-list" id="comments-list-${post.id}"></div>
                    </div>
                `;
                
                return postDiv;
            }

            renderAttachment(post) {
                if (!post.attachment_url) return '';
                
                switch (post.attachment_type) {
                    case 'image':
                        return `<div class="post-media-container">
                            <img src="${post.attachment_url}" alt="Imagen adjunta" class="post-attachment post-image">
                        </div>`;
                    case 'video':
                        return `<div class="post-media-container">
                            <video src="${post.attachment_url}" controls class="post-attachment post-video"></video>
                        </div>`;
                    case 'document':
                        return `<div class="post-document-container">
                            <a href="${post.attachment_url}" target="_blank" class="attachment-link">
                            <i class="fas fa-file"></i> Ver documento
                            </a>
                        </div>`;
                    case 'link':
                        return `<div class="post-link-container">
                            <a href="${post.attachment_url}" target="_blank" class="attachment-link">
                            <i class="fas fa-link"></i> ${post.attachment_url}
                            </a>
                        </div>`;
                    default:
                        return `<div class="post-document-container">
                            <a href="${post.attachment_url}" target="_blank" class="attachment-link">
                            <i class="fas fa-paperclip"></i> Ver adjunto
                            </a>
                        </div>`;
                }
            }

            renderComments(postId) {
                const commentsList = document.getElementById(`comments-list-${postId}`);
                if (!commentsList) return;
                
                const comments = this.comments[postId] || [];
                commentsList.innerHTML = '';
                
                comments.forEach(comment => {
                    const commentElement = this.createCommentElement(comment);
                    commentsList.appendChild(commentElement);
                });
            }

            createCommentElement(comment) {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                
                const userName = comment.users?.display_name || comment.users?.first_name || comment.users?.username || 'Usuario';
                const timestamp = this.db.formatTimestamp(comment.created_at);
                
                commentDiv.innerHTML = `
                    <div class="comment-header">
                        <img src="${isValidImageUrl(comment.users?.profile_picture_url) ? comment.users.profile_picture_url : '../assets/images/default-avatar.jpg'}" alt="${userName}" class="user-avatar small">
                        <div class="comment-info">
                            <div class="user-name">${userName}</div>
                            <div class="comment-time">${timestamp}</div>
                        </div>
                    </div>
                    <div class="comment-content">
                        <p>${comment.content}</p>
                    </div>
                    <div class="comment-actions">
                        <button class="reaction-btn small" onclick="communitySystem.toggleReaction(null, '${comment.id}', 'like')">
                            <i class="fas fa-heart"></i>
                            <span class="reaction-count">${comment.likes_count || 0}</span>
                        </button>
                    </div>
                `;
                
                return commentDiv;
            }

            renderReactions(postId) {
                const reactions = this.reactions[postId] || [];
                const reactionCount = reactions.length;
                
                const countElement = document.getElementById(`reaction-count-${postId}`);
                if (countElement) {
                    countElement.textContent = reactionCount;
                }
            }

            renderMembers() {
                console.log('üé® [CommunitySystem] Renderizando miembros...');
                console.log('üîç [CommunitySystem] this.members:', this.members);
                console.log('üîç [CommunitySystem] window.members:', window.members);

                // Usar la funci√≥n renderMembers global que ya est√° funcionando
                if (typeof window.renderMembers === 'function') {
                    console.log('‚úÖ [CommunitySystem] Funci√≥n renderMembers global encontrada');
                    const activeFilter = document.querySelector('.members-chip.active')?.dataset.filter || 'all';
                    const searchQuery = document.getElementById('viewSearch')?.value || '';
                    console.log('üéØ [CommunitySystem] Llamando renderMembers con:', { activeFilter, searchQuery });
                    window.renderMembers(activeFilter, searchQuery);
                } else {
                    console.warn('‚ö†Ô∏è [CommunitySystem] Funci√≥n renderMembers global no disponible, renderizando directamente');

                    // Fallback: renderizar directamente
                    const membersContainer = document.getElementById('membersList');
                    if (!membersContainer || !this.members) return;

                    membersContainer.innerHTML = this.members.map(m => `
                        <div class="member-card" data-user-id="${m.id || m.user_id}" style="cursor: pointer;">
                            <div class="member-avatar">
                                ${isValidImageUrl(m.avatar) ?
                                    `<img src="${m.avatar}" alt="${m.name}" class="member-avatar-img" onerror="this.src='../assets/images/default-avatar.svg'; this.onerror=null;">` :
                                    `<i class="fas fa-user"></i>`
                                }
                                ${m.online ? '<span class="member-status"></span>' : ''}
                            </div>
                            <div class="member-info">
                                <div class="member-name">
                                    ${m.name}
                                    ${m.admin ? '<span class="member-badge admin">Admin</span>' : ''}
                                    ${m.online ? '<span class="member-badge online">En l√≠nea</span>' : ''}
                                </div>
                                <div class="member-meta">
                                    <div class="member-location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${m.location}</span>
                                    </div>
                                    <div class="member-status-text" style="display: none;">
                                        ${m.online ? '<i class="fas fa-circle online-dot"></i>' : '<i class="fas fa-clock"></i>'}
                                        <span>${m.online ? 'En l√≠nea' : `Visto ${m.lastSeen}`}</span>
                                    </div>
                                    <div class="member-joined">
                                        <i class="fas fa-calendar"></i>
                                        <span>Se uni√≥ hace tiempo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            createMemberElement(member) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-item';
                
                const userName = member.users?.display_name || member.users?.first_name || member.users?.username || 'Usuario';
                const points = member.users?.points || 0;
                
                memberDiv.innerHTML = `
                    <div class="member-avatar">
                        <img src="${isValidImageUrl(member.users?.profile_picture_url) ? member.users.profile_picture_url : '../assets/images/default-avatar.jpg'}" alt="${userName}">
                        <div class="online-indicator"></div>
                    </div>
                    <div class="member-info">
                        <div class="member-name">${userName}</div>
                        <div class="member-points">${points} puntos</div>
                    </div>
                `;
                
                return memberDiv;
            }

            async showComments(postId) {
                const commentsSection = document.getElementById(`comments-${postId}`);
                if (!commentsSection) return;
                
                if (commentsSection.style.display === 'none') {
                    commentsSection.style.display = 'block';
                    await this.loadComments(postId);
                } else {
                    commentsSection.style.display = 'none';
                }
            }

            async submitComment(postId) {
                const commentInput = document.getElementById(`comment-input-${postId}`);
                if (!commentInput) return;
                
                const content = commentInput.value.trim();
                if (!content) return;
                
                // Buscar el bot√≥n de comentario correspondiente
                const commentBtn = document.querySelector(`[onclick="communitySystem.submitComment('${postId}')"]`);
                if (commentBtn) {
                    // Prevenir m√∫ltiples env√≠os
                    if (commentBtn.classList.contains('comment-btn-loading')) {
                        console.log('‚ö†Ô∏è Comentario ya siendo enviado, ignorando click duplicado');
                        return;
                    }
                    
                    // Agregar clase de carga y deshabilitar bot√≥n
                    commentBtn.classList.add('comment-btn-loading');
                    commentBtn.disabled = true;
                    const originalText = commentBtn.textContent;
                    commentBtn.innerHTML = '<span class="btn-text">Comentando...</span>';
                    
                    try {
                        await this.createComment(postId, content);
                        commentInput.value = '';
                    } finally {
                        // Restaurar bot√≥n en todos los casos
                        commentBtn.classList.remove('comment-btn-loading');
                        commentBtn.disabled = false;
                        commentBtn.textContent = originalText;
                    }
                } else {
                    // Fallback si no se encuentra el bot√≥n
                    await this.createComment(postId, content);
                    commentInput.value = '';
                }
            }

            showPostMenu(postId) {
                // Implementar men√∫ de opciones del post
                console.log('Mostrando men√∫ del post:', postId);
            }

            sharePost(postId) {
                // Implementar compartir post
                console.log('Compartiendo post:', postId);
            }

            showNotification(message, type = 'info') {
                // Implementar sistema de notificaciones
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }

        // Sistema de puntos mejorado
        class PointsSystem {
            constructor() {
                this.users = [];
                this.currentUser = null;
                this.init();
            }

            async init() {
                console.log('üéØ Inicializando sistema de puntos...');
                await this.loadUsers();
                await this.getCurrentUser();
                this.updateLeagueDisplay();
                console.log('‚úÖ Sistema de puntos inicializado');
            }

            async refreshPointsFromDatabase() {
                console.log('üîÑ Refreshing points from database...');
                if (this.currentUser && this.currentUser.id) {
                    try {
                        const { data: userData, error } = await window.supabase
                            .from('users')
                            .select('points')
                            .eq('id', this.currentUser.id)
                            .single();
                        
                        if (!error && userData) {
                            console.log('‚úÖ Points refreshed from database:', userData.points);
                            this.currentUser.points = userData.points || 0;
                            this.updateLeagueDisplay();
                            return true;
                        } else {
                            console.error('‚ùå Error refreshing points:', error);
                        }
                    } catch (error) {
                        console.error('‚ùå Error refreshing points from database:', error);
                    }
                }
                return false;
            }

            async loadUsers() {
                console.log('üë• Cargando usuarios...');
                try {
                    if (window.supabase) {
                        console.log('üîó Intentando cargar usuarios desde Supabase...');
                        const { data, error } = await window.supabase
                            .from('users')
                            .select('id, username, display_name, first_name, points');
                        
                        if (!error && data && data.length > 0) {
                            console.log('‚úÖ Usuarios cargados desde Supabase:', data);
                            // Formatear usuarios para compatibilidad
                            this.users = data.map(user => ({
                                id: user.id,
                                name: user.username || user.display_name || user.first_name || 'Usuario',
                                points: user.points || 0,
                                posts: 0,
                                comments: 0,
                                reactions: 0
                            }));
                            
                            // Cargar estad√≠sticas desde localStorage
                            const stats = JSON.parse(localStorage.getItem('communityUsersStats') || '[]');
                            this.users.forEach(user => {
                                const userStats = stats.find(s => s.name === user.name);
                                if (userStats) {
                                    user.posts = userStats.posts || 0;
                                    user.comments = userStats.comments || 0;
                                    user.reactions = userStats.reactions || 0;
                                }
                            });
                        } else {
                            console.log('‚ö†Ô∏è No se pudieron cargar usuarios desde Supabase, usando localStorage');
                            this.loadFromLocalStorage();
                        }
                    } else {
                        console.log('‚ö†Ô∏è Supabase no disponible, usando localStorage');
                        this.loadFromLocalStorage();
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando usuarios:', error);
                    this.loadFromLocalStorage();
                }
            }

            loadFromLocalStorage() {
                console.log('üì¶ Cargando usuarios desde localStorage...');
                const users = JSON.parse(localStorage.getItem('communityUsers') || '[]');
                if (users.length === 0) {
                    // Los usuarios ahora se cargan solo desde la base de datos
                    // No hay datos hardcodeados
                    this.users = [];
                } else {
                    this.users = users;
                }
                console.log('‚úÖ Usuarios cargados desde localStorage:', this.users);
            }

            async saveUsers() {
                console.log('üîÑ PointsSystem.saveUsers() called');
                console.log('Current users:', this.users);
                localStorage.setItem('communityUsers', JSON.stringify(this.users));
                console.log('‚úÖ Saved to localStorage');
                
                // Guardar estad√≠sticas por separado
                const stats = this.users.map(user => ({
                    name: user.name,
                    posts: user.posts,
                    comments: user.comments,
                    reactions: user.reactions
                }));
                localStorage.setItem('communityUsersStats', JSON.stringify(stats));
                console.log('‚úÖ Stats saved to localStorage');

                try {
                    if (window.supabase) {
                        console.log('üîó Supabase client available, attempting to save...');
                        for (const user of this.users) {
                            if (user.id) {
                                console.log(`üìù Updating user ${user.name} (ID: ${user.id}) with ${user.points} points`);
                                const { data, error } = await window.supabase
                                    .from('users')
                                    .update({ points: user.points })
                                    .eq('id', user.id)
                                    .select();
                                if (error) {
                                    console.error(`‚ùå Error updating user ${user.name}:`, error);
                                } else {
                                    console.log(`‚úÖ Points updated in Supabase for user ${user.name}: ${user.points} points`);
                                    console.log('Supabase response:', data);
                                }
                            } else {
                                console.log(`‚ö†Ô∏è User ${user.name} has no Supabase ID, skipping database update`);
                            }
                        }
                        // New logic for current user without ID but with localStorage data
                        if (this.currentUser && !this.currentUser.id) {
                            console.log('üîÑ Attempting to sync current user with Supabase...');
                            const userData = localStorage.getItem('userData');
                            const currentUser = localStorage.getItem('currentUser');
                            let userInfo = null;
                            if (userData) { try { userInfo = JSON.parse(userData); } catch (e) { console.error('Error parsing userData:', e); } }
                            else if (currentUser) { try { userInfo = JSON.parse(currentUser); } catch (e) { console.error('Error parsing currentUser:', e); } }
                            if (userInfo && userInfo.id) {
                                console.log(`üìù Updating current user in Supabase (ID: ${userInfo.id}) with ${this.currentUser.points} points`);
                                const { data, error } = await window.supabase
                                    .from('users')
                                    .update({ points: this.currentUser.points })
                                    .eq('id', userInfo.id)
                                    .select();
                                if (error) { console.error(`‚ùå Error updating current user in Supabase:`, error); }
                                else {
                                    console.log(`‚úÖ Current user points updated in Supabase: ${this.currentUser.points} points`);
                                    console.log('Supabase response:', data);
                                    this.currentUser.id = userInfo.id; // Update local ID
                                }
                            }
                        }
                    } else {
                        console.log('‚ö†Ô∏è Supabase client not available');
                    }
                } catch (error) {
                    console.error('‚ùå Error saving users to Supabase:', error);
                }
            }

            async getCurrentUser() {
                console.log('üîÑ PointsSystem.getCurrentUser() called');
                
                try {
                    // Primero intentar obtener usuario autenticado de Supabase
                    if (window.supabase) {
                        console.log('üîó Checking Supabase authentication...');
                        const { data: { user }, error } = await window.supabase.auth.getUser();
                        
                        if (!error && user) {
                            console.log('‚úÖ Authenticated user found:', user);
                            
                            // Obtener datos completos del usuario desde la base de datos
                            const { data: userData, error: userError } = await window.supabase
                                .from('users')
                                .select('id, username, display_name, first_name, email, points')
                                .eq('id', user.id)
                                .single();
                            
                            if (!userError && userData) {
                                console.log('‚úÖ User data from database:', userData);
                                
                                // Buscar si ya existe en la lista local
                                let localUser = this.users.find(u => u.id === userData.id);
                                if (!localUser) {
                                    localUser = {
                                        id: userData.id,
                                        name: userData.username || userData.display_name || userData.first_name || userData.email || 'Usuario',
                                        points: userData.points || 0,
                                        posts: 0,
                                        comments: 0,
                                        reactions: 0
                                    };
                                    this.users.push(localUser);
                                } else {
                                    // Actualizar puntos desde la base de datos
                                    localUser.points = userData.points || 0;
                                    localUser.name = userData.username || userData.display_name || userData.first_name || userData.email || 'Usuario';
                                }
                                
                                // IMPORTANTE: Asignar al currentUser
                                this.currentUser = localUser;
                                console.log('üë§ Current user (from database):', this.currentUser);
                                return this.currentUser;
                            } else {
                                console.error('‚ùå Error getting user data from database:', userError);
                            }
                        } else {
                            console.log('‚ö†Ô∏è No authenticated user found in Supabase');
                        }
                    } else {
                        console.log('‚ö†Ô∏è Supabase client not available');
                    }
                } catch (error) {
                    console.error('‚ùå Error getting current user from Supabase:', error);
                }
                
                // Fallback: usar datos del localStorage
                console.log('üîÑ Falling back to localStorage...');
                const userData = localStorage.getItem('userData');
                const currentUser = localStorage.getItem('currentUser');
                
                let userInfo = null;
                if (userData) {
                    try { 
                        userInfo = JSON.parse(userData); 
                    } catch (e) { 
                        console.error('Error parsing userData:', e); 
                    }
                } else if (currentUser) {
                    try { 
                        userInfo = JSON.parse(currentUser); 
                    } catch (e) { 
                        console.error('Error parsing currentUser:', e); 
                    }
                }
                
                if (userInfo && userInfo.id) {
                    console.log('üë§ User info from localStorage:', userInfo);
                    
                    // Buscar si ya existe en la lista local
                    let localUser = this.users.find(u => u.id === userInfo.id);
                    if (!localUser) {
                        localUser = {
                            id: userInfo.id,
                            name: userInfo.user_metadata?.full_name || userInfo.user_metadata?.name || userInfo.email || 'Usuario',
                            points: userInfo.user_metadata?.points || 0,
                            posts: 0,
                            comments: 0,
                            reactions: 0
                        };
                        this.users.push(localUser);
                    }
                    
                    // IMPORTANTE: Asignar al currentUser
                    this.currentUser = localUser;
                    console.log('üë§ Current user (from localStorage):', this.currentUser);
                    return this.currentUser;
                }
                
                // √öltimo fallback: usuario gen√©rico
                const currentUserName = localStorage.getItem('currentUserName') || 'T√∫';
                let user = this.users.find(u => u.name === currentUserName);
                if (!user) {
                    user = { 
                        id: null, 
                        name: currentUserName, 
                        points: 0, 
                        posts: 0, 
                        comments: 0, 
                        reactions: 0 
                    };
                    this.users.push(user);
                }
                
                // IMPORTANTE: Asignar al currentUser
                this.currentUser = user;
                console.log('üë§ Current user (generic fallback):', this.currentUser);
                return this.currentUser;
            }

            async addPoints(userName, action, extraPoints = 0) {
                console.log('üéØ PointsSystem.addPoints called:', { userName, action, extraPoints });
                let user = this.currentUser;
                if (!user) {
                    console.log('‚ö†Ô∏è No current user found, getting current user...');
                    user = await this.getCurrentUser();
                    this.currentUser = user;
                }
                console.log('üë§ User to add points to:', user);
                if (!user) { console.error('‚ùå No user found to add points to'); return 0; }

                let pointsToAdd = 0;
                switch (action) {
                    case 'publish':
                        pointsToAdd = 10;
                        user.posts++;
                        break;
                    case 'comment':
                        pointsToAdd = 5;
                        user.comments++;
                        break;
                    case 'react':
                        pointsToAdd = 2;
                        user.reactions++;
                        break;
                    case 'popularPost':
                        pointsToAdd = 15;
                        break;
                    default:
                        pointsToAdd = extraPoints;
                }

                user.points += pointsToAdd;
                console.log(`üí∞ Added ${pointsToAdd} points for ${action}. User now has ${user.points} points`);
                console.log('üíæ Saving users to database...');
                await this.saveUsers();
                console.log('‚úÖ Points updated, user now has:', user.points, 'points');
                this.updateLeagueDisplay();
                return pointsToAdd;
            }

            getLeague(points) {
                if (points >= 1000) return { name: 'Liga Diamante', color: '#B9F2FF', minPoints: 1000, maxPoints: Infinity };
                if (points >= 500) return { name: 'Liga Platino', color: '#E5E4E2', minPoints: 500, maxPoints: 999 };
                return { name: 'Liga Oro', color: '#FFD700', minPoints: 0, maxPoints: 499 };
            }

            getProgressToNextLeague(points) {
                const currentLeague = this.getLeague(points);
                const nextLeague = this.getNextLeague(points);
                if (!nextLeague) return { progress: 100, pointsNeeded: 0 };
                
                const pointsInCurrentLeague = points - currentLeague.minPoints;
                const pointsNeededForNextLeague = nextLeague.minPoints - currentLeague.minPoints;
                const progress = Math.min(100, (pointsInCurrentLeague / pointsNeededForNextLeague) * 100);
                
                return {
                    progress: Math.round(progress),
                    pointsNeeded: nextLeague.minPoints - points
                };
            }

            getNextLeague(points) {
                if (points >= 1000) return null; // Ya est√° en la m√°xima liga
                if (points >= 500) return { name: 'Liga Diamante', minPoints: 1000 };
                return { name: 'Liga Platino', minPoints: 500 };
            }

            updateLeagueDisplay() {
                if (!this.currentUser) {
                    console.log('‚ö†Ô∏è No current user for league display update');
                    return;
                }
                
                console.log('üèÜ Updating league display for user:', this.currentUser);
                
                const league = this.getLeague(this.currentUser.points);
                const progress = this.getProgressToNextLeague(this.currentUser.points);
                
                // Actualizar elementos de la interfaz con los IDs correctos
                const leagueElement = document.getElementById('currentUserLeague');
                const progressElement = document.getElementById('leagueProgressFill');
                const pointsElement = document.getElementById('currentUserPoints');
                const progressTextElement = document.getElementById('leagueProgressText');
                const leagueImageElement = document.getElementById('currentUserLeagueImage');
                const userNameElement = document.getElementById('currentUserName');
                
                if (leagueElement) {
                    leagueElement.textContent = league.name;
                    leagueElement.style.color = league.color;
                    console.log('‚úÖ League element updated:', league.name);
                }
                
                // Actualizar nombre del usuario
                if (userNameElement && this.currentUser.name) {
                    userNameElement.textContent = this.currentUser.name;
                    console.log('‚úÖ User name updated:', this.currentUser.name);
                }
                
                // Actualizar imagen de la liga
                if (leagueImageElement) {
                    let leagueImagePath = 'images/liga-oro.png'; // Default
                    
                    if (this.currentUser.points >= 1000) {
                        leagueImagePath = 'images/liga-diamante.png';
                    } else if (this.currentUser.points >= 500) {
                        leagueImagePath = 'images/liga-platino.png';
                    } else {
                        leagueImagePath = 'images/liga-oro.png';
                    }
                    
                    leagueImageElement.src = leagueImagePath;
                    leagueImageElement.alt = `Liga ${league.name}`;
                    console.log('‚úÖ League image updated:', leagueImagePath);
                }
                
                if (progressElement) {
                    progressElement.style.width = `${progress.progress}%`;
                    progressElement.setAttribute('aria-valuenow', progress.progress);
                    console.log('‚úÖ Progress element updated:', progress.progress + '%');
                }
                
                if (pointsElement) {
                    pointsElement.textContent = `${this.currentUser.points} puntos`;
                    console.log('‚úÖ Points element updated:', this.currentUser.points);
                }
                
                if (progressTextElement) {
                    if (progress.pointsNeeded > 0) {
                        progressTextElement.textContent = `${progress.pointsNeeded} puntos para subir`;
                    } else {
                        progressTextElement.textContent = '¬°Liga m√°xima alcanzada!';
                    }
                    console.log('‚úÖ Progress text updated');
                }
                
                console.log('‚úÖ League display update completed');
            }
        }

        // Sistema de filtros de liga
        class LeagueFilterSystem {
            constructor() {
                this.currentFilter = 'all';
                this.allUsers = [];
                this.init();
            }

            async init() {
                console.log('üèÜ Inicializando sistema de filtros de liga...');
                await this.loadAllUsers();
                this.setupEventListeners();
                this.updateLeaderboard();
                console.log('‚úÖ Sistema de filtros de liga inicializado');
            }

            async loadAllUsers() {
                console.log('üë• Cargando todos los usuarios para clasificaci√≥n...');
                
                if (!window.supabase) {
                    console.error('‚ùå Supabase no est√° disponible');
                    return;
                }

                try {
                    console.log('üîç Haciendo consulta a la tabla users...');
                    
                    // Consulta directa a la tabla users - igual que para obtener tu informaci√≥n
                    const { data: users, error } = await window.supabase
                        .from('users')
                        .select('id, username, display_name, first_name, email, points')
                        .order('points', { ascending: false });

                    console.log('üìä Respuesta de Supabase:', { users, error });

                    if (error) {
                        console.error('‚ùå Error en consulta Supabase:', error);
                        return;
                    }

                    if (users && users.length > 0) {
                        console.log(`‚úÖ Encontrados ${users.length} usuarios en la base de datos`);
                        
                        this.allUsers = users.map(user => {
                            const userData = {
                                id: user.id,
                                name: user.username || user.display_name || user.first_name || user.email || 'Usuario',
                                points: user.points || 0,
                                league: this.getUserLeague(user.points || 0)
                            };
                            console.log('üë§ Usuario procesado:', userData);
                            return userData;
                        });
                        
                        console.log(`‚úÖ Cargados ${this.allUsers.length} usuarios desde Supabase`);
                        console.log('üìã Lista completa de usuarios:', this.allUsers);
                    } else {
                        console.log('‚ö†Ô∏è No se encontraron usuarios en la base de datos');
                        this.allUsers = [];
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error cargando usuarios:', error);
                    this.allUsers = [];
                }
                
                console.log(`üìä Total de usuarios cargados: ${this.allUsers.length}`);
            }

            getUserLeague(points) {
                if (points >= 1000) return 'diamond';
                if (points >= 500) return 'platinum';
                return 'gold';
            }

            setupEventListeners() {
                const filterButtons = document.querySelectorAll('.league-filter');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const league = button.dataset.league;
                        this.setActiveFilter(league);
                    });
                });
            }

            setActiveFilter(league) {
                this.currentFilter = league;
                
                // Actualizar botones activos
                document.querySelectorAll('.league-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-league="${league}"]`)?.classList.add('active');
                
                this.updateLeaderboard();
            }

            updateLeaderboard() {
                console.log('üèÜ Actualizando tabla de clasificaci√≥n...');
                console.log('üìä Usuarios disponibles:', this.allUsers);
                console.log('üîç Filtro actual:', this.currentFilter);
                
                const leaderboardTable = document.getElementById('leaderboardTable');
                const totalParticipants = document.getElementById('totalParticipants');
                
                if (!leaderboardTable) {
                    console.error('‚ùå No se encontr√≥ el elemento leaderboardTable');
                    return;
                }

                console.log('üéØ Elemento leaderboardTable encontrado:', leaderboardTable);
                console.log('üìè Dimensiones del elemento:', {
                    offsetHeight: leaderboardTable.offsetHeight,
                    clientHeight: leaderboardTable.clientHeight,
                    scrollHeight: leaderboardTable.scrollHeight,
                    innerHTML: leaderboardTable.innerHTML.substring(0, 100) + '...'
                });

                // Filtrar usuarios seg√∫n la liga seleccionada
                let filteredUsers = this.allUsers;
                if (this.currentFilter !== 'all') {
                    filteredUsers = this.allUsers.filter(user => user.league === this.currentFilter);
                }

                console.log('üìã Usuarios filtrados:', filteredUsers);

                // Ordenar por puntos (mayor a menor)
                filteredUsers.sort((a, b) => b.points - a.points);

                // Actualizar contador de participantes
                if (totalParticipants) {
                    totalParticipants.textContent = `${filteredUsers.length} participantes`;
                    console.log('üìä Contador actualizado:', `${filteredUsers.length} participantes`);
                }

                // Generar HTML de la tabla
                if (filteredUsers.length === 0) {
                    console.log('‚ö†Ô∏è No hay usuarios para mostrar');
                    leaderboardTable.innerHTML = `
                        <div class="empty-leaderboard">
                            <i class="fas fa-trophy"></i>
                            <p>No hay participantes en esta liga</p>
                        </div>
                    `;
                } else {
                    console.log('‚úÖ Generando tabla con usuarios...');
                    const tableHTML = filteredUsers.map((user, index) => {
                        const position = index + 1;
                        const medal = position <= 3 ? this.getMedalIcon(position) : '';
                        const leagueIcon = this.getLeagueIcon(user.league);
                        
                        const rowHTML = `
                            <div class="leaderboard-row">
                                <div class="leaderboard-position">
                                    ${medal}${position}
                                </div>
                                <div class="leaderboard-user">
                                    <div class="user-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${user.name}</div>
                                        <div class="user-league">
                                            ${leagueIcon} ${this.getLeagueName(user.league)}
                                        </div>
                                    </div>
                                </div>
                                <div class="leaderboard-points">
                                    ${user.points} puntos
                                </div>
                            </div>
                        `;
                        console.log(`üë§ Fila ${position}: ${user.name} - ${user.points} puntos`);
                        return rowHTML;
                    }).join('');
                    
                    leaderboardTable.innerHTML = tableHTML;
                    console.log('‚úÖ Tabla de clasificaci√≥n actualizada');
                }
            }

            getMedalIcon(position) {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                return position <= 3 ? medals[position - 1] + ' ' : '';
            }

            getLeagueIcon(league) {
                const icons = {
                    'gold': 'ü•á',
                    'platinum': 'ü•à', 
                    'diamond': 'üíé'
                };
                return icons[league] || 'üèÜ';
            }

            getLeagueName(league) {
                const names = {
                    'gold': 'Oro',
                    'platinum': 'Platino',
                    'diamond': 'Diamante'
                };
                return names[league] || 'Desconocida';
            }
        }

        // Inicializar sistemas - se mover√° dentro de DOMContentLoaded

        // Event listener para el bot√≥n de debug - se mover√° dentro de DOMContentLoaded

        // Funci√≥n global para debug manual
        window.debugLoadUsers = async function() {
            console.log('üîç Funci√≥n debugLoadUsers llamada manualmente...');
            
            if (window.leagueFilterSystem) {
                console.log('‚úÖ LeagueFilterSystem disponible, cargando usuarios...');
                await window.leagueFilterSystem.loadAllUsers();
                window.leagueFilterSystem.updateLeaderboard();
            } else {
                console.error('‚ùå LeagueFilterSystem no est√° disponible');
            }
        };

        // Funci√≥n de prueba para verificar la conexi√≥n a Supabase
        async function testSupabaseConnection() {
            console.log('üß™ Probando conexi√≥n a Supabase...');
            
            if (!window.supabase) {
                console.error('‚ùå Supabase no est√° disponible');
                return false;
            }

            try {
                // Hacer una consulta simple para verificar la conexi√≥n
                const { data, error } = await window.supabase
                    .from('users')
                    .select('count')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Error en conexi√≥n a Supabase:', error);
                    return false;
                }

                console.log('‚úÖ Conexi√≥n a Supabase exitosa');
                console.log('üìä Datos de prueba:', data);
                return true;
            } catch (error) {
                console.error('‚ùå Error probando conexi√≥n:', error);
                return false;
            }
        }

        // Sistema de filtros de liga - CLASE DUPLICADA ELIMINADA COMPLETAMENTE

        // OPTIMIZACI√ìN: Funci√≥n para inicializar sistemas cuando Supabase est√© listo
        async function initializeSystemsWhenReady() {
            console.log('üöÄ Inicializando sistemas cuando Supabase est√© listo...');
            console.log('üîç Supabase disponible globalmente:', !!window.supabase);
            console.log('üîç SUPABASE_URL disponible:', !!window.SUPABASE_URL);
            console.log('üîç SUPABASE_ANON_KEY disponible:', !!window.SUPABASE_ANON_KEY);

            // OPTIMIZACI√ìN: Inicializar solo CommunitySystem primero para cargar banner
            window.communitySystem = new CommunitySystem();
            
            console.log('üîç CommunitySystem inicializado:', !!window.communitySystem);
            console.log('üîç CommunitySystem.db disponible:', !!window.communitySystem?.db);
            console.log('üîç CommunitySystem.db.supabase disponible:', !!window.communitySystem?.db?.supabase);
            
            // OPTIMIZACI√ìN: Cargar estado de acceso inmediatamente despu√©s del banner
            await loadAccessState();

            // OPTIMIZACI√ìN: Inicializar otros sistemas en paralelo (no cr√≠ticos para el banner)
            const otherSystemsPromise = initializeOtherSystems();
            
            // Verificar estado de Supabase en paralelo
            const supabaseCheckPromise = checkSupabaseStatus();
            
            // Probar conexi√≥n a Supabase en paralelo
            const connectionTestPromise = testSupabaseConnection();
            
            // Sincronizar con Supabase en paralelo
            const syncPromise = syncWithSupabase();
            
            // Esperar a que terminen las tareas cr√≠ticas
            await Promise.allSettled([
                otherSystemsPromise,
                supabaseCheckPromise,
                connectionTestPromise,
                syncPromise
            ]);
            
            console.log('‚úÖ Community system initialized');
        }

        // OPTIMIZACI√ìN: Funci√≥n para cargar banner inmediatamente desde localStorage
        function loadBannerFromLocalStorage() {
            console.log('üöÄ Cargando banner desde localStorage...');
            
            // Obtener slug de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const communitySlug = urlParams.get('slug') || 'general';
            
            // Buscar datos de comunidad en localStorage
            const savedCommunities = localStorage.getItem('savedCommunities');
            if (savedCommunities) {
                try {
                    const communities = JSON.parse(savedCommunities);
                    const community = communities.find(c => c.slug === communitySlug);
                    
                    if (community) {
                        console.log('‚úÖ Comunidad encontrada en localStorage:', community);
                        
                        // Actualizar banner inmediatamente
                        const bannerTitle = document.getElementById('communityBannerTitle');
                        const bannerDesc = document.getElementById('communityBannerDesc');
                        const bannerMeta = document.getElementById('communityBannerMeta');
                        const bannerContainer = document.getElementById('communityBanner');
                        const bannerImage = document.getElementById('communityBannerImage');
                        
                        if (bannerTitle) {
                            bannerTitle.textContent = community.name || 'Comunidad';
                        }
                        if (bannerDesc) {
                            bannerDesc.textContent = community.description || 'Descripci√≥n de la comunidad';
                        }
                        if (bannerMeta) {
                            const accessType = community.access_type || 'Free';
                            bannerMeta.textContent = `‚Ä¢ Cargando... ‚Ä¢ ${accessType}`;
                        }
                        
                        // Cargar imagen del banner desde image_url de localStorage
                        if (bannerImage && community.image_url) {
                            console.log('üñºÔ∏è Cargando imagen del banner desde localStorage:', community.image_url);
                            bannerImage.style.backgroundImage = `url(${community.image_url})`;
                            bannerImage.style.display = 'block';
                        } else if (bannerImage) {
                            console.log('‚ö†Ô∏è No hay image_url disponible en localStorage para la comunidad');
                            bannerImage.style.display = 'none';
                        }
                        
                        // Marcar banner como cargado para ocultar skeleton
                        if (bannerContainer) {
                            bannerContainer.classList.add('banner-loaded');
                        }
                        
                        // Actualizar t√≠tulo de la p√°gina
                        document.title = `Comunidad de ${community.name}`;
                        
                        console.log('‚úÖ Banner cargado desde localStorage');
                        return;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error parseando comunidades guardadas:', error);
                }
            }
            
            // Fallback: mostrar datos b√°sicos
            console.log('‚ö†Ô∏è No se encontr√≥ comunidad en localStorage, usando fallback');
            const bannerTitle = document.getElementById('communityBannerTitle');
            const bannerDesc = document.getElementById('communityBannerDesc');
            const bannerMeta = document.getElementById('communityBannerMeta');
            const bannerContainer = document.getElementById('communityBanner');
            const bannerImage = document.getElementById('communityBannerImage');
            
            if (bannerTitle) {
                bannerTitle.textContent = 'Comunidad';
            }
            if (bannerDesc) {
                bannerDesc.textContent = 'Cargando informaci√≥n...';
            }
            if (bannerMeta) {
                bannerMeta.textContent = '‚Ä¢ Cargando... ‚Ä¢ Free';
            }
            
            // Ocultar imagen del banner en fallback
            if (bannerImage) {
                bannerImage.style.display = 'none';
            }
            
            if (bannerContainer) {
                bannerContainer.classList.add('banner-loaded');
            }
        }

        // OPTIMIZACI√ìN: Funci√≥n separada para inicializar sistemas no cr√≠ticos
        async function initializeOtherSystems() {
            console.log('üîÑ Inicializando sistemas secundarios...');
            
            // Inicializar sistemas secundarios
            window.pointsSystem = new PointsSystem();
            window.leagueFilterSystem = new LeagueFilterSystem();
            
            // Inicializar sistema de filtros de liga
            if (window.leagueFilterSystem) {
                console.log('üèÜ Inicializando sistema de filtros de liga...');
                await window.leagueFilterSystem.loadAllUsers();
                window.leagueFilterSystem.updateLeaderboard();
            }
            
            // Forzar actualizaci√≥n del display de ligas despu√©s de un breve delay
            setTimeout(async () => {
                if (window.pointsSystem) {
                    console.log('üîÑ Forcing league display update after page load...');
                    await window.pointsSystem.getCurrentUser();
                    await window.pointsSystem.refreshPointsFromDatabase();
                    window.pointsSystem.updateLeagueDisplay();
                }
                
                // Actualizar tambi√©n la clasificaci√≥n global
                if (window.leagueFilterSystem) {
                    console.log('üîÑ Actualizando clasificaci√≥n global...');
                    await window.leagueFilterSystem.loadAllUsers();
                    window.leagueFilterSystem.updateLeaderboard();
                }
            }, 1000); // 1 segundo de delay
            
            console.log('‚úÖ Sistemas secundarios inicializados');
        }

        // OPTIMIZACI√ìN: Cargar banner inmediatamente sin esperar Supabase
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOMContentLoaded - Cargando banner inmediatamente...');
            
            // OPTIMIZACI√ìN: Cargar banner b√°sico inmediatamente desde localStorage
            loadBannerFromLocalStorage();
            
            // Esperar a que Supabase est√© disponible (con menos intentos)
            let attempts = 0;
            const maxAttempts = 10; // 1 segundo m√°ximo
            
            while (attempts < maxAttempts) {
                if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                    console.log('‚úÖ Supabase est√° listo, inicializando sistemas...');
                    await initializeSystemsWhenReady();
                    return;
                }
                
                console.log(`‚è≥ Esperando Supabase... intento ${attempts + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.warn('‚ö†Ô∏è Supabase no se carg√≥ en el tiempo esperado, inicializando de todos modos...');
            await initializeSystemsWhenReady();
            
            // Actualizar el display de ligas cada 30 segundos para mantener sincronizaci√≥n
            setInterval(async () => {
                if (window.pointsSystem) {
                    await window.pointsSystem.getCurrentUser();
                    await window.pointsSystem.refreshPointsFromDatabase();
                    window.pointsSystem.updateLeagueDisplay();
                }
                
                // Actualizar tambi√©n la clasificaci√≥n global
                if (window.leagueFilterSystem) {
                    await window.leagueFilterSystem.loadAllUsers();
                    window.leagueFilterSystem.updateLeaderboard();
                }
            }, 30000); // 30 segundos
        });

        // Funci√≥n para verificar el estado de Supabase
        async function checkSupabaseStatus() {
            console.log('üîç Checking Supabase status...');
            console.log('window.supabase available:', !!window.supabase);

            if (window.supabase) {
                console.log('Supabase client details:', {
                    url: window.supabase.supabaseUrl,
                    key: window.supabase.supabaseKey ? 'Present' : 'Missing'
                });

                try {
                    // Verificar conexi√≥n intentando obtener usuarios
                    const { data: users, error } = await window.supabase
                        .from('users')
                        .select('id, username, display_name, first_name, points')
                        .limit(1);

                    if (error) {
                        console.error('‚ùå Supabase connection error:', error);
                    } else {
                        console.log('‚úÖ Supabase connection successful');
                        console.log('Sample users from database:', users);
                    }
                } catch (error) {
                    console.error('‚ùå Error testing Supabase connection:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Supabase client not initialized');
            }
        }

        // Funci√≥n para sincronizar datos con Supabase
        async function syncWithSupabase() {
            try {
                if (window.supabase) {
                    console.log('üîÑ Syncing with Supabase...');

                    // Obtener usuarios de Supabase
                    const { data: users, error } = await window.supabase
                        .from('users')
                        .select('id, username, display_name, first_name, points')
                        .not('points', 'is', null);

                    if (!error && users) {
                        console.log(`üìä Found ${users.length} users in Supabase`);

                        // Actualizar puntos en localStorage
                        const localUsers = JSON.parse(localStorage.getItem('communityUsers') || '[]');
                        const updatedUsers = localUsers.map(localUser => {
                            const supabaseUser = users.find(u =>
                                u.display_name === localUser.name ||
                                u.first_name === localUser.name ||
                                u.username === localUser.name
                            );

                            if (supabaseUser) {
                                return {
                                    ...localUser,
                                    id: supabaseUser.id,
                                    points: supabaseUser.points || localUser.points
                                };
                            }

                            return localUser;
                        });

                        localStorage.setItem('communityUsers', JSON.stringify(updatedUsers));
                        console.log('‚úÖ Data synced with Supabase');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error syncing with Supabase:', error);
            }
        }

        // ===== FUNCIONES DE ACCESO A COMUNIDADES =====

        async function getCurrentUserId() {
            try {
                // Usar el sistema robusto de autenticaci√≥n
                if (window.CommunityAuth) {
                    return await window.CommunityAuth.getCurrentUserId();
                }

                console.error('[ACCESS] ‚ùå CommunityAuth no est√° disponible');
                return null;
            } catch (error) {
                console.error('[ACCESS] ‚ùå Error obteniendo userId:', error);
                return null;
            }
        }

        async function isMember(communityId) {
            try {
                // Verificar sesi√≥n de Supabase primero
                if (!(await window.hasCommunitySession())) {
                    console.warn('[ACCESS] Sin sesi√≥n Supabase - no verificando membres√≠a');
                    return false;
                }

                // Obtener userId usando m√©todo robusto
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.warn('[ACCESS] Usuario no autenticado para verificar membres√≠a');
                    return false;
                }
                const { data, error } = await window.supabase
                    .from('community_members')
                    .select('user_id')
                    .eq('community_id', communityId)
                    .eq('user_id', userId)
                    .eq('is_active', true)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.warn('[ACCESS] Error verificando membres√≠a:', error);
                    return false;
                }

                return !!data;
            } catch (error) {
                console.error('[ACCESS] Error en isMember:', error);
                return false;
            }
        }

        async function getLastRequest(communityId) {
            try {
                // Verificar sesi√≥n de Supabase primero
                if (!(await window.hasCommunitySession())) {
                    console.warn('[ACCESS] Sin sesi√≥n Supabase - no obteniendo solicitudes');
                    return null;
                }

                // Obtener userId usando m√©todo robusto
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.warn('[ACCESS] Usuario no autenticado para obtener solicitudes');
                    return null;
                }
                const { data, error } = await window.supabase
                    .from('community_access_requests')
                    .select('id,status,created_at')
                    .eq('community_id', communityId)
                    .eq('requester_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.warn('[ACCESS] Error obteniendo solicitud:', error);
                    return null;
                }

                return (data && data[0]) || null;
            } catch (error) {
                console.error('[ACCESS] Error en getLastRequest:', error);
                return null;
            }
        }

        async function requestAccess(communityId) {
            try {
                console.log('[ACCESS] üöÄ Solicitando acceso a comunidad:', communityId);

                // Verificar sesi√≥n de Supabase primero
                if (!(await window.hasCommunitySession())) {
                    await window.requireCommunitySession();
                    showToast('Inicia sesi√≥n para solicitar acceso', 'warning');
                    return;
                }

                console.log('[ACCESS] üöÄ Solicitando acceso v√≠a RPC...');

                const { error } = await window.executeRPCWithAuth('rpc_request_access', {
                    p_community_id: communityId
                });

                if (error) {
                    console.error('[ACCESS] ‚ùå Error en RPC Supabase:', error);
                    throw error;
                }

                console.log('[ACCESS] ‚úÖ Solicitud creada exitosamente via RPC');
                showToast('Solicitud enviada exitosamente', 'success');
                return true;
            } catch (error) {
                console.error('[ACCESS] ‚ùå Error solicitando acceso:', error);

                // Manejar errores espec√≠ficos
                if (error?.status === 401 || error?.code === '401') {
                    showToast('Tu sesi√≥n expir√≥. Inicia sesi√≥n e int√©ntalo de nuevo.', 'error');
                } else if (error?.code === '42501') {
                    showToast('No tienes permisos para realizar esta acci√≥n.', 'error');
                } else {
                    showToast('No se pudo enviar la solicitud. Int√©ntalo m√°s tarde.', 'error');
                }

                console.error('[ACCESS] ‚ùå Error solicitando acceso:', error);
                showToast('Error enviando solicitud: ' + error.message, 'error');
                throw error;
            }
        }

        async function loadAccessState() {
            try {
                // Obtener slug de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const slug = urlParams.get('slug');
                if (!slug) return;

                // Buscar comunidad por slug (simplificado)
                const { data: communities, error } = await window.supabase
                    .from('communities')
                    .select('id, visibility, access_type')
                    .eq('slug', slug)
                    .maybeSingle();

                if (error || !communities) {
                    console.warn('[ACCESS] No se pudo cargar la comunidad');
                    return;
                }

                const community = communities;
                const isInviteOnly = community.visibility === 'invite_only' || community.access_type === 'invite_only';

                if (!isInviteOnly) {
                    // Es una comunidad gratuita (Free) - verificar sesi√≥n y registrar autom√°ticamente
                    console.log('üîì [ACCESS] Comunidad gratuita detectada, verificando sesi√≥n...');

                    const hasSession = await window.hasCommunitySession();
                    if (!hasSession) {
                        console.log('‚ö†Ô∏è [ACCESS] Sin sesi√≥n - usuario no puede unirse autom√°ticamente');
                        return;
                    }

                    // Verificar si ya es miembro
                    const isMemberResult = await isMember(community.id);
                    if (isMemberResult) {
                        console.log('‚úÖ [ACCESS] Usuario ya es miembro de la comunidad gratuita');
                        return;
                    }

                    // Usuario autenticado no es miembro - unirse autom√°ticamente
                    console.log('üöÄ [ACCESS] Registrando usuario autom√°ticamente en comunidad gratuita...');

                    try {
                        // Obtener instancia de CommunityDatabase
                        let db = null;
                        if (window.communitySystem && window.communitySystem.db) {
                            db = window.communitySystem.db;
                        } else if (typeof CommunityDatabase !== 'undefined') {
                            db = new CommunityDatabase();
                            await db.initialize();
                        } else {
                            console.error('‚ùå [ACCESS] CommunityDatabase no disponible');
                            return;
                        }

                        // Llamar a joinCommunity
                        const joinSuccess = await db.joinCommunity(community.id);

                        if (joinSuccess) {
                            console.log('‚úÖ [ACCESS] Usuario registrado autom√°ticamente en comunidad gratuita');

                            // Mostrar notificaci√≥n de bienvenida
                            if (typeof notifications !== 'undefined') {
                                notifications.success(`¬°Bienvenido a la comunidad "${community.name}"!`);
                            }

                            // Recargar miembros si existe el sistema
                            if (window.communitySystem && typeof window.communitySystem.loadMembers === 'function') {
                                await window.communitySystem.loadMembers();
                            }
                        } else {
                            console.error('‚ùå [ACCESS] Error registrando usuario en comunidad gratuita');
                        }
                    } catch (error) {
                        console.error('‚ùå [ACCESS] Error cr√≠tico registrando usuario:', error);
                    }

                    return;
                }

                // Verificar sesi√≥n de Supabase
                const hasSession = await window.hasCommunitySession();

                if (!hasSession) {
                    // Sin sesi√≥n, mostrar bot√≥n de login
                    const bannerActions = document.getElementById('communityBannerActions');
                    const requestAccessBtn = document.getElementById('requestAccessBtn');

                    if (bannerActions) {
                        bannerActions.style.display = 'block';
                    }

                    if (requestAccessBtn) {
                        requestAccessBtn.style.display = 'block';
                        requestAccessBtn.textContent = 'Inicia sesi√≥n';
                        requestAccessBtn.classList.remove('btn-primary');
                        requestAccessBtn.classList.add('btn-secondary');
                        requestAccessBtn.addEventListener('click', async () => {
                            await window.requireCommunitySession();
                        });
                    }

                    // Bloquear UI del composer
                    blockComposerUI();
                    return;
                }

                // Con sesi√≥n, verificar si es miembro
                const isMemberResult = await isMember(community.id);

                if (isMemberResult) {
                    // Es miembro, no bloquear UI
                    return;
                }

                // No es miembro de comunidad invite_only
                // Mostrar bot√≥n de solicitud y bloquear UI
                const bannerActions = document.getElementById('communityBannerActions');
                const requestAccessBtn = document.getElementById('requestAccessBtn');
                const requestPendingBtn = document.getElementById('requestPendingBtn');

                if (bannerActions) {
                    bannerActions.style.display = 'block';
                }

                // Verificar estado de solicitud
                const lastRequest = await getLastRequest(community.id);

                if (lastRequest && lastRequest.status === 'pending') {
                    // Mostrar bot√≥n de pendiente
                    if (requestPendingBtn) {
                        requestPendingBtn.style.display = 'block';
                    }
                } else {
                    // Mostrar bot√≥n de solicitar acceso
                    if (requestAccessBtn) {
                        requestAccessBtn.style.display = 'block';
                        requestAccessBtn.addEventListener('click', async () => {
                            requestAccessBtn.disabled = true;
                            requestAccessBtn.textContent = 'Enviando...';

                            try {
                                await requestAccess(community.id);
                                // Cambiar a estado pendiente
                                requestAccessBtn.style.display = 'none';
                                if (requestPendingBtn) {
                                    requestPendingBtn.style.display = 'block';
                                }
                            } catch (error) {
                                requestAccessBtn.disabled = false;
                                requestAccessBtn.textContent = 'Solicitar acceso';
                            }
                        });
                    }
                }

                // Bloquear UI del composer
                blockComposerUI();

            } catch (error) {
                console.error('[ACCESS] Error cargando estado de acceso:', error);
            }
        }

        function blockComposerUI() {
            const composerInput = document.getElementById('composerInput');
            const publishPostBtn = document.getElementById('publishPostBtn');
            const composerCard = document.querySelector('.composer-card');

            if (composerInput) {
                composerInput.disabled = true;
                composerInput.placeholder = 'Necesitas acceso para participar en esta comunidad';
            }

            if (publishPostBtn) {
                publishPostBtn.disabled = true;
                publishPostBtn.textContent = 'Acceso requerido';
            }

            if (composerCard) {
                composerCard.style.opacity = '0.6';
                composerCard.style.pointerEvents = 'none';
            }
        }

        function showToast(message, type = 'info') {
            // Usar sistema de toast existente o crear uno simple
            console.log(`[TOAST ${type.toUpperCase()}] ${message}`);

            // Intentar usar el sistema existente de toasts
            if (window.showToast) {
                window.showToast(message, type);
            } else {
                // Fallback simple
                alert(message);
            }
        }

        // ===================================
        // SISTEMA DE MODAL DE PERFIL DE USUARIO
        // ===================================

        // Inicializar event listeners cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserProfileModal();
        });

        function initializeUserProfileModal() {
            console.log('üîç [PROFILE MODAL] Inicializando sistema de modal de perfil...');

            // Event listeners para tarjetas de miembros
            setupMemberCardListeners();

            // Event listeners para cerrar modal
            setupModalCloseListeners();

            // Event listener para tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeUserProfile();
                }
            });

            console.log('‚úÖ [PROFILE MODAL] Sistema inicializado correctamente');
        }

        function setupMemberCardListeners() {
            // Funci√≥n para agregar listeners a las tarjetas existentes
            function addListenersToCards() {
                const memberCards = document.querySelectorAll('.member-card[data-user-id]');
                console.log(`üîç [PROFILE MODAL] Configurando listeners para ${memberCards.length} tarjetas`);

                memberCards.forEach(card => {
                    // Remover listener anterior si existe
                    card.removeEventListener('click', handleMemberCardClick);
                    // Agregar nuevo listener
                    card.addEventListener('click', handleMemberCardClick);
                });
            }

            // Configurar listeners iniciales
            addListenersToCards();

            // Observar cambios en el DOM para nuevas tarjetas
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        addListenersToCards();
                    }
                });
            });

            const membersList = document.getElementById('membersList');
            if (membersList) {
                observer.observe(membersList, {
                    childList: true,
                    subtree: true
                });
            }
        }

        function handleMemberCardClick(event) {
            event.preventDefault();
            event.stopPropagation();

            const userId = this.getAttribute('data-user-id');
            if (!userId) {
                console.warn('[PROFILE MODAL] No se encontr√≥ user-id en la tarjeta');
                return;
            }

            console.log(`üîç [PROFILE MODAL] Click en tarjeta de usuario: ${userId}`);
            openUserProfile(userId);
        }

        function setupModalCloseListeners() {
            const modal = document.getElementById('userProfileModal');
            const overlay = document.getElementById('modalOverlay');
            const closeBtn = document.getElementById('closeProfileModal');

            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeUserProfile();
                });
            }

            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    // Solo cerrar si el click es exactamente en el overlay
                    if (e.target === overlay) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeUserProfile();
                    }
                });
            }

            if (modal) {
                // Prevenir cierre al hacer click dentro del modal
                const profileCard = modal.querySelector('.profile-card');
                if (profileCard) {
                    profileCard.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }

                // Prevenir propagaci√≥n en todo el modal
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeUserProfile();
                    }
                });
            }
        }

        // üö® FUNCI√ìN PARA OBTENER ACTIVIDAD REAL DEL USUARIO
        async function getRealUserActivity(userId) {
            try {
                console.log('üìä Obteniendo actividad real para usuario:', userId);

                // Ejecutar todas las consultas en paralelo para mejor rendimiento
                const [postsResult, commentsResult, reactionsResult] = await Promise.allSettled([
                    // 1. Contar publicaciones reales desde community_posts
                    window.supabase
                        .from('community_posts')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', userId),

                    // 2. Contar comentarios reales desde community_comments (excluyendo eliminados)
                    window.supabase
                        .from('community_comments')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', userId)
                        .eq('is_deleted', false),

                    // 3. Contar reacciones reales desde community_reactions
                    window.supabase
                        .from('community_reactions')
                        .select('*', { count: 'exact', head: true })
                        .eq('user_id', userId)
                ]);

                // Procesar resultados con manejo de errores
                const posts = postsResult.status === 'fulfilled' ? (postsResult.value.count || 0) : 0;
                const comments = commentsResult.status === 'fulfilled' ? (commentsResult.value.count || 0) : 0;
                const reactions = reactionsResult.status === 'fulfilled' ? (reactionsResult.value.count || 0) : 0;

                const activity = { posts, comments, reactions };

                console.log('üìä Actividad real obtenida:', activity);
                console.log('üìä Detalles:', {
                    posts: `${posts} publicaciones`,
                    comments: `${comments} comentarios`,
                    reactions: `${reactions} reacciones`
                });

                return activity;

            } catch (error) {
                console.error('‚ùå Error obteniendo actividad real:', error);
                return { posts: 0, comments: 0, reactions: 0 };
            }
        }

        // üö® FUNCI√ìN PARA OBTENER RANKING REAL DEL USUARIO
        async function getRealUserRanking(userId) {
            try {
                console.log('üèÜ Calculando ranking real para usuario:', userId);

                // Obtener todos los usuarios ordenados por puntos (descendente)
                const { data: allUsers, error } = await window.supabase
                    .from('users')
                    .select('id, points')
                    .not('points', 'is', null) // Excluir usuarios sin puntos
                    .order('points', { ascending: false });

                if (error) throw error;

                // Encontrar la posici√≥n del usuario actual
                const userIndex = allUsers.findIndex(user => user.id === userId);
                const userRank = userIndex >= 0 ? userIndex + 1 : 0;
                const totalUsers = allUsers.length;

                const ranking = {
                    rank: userRank,
                    total: totalUsers
                };

                console.log('üèÜ Ranking real calculado:', ranking);
                console.log('üèÜ Usuario en posici√≥n:', userRank, 'de', totalUsers, 'usuarios');

                return ranking;

            } catch (error) {
                console.error('‚ùå Error calculando ranking real:', error);
                return { rank: 0, total: 0 };
            }
        }

        // üö® FUNCIONES HELPER PARA C√ÅLCULOS REALES

        // Calcular liga real basada en puntos
        function getRealLeagueFromPoints(points) {
            if (!points || points < 0) return 'Sin Liga';
            if (points < 100) return 'Bronce';
            if (points < 500) return 'Plata';
            if (points < 1000) return 'Oro';
            if (points < 2000) return 'Platino';
            if (points < 5000) return 'Diamante';
            return 'Maestro';
        }

        // Calcular tiempo transcurrido real
        function getRealTimeAgo(timestamp) {
            if (!timestamp) return 'Nunca visto';

            const now = new Date();
            const lastSeen = new Date(timestamp);
            const diffMs = now - lastSeen;

            const minutes = Math.floor(diffMs / (1000 * 60));
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (minutes < 1) return 'Ahora mismo';
            if (minutes < 60) return `Hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
            if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            if (days < 30) return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
            return `Hace m√°s de un mes`;
        }

        // Calcular fecha de membres√≠a real
        function getRealMemberSince(createdAt) {
            if (!createdAt) return 'Fecha desconocida';

            const date = new Date(createdAt);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 1) return 'Hoy';
            if (diffDays < 30) return `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
            if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                return `Hace ${months} mes${months > 1 ? 'es' : ''}`;
            }
            const years = Math.floor(diffDays / 365);
            return `Hace ${years} a√±o${years > 1 ? 's' : ''}`;
        }

        // Funci√≥n mejorada para manejar el avatar
        function updateProfileAvatar(user) {
            const avatarContainer = document.getElementById('profileAvatarContainer');
            const avatarImg = document.getElementById('profileAvatar');
            const avatarFallback = document.getElementById('profileAvatarFallback');
            
            if (!avatarContainer || !avatarImg || !avatarFallback) {
                console.warn('‚ö†Ô∏è [AVATAR] Elementos del avatar no encontrados');
                return;
            }
            
            // Limpiar clases anteriores
            avatarContainer.classList.remove('has-image');
            
            // Verificar si el usuario tiene imagen v√°lida (versi√≥n menos estricta para perfil)
            const hasValidImage = user.profile_picture_url && 
                                 user.profile_picture_url.trim() !== '' && 
                                 user.profile_picture_url !== 'null' &&
                                 user.profile_picture_url !== 'undefined';
            
            if (hasValidImage) {
                // Usuario tiene imagen
                avatarImg.src = user.profile_picture_url;
                avatarImg.style.display = 'block';
                avatarFallback.style.display = 'none';
                avatarContainer.classList.add('has-image');
                
                // Manejar error de carga de imagen
                avatarImg.onerror = function() {
                    console.warn('‚ö†Ô∏è [AVATAR] Error cargando imagen, mostrando fallback');
                    this.style.display = 'none';
                    avatarFallback.style.display = 'flex';
                    avatarContainer.classList.remove('has-image');
                };
                
                // Confirmar que la imagen se carg√≥ correctamente
                avatarImg.onload = function() {
                    console.log('‚úÖ [AVATAR] Imagen cargada correctamente');
                };
            } else {
                // Usuario no tiene imagen, mostrar fallback
                console.log('‚ÑπÔ∏è [AVATAR] Usuario sin imagen, mostrando fallback');
                avatarImg.style.display = 'none';
                avatarFallback.style.display = 'flex';
                avatarContainer.classList.remove('has-image');
            }
            
            // Asegurar que el contenedor del avatar mantenga su tama√±o
            avatarContainer.style.width = '120px';
            avatarContainer.style.height = '120px';
        }

        // Funci√≥n para actualizar UI con datos reales
        function updateProfileModalWithRealData(data) {
            const { user, activity, ranking, league, lastSeen, memberSince } = data;

            console.log('üîç VERIFICACI√ìN FINAL - DATOS COMPLETAMENTE REALES:');
            console.log('  - Usuario ID:', user.id);
            console.log('  - Puntos desde BD:', user.points);
            console.log('  - Ranking calculado:', `#${ranking.rank} de ${ranking.total}`);
            console.log('  - Posts reales:', activity.posts);
            console.log('  - Comentarios reales:', activity.comments);
            console.log('  - Reacciones reales:', activity.reactions);
            console.log('  - Liga calculada:', league);

            // 1. Datos b√°sicos del usuario
            setText('profileName', user.display_name || user.first_name || user.username || 'Usuario');
            setText('profileUsername', `@${user.username || 'usuario'}`);
            setText('profileEmail', user.email || 'No especificado');
            setText('profileLocation', user.location || 'No especificado');
            setText('profileBio', user.bio || 'Sin biograf√≠a disponible');
            
            // 2. Actualizar avatar con funci√≥n mejorada
            updateProfileAvatar(user);

            // 2. Estad√≠sticas REALES
            setText('profilePoints', (user.points || 0).toLocaleString());
            setText('profileRank', ranking.rank > 0 ? `#${ranking.rank} de ${ranking.total}` : 'Sin ranking');
            setText('profileJoinDate', memberSince);

            // 3. Actividad REAL en la comunidad
            setText('profilePosts', activity.posts);
            setText('profileComments', activity.comments);
            setText('profileReactions', activity.reactions);

            // 4. Liga real
            setText('profileLeague', league);

            // 5. √öltima vez visto real
            const lastSeenElement = document.getElementById('profileLastSeen');
            if (lastSeenElement) {
                lastSeenElement.textContent = lastSeen;
            }

            // 6. Avatar
            const avatarImg = document.getElementById('userProfileAvatar');
            if (avatarImg && user.profile_picture_url && user.profile_picture_url.trim() !== '') {
                avatarImg.src = user.profile_picture_url;
                avatarImg.style.display = 'block';
            }

            console.log('‚úÖ UI ACTUALIZADA CON DATOS REALES');
        }

        // Helper para setText
        function setText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        // Mostrar error en el perfil
        function showProfileError(message) {
            console.error('‚ùå Error en perfil:', message);
            // Puedes agregar aqu√≠ una notificaci√≥n visual al usuario
            if (window.notifications) {
                window.notifications.error(message);
            }
        }

        // üö® FUNCI√ìN PRINCIPAL PARA CARGAR DATOS REALES (DIRECTA A SUPABASE)
        async function loadRealUserProfile(userId) {
            try {
                console.log('üîÑ Cargando datos REALES del usuario:', userId);

                // 1. Obtener datos b√°sicos del usuario
                const { data: user, error: userError } = await window.supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (userError) throw userError;

                // 2. Obtener actividad real del usuario
                const activity = await getRealUserActivity(userId);
                console.log('üìä Actividad real:', activity);

                // 3. Obtener ranking real del usuario
                const ranking = await getRealUserRanking(userId);
                console.log('üèÜ Ranking real:', ranking);

                // 4. Calcular liga real basada en puntos
                const realLeague = getRealLeagueFromPoints(user.points);
                console.log('üéØ Liga real:', realLeague);

                // 5. Calcular tiempo transcurrido real
                const realLastSeen = getRealTimeAgo(user.last_login_at);
                console.log('üïê √öltima vez visto real:', realLastSeen);

                // 6. Calcular fecha de membres√≠a real
                const realMemberSince = getRealMemberSince(user.created_at);
                console.log('üìÖ Miembro desde real:', realMemberSince);

                // 7. Actualizar UI con datos REALES
                updateProfileModalWithRealData({
                    user,
                    activity,
                    ranking,
                    league: realLeague,
                    lastSeen: realLastSeen,
                    memberSince: realMemberSince
                });

                console.log('‚úÖ PERFIL ACTUALIZADO CON DATOS REALES');

            } catch (error) {
                console.error('‚ùå ERROR AL CARGAR PERFIL REAL:', error);
                showProfileError('Error al cargar datos del perfil');
            }
        }

        // üö® FUNCI√ìN LEGACY - REDIRIGE A NUEVA IMPLEMENTACI√ìN CON DATOS REALES
        function updateProfileModal(data) {
            console.log('‚ö†Ô∏è [LEGACY] updateProfileModal llamada - redirigiendo a implementaci√≥n real');

            // Esta funci√≥n legacy ahora redirige a la implementaci√≥n real
            if (data && data.user && data.user.id) {
                console.log('‚úÖ [LEGACY] Redirigiendo a loadRealUserProfile con userId:', data.user.id);
                loadRealUserProfile(data.user.id);
            } else {
                console.error('‚ùå [LEGACY] Datos inv√°lidos para actualizar perfil:', data);
                showProfileError('No se pudieron cargar los datos del perfil');
            }

            // 1. ‚≠ê BIOGRAF√çA (FALTANTE - AGREGAR)
            const bioElement = document.getElementById('profileBio');
            if (bioElement) {
                bioElement.textContent = user.bio || 'No hay biograf√≠a disponible';
                const bioSection = document.getElementById('bioSection');
                if (bioSection) {
                    bioSection.style.display = user.bio ? 'block' : 'none';
                }
                console.log('‚úÖ BIOGRAF√çA ACTUALIZADA EN UI:', user.bio || 'No disponible');
            }

            // 2. ‚≠ê CARGO EN LA EMPRESA (FALTANTE - AGREGAR)
            const cargoElement = document.getElementById('profileRole');
            if (cargoElement) {
                cargoElement.textContent = user.cargo_rol || 'Cargo no especificado';
                cargoElement.style.display = user.cargo_rol ? 'inline-block' : 'none';
                console.log('‚úÖ CARGO ACTUALIZADO EN UI:', user.cargo_rol || 'No especificado');
            }

            // 3. ‚≠ê LIGA INFERIOR (HARDCODEADA - CORREGIR)
            const leagueElement = document.getElementById('profileLeagueDisplay');
            if (leagueElement) {
                leagueElement.textContent = stats.league; // ‚≠ê DATO REAL
                console.log('‚úÖ LIGA INFERIOR ACTUALIZADA EN UI:', stats.league);
            }

            // 4. ‚≠ê RANKING (HARDCODEADO - CORREGIR)
            const rankingElement = document.getElementById('profileRanking');
            if (rankingElement) {
                rankingElement.textContent = `#${stats.ranking.position} de ${stats.ranking.total_users}`; // ‚≠ê DATO REAL
                console.log('‚úÖ RANKING ACTUALIZADO EN UI:', `#${stats.ranking.position} de ${stats.ranking.total_users}`);
            }

            // 5. ‚≠ê √öLTIMA VEZ VISTO (HARDCODEADO - CORREGIR)
            const lastSeenElement = document.getElementById('profileLastSeen');
            if (lastSeenElement) {
                lastSeenElement.textContent = stats.last_seen; // ‚≠ê DATO REAL
                console.log('‚úÖ √öLTIMA VEZ VISTO ACTUALIZADO EN UI:', stats.last_seen);
            }

            // 6. ‚≠ê POSTS REALIZADOS (HARDCODEADO - CORREGIR)
            const postsElement = document.getElementById('profilePosts');
            if (postsElement) {
                postsElement.textContent = `${stats.posts_count} posts realizados`; // ‚≠ê DATO REAL
                console.log('‚úÖ POSTS REALIZADOS ACTUALIZADO EN UI:', `${stats.posts_count} posts realizados`);
            }

            // 7. ‚≠ê MIEMBRO DESDE (HARDCODEADO - CORREGIR)
            const memberSinceElement = document.getElementById('profileJoinDate');
            if (memberSinceElement) {
                memberSinceElement.textContent = stats.member_since; // ‚≠ê DATO REAL
                console.log('‚úÖ MIEMBRO DESDE ACTUALIZADO EN UI:', stats.member_since);
            }

            // 8. ‚≠ê PUNTOS (VERIFICAR SI EST√Å CONECTADO)
            const pointsElement = document.getElementById('profilePoints');
            if (pointsElement) {
                pointsElement.textContent = user.points; // ‚≠ê DATO REAL
                console.log('‚úÖ PUNTOS ACTUALIZADOS EN UI:', user.points);
            }

            // 9. ‚≠ê LIGA SUPERIOR (VERIFICAR SI EST√Å CONECTADO)
            const topLeagueElement = document.getElementById('profileLeague');
            if (topLeagueElement) {
                topLeagueElement.textContent = `Liga ${user.type_rol || 'Miembro'}`; // ‚≠ê DATO REAL
                console.log('‚úÖ LIGA SUPERIOR ACTUALIZADA EN UI:', `Liga ${user.type_rol || 'Miembro'}`);
            }

            // Informaci√≥n b√°sica
            const nameElement = document.getElementById('profileName');
            if (nameElement) {
                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() ||
                               user.display_name || user.username || 'Usuario';
                nameElement.textContent = fullName;
            }

            const usernameElement = document.getElementById('profileUsername');
            if (usernameElement) {
                usernameElement.textContent = `@${user.username || 'usuario'}`;
            }

            // Actualizar avatar con funci√≥n mejorada
            updateProfileAvatar(user);

            // Mostrar modal
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('loading');
                modal.classList.add('active');
            }

            // üö® LOG FINAL DE VERIFICACI√ìN SEG√öN DOCUMENTO
            console.log('üéâ ‚úÖ VERIFICACI√ìN COMPLETADA - TODOS LOS DATOS SON REALES');
            console.log('üî• CRITERIO DE √âXITO CUMPLIDO: NO HAY VALORES HARDCODEADOS');
            console.log('üìã RESUMEN IMPLEMENTACI√ìN:');
            console.log('   ‚úÖ Liga inferior calculada desde puntos reales');
            console.log('   ‚úÖ Ranking real calculado desde BD');
            console.log('   ‚úÖ √öltima vez visto calculado desde last_login_at');
            console.log('   ‚úÖ Posts realizados contados desde community_posts');
            console.log('   ‚úÖ Miembro desde calculado desde created_at');
            console.log('   ‚úÖ Biograf√≠a mostrada desde campo bio');
            console.log('   ‚úÖ Cargo mostrado desde campo cargo_rol');
            console.log('   ‚úÖ Puntos conectados a BD');
            console.log('   ‚úÖ Liga superior conectada a BD');
        }

        // üö® FUNCI√ìN DE VERIFICACI√ìN - EJECUTAR AL CARGAR EL MODAL (EXACTA SEG√öN DOCUMENTO)
        function verifyRealData(userId) {
            console.log('üîç VERIFICANDO DATOS REALES PARA USUARIO:', userId);

            // Verificar que se est√°n obteniendo datos reales
            loadRealUserProfile(userId).then(() => {
                console.log('‚úÖ VERIFICACI√ìN COMPLETADA - TODOS LOS DATOS SON REALES');
            }).catch((error) => {
                console.error('‚ùå ERROR EN VERIFICACI√ìN:', error);
            });
        }

        // Funci√≥n legacy para compatibilidad
        async function getUserData(userId) {
            return await loadRealUserProfile(userId);
        }

        // Funci√≥n de fallback usando Supabase directo
        async function getUserDataFallback(userId) {
            try {
                console.log(`‚ö†Ô∏è [PROFILE MODAL] Usando fallback a Supabase para usuario: ${userId}`);

                if (!window.supabase) {
                    console.error('[PROFILE MODAL] Supabase no disponible');
                    return null;
                }

                const { data: userData, error } = await window.supabase
                    .from('users')
                    .select(`
                        id,
                        username,
                        email,
                        first_name,
                        last_name,
                        display_name,
                        cargo_rol,
                        type_rol,
                        bio,
                        location,
                        phone,
                        profile_picture_url,
                        curriculum_url,
                        linkedin_url,
                        github_url,
                        website_url,
                        points,
                        created_at,
                        updated_at,
                        last_login_at,
                        email_verified
                    `)
                    .eq('id', userId)
                    .single();

                if (error) {
                    console.error('[PROFILE MODAL] Error obteniendo datos del usuario:', error);
                    return null;
                }

                console.log('‚úÖ [PROFILE MODAL] Datos del usuario obtenidos desde Supabase (fallback):', userData);
                return userData;
            } catch (error) {
                console.error('[PROFILE MODAL] Error en getUserDataFallback:', error);
                return null;
            }
        }

        // Abrir modal con datos del usuario
        async function openUserProfile(userId) {
            try {
                console.log(`üîç [PROFILE MODAL] Abriendo perfil para usuario: ${userId}`);

                // Mostrar modal con skeleton loader
                showProfileModalSkeleton();

                // üö® USAR VERIFICACI√ìN REAL SEG√öN DOCUMENTO
                verifyRealData(userId);

            } catch (error) {
                console.error('[PROFILE MODAL] Error abriendo perfil:', error);
                showProfileError('Error cargando el perfil');
            }
        }

        // Poblar modal con datos del usuario
        function populateProfileModal(userData) {
            console.log('üîç [PROFILE MODAL] Poblando modal con datos:', userData);

            // Informaci√≥n b√°sica
            const nameElement = document.getElementById('profileName');
            if (nameElement) {
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() ||
                               userData.display_name || userData.username || 'Usuario';
                nameElement.textContent = fullName;
            }

            const usernameElement = document.getElementById('profileUsername');
            if (usernameElement) {
                usernameElement.textContent = `@${userData.username || 'usuario'}`;
            }

            // Actualizar avatar con funci√≥n mejorada
            updateProfileAvatar(userData);

            // Estado online
            const onlineStatus = document.getElementById('profileOnlineStatus');
            if (onlineStatus && userData.last_login_at) {
                const lastLogin = new Date(userData.last_login_at);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastLogin) / (1000 * 60));

                if (diffMinutes < 5) {
                    // Usuario en l√≠nea
                    onlineStatus.style.display = 'block';
                    onlineStatus.classList.add('pulse');
                } else {
                    onlineStatus.style.display = 'none';
                }
            } else if (onlineStatus) {
                onlineStatus.style.display = 'none';
            }

            // Informaci√≥n profesional/rol
            const roleElement = document.getElementById('profileRole');
            if (roleElement && userData.cargo_rol) {
                roleElement.textContent = userData.cargo_rol;
                roleElement.style.display = 'inline-block';

                // Aplicar clase seg√∫n tipo de rol
                if (userData.type_rol === 'admin') {
                    roleElement.className = 'role-badge admin';
                } else {
                    roleElement.className = 'role-badge';
                }
            } else if (roleElement) {
                roleElement.style.display = 'none';
            }

            // Biograf√≠a
            const bioElement = document.getElementById('profileBio');
            const bioSection = document.getElementById('bioSection');
            if (bioElement && bioSection && userData.bio) {
                bioElement.textContent = userData.bio;
                bioSection.style.display = 'block';
            } else if (bioSection) {
                bioSection.style.display = 'none';
            }

            // Ubicaci√≥n
            const locationElement = document.getElementById('profileLocation');
            const locationItem = document.getElementById('profileLocationItem');
            if (locationElement && locationItem && userData.location) {
                locationElement.textContent = userData.location;
                locationItem.style.display = 'flex';
            } else if (locationItem) {
                locationItem.style.display = 'none';
            }

            // CV/Experiencia
            const cvElement = document.getElementById('profileCV');
            const cvSection = document.getElementById('cvSection');
            if (cvElement && cvSection && userData.curriculum_url) {
                cvElement.innerHTML = `<a href="${userData.curriculum_url}" target="_blank" class="profile-link">üìÑ Ver CV/Curr√≠culum</a>`;
                cvSection.style.display = 'block';
            } else if (cvSection) {
                cvSection.style.display = 'none';
            }

            // Estad√≠sticas de liga y puntos
            updateProfileStats(userData);

            // Fecha de registro
            updateJoinDate(userData);

            // Mostrar modal
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('loading');
                modal.classList.add('active');
            }

            console.log('‚úÖ [PROFILE MODAL] Modal poblado y mostrado');
        }


        // Actualizar estad√≠sticas y liga
        function updateProfileStats(userData) {
            const points = userData.points || 0;
            const league = getUserLeagueInfo(points);

            // Actualizar puntos
            const pointsElement = document.getElementById('profilePoints');
            if (pointsElement) {
                pointsElement.textContent = points.toLocaleString();
            }

            // Actualizar liga
            const leagueElement = document.getElementById('profileLeagueDisplay');
            const leagueBadge = document.getElementById('profileLeague');
            if (leagueElement && leagueBadge) {
                leagueElement.textContent = league.name;
                leagueBadge.textContent = `Liga ${league.name}`;
                leagueBadge.style.background = league.gradient;
            }

            // Mostrar ranking real desde las estad√≠sticas
            const rankingElement = document.getElementById('profileRanking');
            if (rankingElement && userData.stats && userData.stats.ranking) {
                const { position, total_users } = userData.stats.ranking;
                rankingElement.textContent = `#${position} de ${total_users}`;
            } else if (rankingElement) {
                // Fallback si no hay datos de ranking
                rankingElement.textContent = 'Ranking no disponible';
            }

            // Informaci√≥n de actividad
            updateActivityInfo(userData);
        }

        // Actualizar informaci√≥n de actividad
        function updateActivityInfo(userData) {
            // √öltima vez visto - USAR DATOS DE LA API PRIMERO
            const lastSeenElement = document.getElementById('profileLastSeen');
            if (lastSeenElement) {
                if (userData.stats && userData.stats.last_seen) {
                    // Usar el texto pre-calculado de la API
                    lastSeenElement.textContent = userData.stats.last_seen;
                } else if (userData.last_login_at) {
                    // Fallback: calcular manualmente
                    lastSeenElement.textContent = getTimeAgo(userData.last_login_at);
                } else {
                    lastSeenElement.textContent = 'Actividad desconocida';
                }
            }

            // Posts realizados REALES desde las estad√≠sticas
            const postsElement = document.getElementById('profilePosts');
            if (postsElement && userData.stats) {
                const realPostsCount = userData.stats.posts_count || 0;
                postsElement.textContent = `${realPostsCount} posts realizados`;
            } else if (postsElement) {
                // Fallback si no hay datos de posts
                postsElement.textContent = '0 posts realizados';
            }
        }

        // ‚≠ê FUNCI√ìN CORREGIDA - Calcular tiempo transcurrido REAL (EXACTA SEG√öN DOCUMENTO)
        function getRealTimeAgo(lastLoginAt) {
            console.log('üïê √öLTIMO LOGIN REAL:', lastLoginAt);

            if (!lastLoginAt) return "Nunca ha iniciado sesi√≥n";

            const now = new Date();
            const lastSeen = new Date(lastLoginAt);
            const diffInHours = Math.floor((now - lastSeen) / (1000 * 60 * 60));

            if (diffInHours < 1) return "hace menos de 1 hora";
            if (diffInHours < 24) return `hace ${diffInHours} horas`;

            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `hace ${diffInDays} d√≠as`;

            const diffInWeeks = Math.floor(diffInDays / 7);
            return `hace ${diffInWeeks} semanas`;
        }

        // ‚≠ê FUNCI√ìN CORREGIDA - Determinar liga REAL basada en puntos (EXACTA SEG√öN DOCUMENTO)
        function getRealLeagueFromPoints(points) {
            console.log('üéØ PUNTOS REALES DEL USUARIO:', points);

            if (points >= 2000) return "Diamante";
            if (points >= 1500) return "Platino";
            if (points >= 1000) return "Oro";
            if (points >= 500) return "Plata";
            return "Bronce";
        }

        // ‚≠ê FUNCI√ìN CORREGIDA - Calcular fecha de membres√≠a REAL (EXACTA SEG√öN DOCUMENTO)
        function getRealMemberSince(createdAt) {
            console.log('üìÖ FECHA REAL DE REGISTRO:', createdAt);

            const date = new Date(createdAt);
            const month = date.toLocaleString('es-ES', { month: 'long' });
            const year = date.getFullYear();
            return `Miembro desde ${month.charAt(0).toUpperCase() + month.slice(1)} ${year}`;
        }

        // Funci√≥n legacy para compatibilidad
        function getTimeAgo(timestamp) {
            return getRealTimeAgo(timestamp);
        }

        // Obtener informaci√≥n de liga con colores
        function getUserLeagueInfo(points) {
            if (points >= 1000) {
                return {
                    name: 'Diamante',
                    color: '#B9F2FF',
                    icon: 'üíé',
                    gradient: 'linear-gradient(135deg, #B9F2FF, #87CEEB)'
                };
            }
            if (points >= 500) {
                return {
                    name: 'Platino',
                    color: '#E5E4E2',
                    icon: 'ü•à',
                    gradient: 'linear-gradient(135deg, #E5E4E2, #C0C0C0)'
                };
            }
            return {
                name: 'Oro',
                color: '#FFD700',
                icon: 'ü•á',
                gradient: 'linear-gradient(135deg, #FFD700, #FFA500)'
            };
        }

        // Actualizar fecha de registro
        function updateJoinDate(userData) {
            const joinDateElement = document.getElementById('profileJoinDate');
            if (joinDateElement) {
                if (userData.stats && userData.stats.join_date) {
                    // Usar el texto pre-formateado de la API
                    joinDateElement.textContent = `Miembro desde ${userData.stats.join_date}`;
                } else if (userData.created_at) {
                    // Fallback: formatear manualmente
                    const joinDate = new Date(userData.created_at);
                    const formattedDate = joinDate.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long'
                    });
                    joinDateElement.textContent = `Miembro desde ${formattedDate}`;
                } else {
                    // Fallback final
                    joinDateElement.textContent = 'Fecha de registro no disponible';
                }
            }
        }

        // Cerrar modal
        function closeUserProfile() {
            console.log('üîç [PROFILE MODAL] Cerrando modal');
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('active');
                modal.classList.remove('loading');
            }
        }

        // Mostrar skeleton loader
        function showProfileModalSkeleton() {
            console.log('üîç [PROFILE MODAL] Mostrando skeleton loader');
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.add('active', 'loading');
                modal.style.display = 'flex';

                // Mostrar skeleton content en el modal
                const profileCard = modal.querySelector('.profile-card');
                if (profileCard) {
                    profileCard.innerHTML = `
                        <button class="close-btn" onclick="closeUserProfile()">√ó</button>
                        <div class="profile-loading-content" style="padding: 20px;">
                            <!-- Header skeleton -->
                            <div class="profile-header" style="display: flex; gap: 16px; margin-bottom: 24px;">
                                <div class="loading-skeleton" style="
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 50%;
                                "></div>
                                <div style="flex: 1;">
                                    <div class="loading-skeleton" style="
                                        height: 24px;
                                        width: 200px;
                                        margin-bottom: 8px;
                                    "></div>
                                    <div class="loading-skeleton" style="
                                        height: 16px;
                                        width: 120px;
                                        margin-bottom: 12px;
                                    "></div>
                                    <div style="display: flex; gap: 8px;">
                                        <div class="loading-skeleton" style="
                                            height: 20px;
                                            width: 80px;
                                        "></div>
                                        <div class="loading-skeleton" style="
                                            height: 20px;
                                            width: 100px;
                                        "></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats skeleton -->
                            <div class="profile-section" style="margin-bottom: 24px;">
                                <div class="loading-skeleton" style="
                                    height: 20px;
                                    width: 100px;
                                    margin-bottom: 16px;
                                "></div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="loading-skeleton" style="height: 60px;"></div>
                                    <div class="loading-skeleton" style="height: 60px;"></div>
                                </div>
                            </div>

                            <!-- Info skeleton -->
                            <div class="profile-section">
                                <div class="loading-skeleton" style="
                                    height: 20px;
                                    width: 150px;
                                    margin-bottom: 16px;
                                "></div>
                                <div class="loading-skeleton" style="
                                    height: 16px;
                                    width: 180px;
                                    margin-bottom: 8px;
                                "></div>
                                <div class="loading-skeleton" style="
                                    height: 16px;
                                    width: 160px;
                                "></div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Mostrar error
        function showProfileError(message) {
            console.error('[PROFILE MODAL] Error:', message);
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('loading');
                modal.classList.add('active'); // Mantener modal abierto para mostrar error

                // Mostrar contenido de error en el modal
                const profileCard = modal.querySelector('.profile-card');
                if (profileCard) {
                    profileCard.innerHTML = `
                        <button class="close-btn" onclick="closeUserProfile()">√ó</button>
                        <div class="profile-error-content" style="
                            text-align: center;
                            padding: 40px 20px;
                            color: var(--text-primary, #333);
                        ">
                            <div style="
                                font-size: 48px;
                                margin-bottom: 16px;
                                color: #dc3545;
                            ">‚ö†Ô∏è</div>
                            <h3 style="
                                margin: 0 0 12px 0;
                                font-size: 1.2rem;
                                color: var(--text-primary, #333);
                            ">Error cargando perfil</h3>
                            <p style="
                                margin: 0 0 20px 0;
                                color: var(--text-secondary, #666);
                                line-height: 1.5;
                            ">${message}</p>
                            <button
                                onclick="closeUserProfile()"
                                style="
                                    background: var(--accent-color, #007bff);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                "
                                onmouseover="this.style.opacity='0.9'"
                                onmouseout="this.style.opacity='1'"
                            >
                                Cerrar
                            </button>
                        </div>
                    `;
                }
            }

            // Tambi√©n mostrar toast para notificaci√≥n adicional
            if (typeof showToast === 'function') {
                showToast(message, 'error');
            }
        }

        // Event listeners para botones de acci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const viewPostsBtn = document.getElementById('viewPostsBtn');

            if (sendMessageBtn) {
                sendMessageBtn.addEventListener('click', function() {
                    showToast('Funcionalidad de mensajes en desarrollo', 'info');
                });
            }

            if (viewPostsBtn) {
                viewPostsBtn.addEventListener('click', function() {
                    showToast('Funcionalidad de posts en desarrollo', 'info');
                });
            }
        });

        console.log('‚úÖ [PROFILE MODAL] Sistema de modal de perfil cargado');
    </script>

    <!-- CORRECCIONES DEL MODAL DE PERFIL SEG√öN PROMPT -->
    <script>
        // Sistema de logging controlado - TEMPORAL: activado para debugging
        const DEBUG_PROFILE = true;

        function profileLog(message, data = null) {
            if (DEBUG_PROFILE) {
                console.log(`[PROFILE] ${message}`, data);
            }
        }

        function profileError(message, error = null) {
            console.error(`[PROFILE ERROR] ${message}`, error);
        }

        // Limpiar event listeners duplicados
        function cleanupModalEventListeners() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.replaceWith(modal.cloneNode(true));
            }
        }

        // Configurar listeners de cierre del modal
        function setupModalCloseListeners() {
            const modal = document.getElementById('userProfileModal');
            const overlay = document.getElementById('modalOverlay');
            const closeBtn = document.getElementById('closeProfileModal');

            if (!modal) return;

            // Cerrar con bot√≥n X
            if (closeBtn) {
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeUserProfile();
                };
            }

            // Cerrar con click en overlay
            if (overlay) {
                overlay.onclick = (e) => {
                    e.stopPropagation();
                    closeUserProfile();
                };
            }

            // Cerrar con ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    e.stopPropagation();
                    closeUserProfile();
                }
            });

            // Prevenir cierre autom√°tico - REMOVER cualquier setTimeout
            const existingTimeouts = window.modalTimeouts || [];
            existingTimeouts.forEach(timeout => clearTimeout(timeout));
            window.modalTimeouts = [];
        }

        // Funci√≥n helper para obtener el ID correcto del usuario desde community_members
        async function getCorrectUserId(memberId) {
            try {
                profileLog('Obteniendo user_id para memberId:', memberId);

                const { data: memberData, error: memberError } = await window.supabase
                    .from('community_members')
                    .select('user_id, id')
                    .eq('id', memberId)
                    .single();

                if (memberError) {
                    profileError('Error obteniendo miembro:', memberError);
                    return null;
                }

                profileLog('Datos del miembro obtenidos:', memberData);
                return memberData.user_id;

            } catch (error) {
                profileError('Error en getCorrectUserId:', error);
                return null;
            }
        }

        // Funci√≥n de consulta directa a users
        async function getUserDataDirect(userId) {
            try {
                const { data: userData, error } = await window.supabase
                    .from('users')
                    .select(`
                        id, username, email, first_name, last_name, display_name,
                        cargo_rol, type_rol, bio, location, phone, profile_picture_url,
                        curriculum_url, linkedin_url, github_url, website_url,
                        points, created_at, updated_at, last_login_at, email_verified
                    `)
                    .eq('id', userId)
                    .single();

                if (error) {
                    profileError('Error en consulta directa:', error);
                    return null;
                }

                return userData;

            } catch (error) {
                profileError('Error en getUserDataDirect:', error);
                return null;
            }
        }

        // Funci√≥n alternativa con JOIN
        async function getUserDataWithJoin(memberId) {
            try {
                const { data: userData, error } = await window.supabase
                    .from('community_members')
                    .select(`
                        user_id,
                        users!inner(
                            id, username, email, first_name, last_name, display_name,
                            cargo_rol, type_rol, bio, location, phone, profile_picture_url,
                            curriculum_url, linkedin_url, github_url, website_url,
                            points, created_at, updated_at, last_login_at, email_verified
                        )
                    `)
                    .eq('id', memberId)
                    .single();

                if (error) {
                    profileError('Error en consulta con JOIN:', error);
                    return null;
                }

                // Retornar solo los datos del usuario
                return userData.users;

            } catch (error) {
                profileError('Error en getUserDataWithJoin:', error);
                return null;
            }
        }

        // Funci√≥n de validaci√≥n de datos
        function validateUserData(userData) {
            if (!userData) return false;

            // Verificar campos m√≠nimos requeridos
            const requiredFields = ['id', 'username'];
            const hasRequiredFields = requiredFields.every(field => userData[field]);

            if (!hasRequiredFields) {
                profileError('Datos de usuario incompletos:', userData);
                return false;
            }

            return true;
        }

        // Obtener datos del usuario con m√∫ltiples estrategias (FUNCI√ìN PRINCIPAL CORREGIDA)
        async function getUserData(memberId) {
            if (!memberId) {
                profileError('ID de miembro no proporcionado');
                return null;
            }

            try {
                if (!window.supabase) {
                    profileError('Supabase no est√° disponible');
                    return null;
                }

                profileLog('üîç Iniciando obtenci√≥n de datos para memberId:', memberId);

                // Estrategia 1: Obtener user_id desde community_members
                const userId = await getCorrectUserId(memberId);
                if (userId) {
                    profileLog('‚úÖ User_id obtenido:', userId);
                    const userData = await getUserDataDirect(userId);
                    if (userData && validateUserData(userData)) {
                        profileLog('‚úÖ Datos obtenidos con Estrategia 1 (user_id mapping)');
                        return userData;
                    }
                }

                // Estrategia 2: Consulta con JOIN
                profileLog('‚ö†Ô∏è Estrategia 1 fall√≥, intentando JOIN...');
                const userDataJoin = await getUserDataWithJoin(memberId);
                if (userDataJoin && validateUserData(userDataJoin)) {
                    profileLog('‚úÖ Datos obtenidos con Estrategia 2 (JOIN)');
                    return userDataJoin;
                }

                // Estrategia 3: Consulta directa con el ID original (caso especial)
                profileLog('‚ö†Ô∏è Estrategia 2 fall√≥, intentando consulta directa...');
                const userDataDirect = await getUserDataDirect(memberId);
                if (userDataDirect && validateUserData(userDataDirect)) {
                    profileLog('‚úÖ Datos obtenidos con Estrategia 3 (directa)');
                    return userDataDirect;
                }

                profileError('‚ùå No se pudieron obtener datos del usuario con ninguna estrategia');
                return null;

            } catch (error) {
                profileError('Error en getUserData:', error);
                return null;
            }
        }

        // Poblar modal con datos
        function populateProfileModal(userData) {
            if (!userData) {
                profileError('No hay datos de usuario para mostrar');
                showProfileError('No se pudieron cargar los datos del usuario');
                return;
            }

            try {
                // Funci√≥n helper para actualizar elementos
                const updateElement = (id, value, fallback = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value || fallback;
                        element.style.display = value ? 'block' : 'none';
                    } else {
                        profileError(`Elemento con ID '${id}' no encontrado`);
                    }
                };

                // Informaci√≥n b√°sica
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
                const displayName = fullName || userData.display_name || userData.username || 'Usuario';

                updateElement('profileName', displayName);
                updateElement('profileUsername', `@${userData.username}`);
                updateElement('profileRole', userData.cargo_rol);
                updateElement('profileBio', userData.bio);

                // Actualizar avatar con funci√≥n mejorada
                updateProfileAvatar(userData);

                // üö® ELIMINAR L√ìGICA HARDCODEADA - USAR DATOS REALES DE LA API
                // Los datos reales se cargan a trav√©s de loadRealUserProfile()
                console.log('‚ö†Ô∏è Esta funci√≥n legacy debe usar la nueva API. Redirigiendo a loadRealUserProfile()');

                // Llamar a la nueva funci√≥n que usa datos reales
                if (userData.id) {
                    loadRealUserProfile(userData.id);
                    return;
                }

                // Mostrar modal
                const modal = document.getElementById('userProfileModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                }

            } catch (error) {
                profileError('Error poblando modal:', error);
                showProfileError('Error mostrando informaci√≥n del usuario');
            }
        }

        // Abrir perfil de usuario
        async function openUserProfile(memberId) {
            if (!memberId) {
                profileError('ID de miembro no proporcionado');
                return;
            }

            try {
                profileLog('üöÄ Iniciando apertura de perfil para memberId:', memberId);

                // Limpiar listeners previos
                cleanupModalEventListeners();

                // Configurar listeners de cierre
                setupModalCloseListeners();

                // Mostrar modal con skeleton loader
                showProfileModalSkeleton();

                // Obtener datos usando las nuevas estrategias
                const userData = await getUserData(memberId);

                if (!userData) {
                    showProfileError('No se pudieron cargar los datos del usuario');
                    return;
                }

                profileLog('‚úÖ Datos de usuario obtenidos, poblando modal');

                // Poblar modal
                populateProfileModal(userData);

            } catch (error) {
                profileError('Error abriendo perfil:', error);
                showProfileError('Error cargando el perfil');
            }
        }

        // Cerrar perfil
        function closeUserProfile() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
        }

        // Mostrar skeleton loader
        function showProfileModalSkeleton() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        }

        // Mostrar error
        function showProfileError(message) {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('loading');
                // Aqu√≠ puedes agregar UI de error si es necesario
            }
            profileError(message);
        }

        // Configurar listeners para tarjetas de miembros
        function setupMemberCardListeners() {
            const cards = document.querySelectorAll('.member-card');
            profileLog(`Configurando listeners para ${cards.length} tarjetas`);

            cards.forEach((card, index) => {
                const userId = card.getAttribute('data-user-id');
                profileLog(`Tarjeta ${index + 1}: userId=${userId}`);

                card.removeEventListener('click', handleMemberCardClick);
                card.addEventListener('click', handleMemberCardClick);

                // Marcar la tarjeta como configurada
                card.setAttribute('data-listener-configured', 'true');
            });

            profileLog(`‚úÖ Configurados listeners para ${cards.length} tarjetas`);
        }

        // Funci√≥n de debugging para verificar estructura de tarjetas
        function debugMemberCard(memberId) {
            profileLog('üîç DEBUG - ID de miembro recibido:', memberId);
            profileLog('üîç DEBUG - Tipo de ID:', typeof memberId);

            const element = document.querySelector(`[data-user-id="${memberId}"]`);
            profileLog('üîç DEBUG - Elemento de tarjeta:', element);

            if (element) {
                profileLog('üîç DEBUG - Atributos de la tarjeta:', {
                    'data-user-id': element.getAttribute('data-user-id'),
                    'class': element.className,
                    'innerHTML': element.innerHTML.substring(0, 200) + '...'
                });
            }
        }

        // Handler para click en tarjeta
        function handleMemberCardClick(e) {
            profileLog('üî• Click detectado en tarjeta!');
            e.preventDefault();
            e.stopPropagation();

            const memberId = this.getAttribute('data-user-id');
            profileLog('MemberId obtenido de tarjeta:', memberId);

            // Debug de la tarjeta
            debugMemberCard(memberId);

            if (!memberId) {
                profileError('ID de miembro no encontrado en la tarjeta');
                return;
            }

            profileLog('Abriendo perfil de usuario para memberId:', memberId);
            openUserProfile(memberId);
        }

        // M√©todo alternativo: Event delegation en el documento
        document.addEventListener('click', function(e) {
            // Verificar si el click fue en una tarjeta de miembro
            const memberCard = e.target.closest('.member-card[data-user-id]');
            if (memberCard) {
                profileLog('üéØ Click capturado por event delegation');
                e.preventDefault();
                e.stopPropagation();

                const memberId = memberCard.getAttribute('data-user-id');
                profileLog('MemberId desde delegation:', memberId);

                // Debug de la tarjeta
                debugMemberCard(memberId);

                if (memberId) {
                    profileLog('Abriendo perfil desde delegation para memberId:', memberId);
                    openUserProfile(memberId);
                } else {
                    profileError('ID de miembro no encontrado en la tarjeta (delegation)');
                }
            }
        });

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            profileLog('DOM cargado, iniciando configuraci√≥n de modal');

            // Esperar un poco para que se carguen las tarjetas de miembros
            setTimeout(() => {
                // Primero remover todos los listeners existentes
                document.querySelectorAll('.member-card').forEach(card => {
                    // Remover tanto el listener anterior como el nuevo
                    card.removeEventListener('click', handleMemberCardClick);
                    const oldHandler = card.onclick;
                    if (oldHandler) {
                        card.removeEventListener('click', oldHandler);
                        card.onclick = null;
                    }
                });

                // Ahora agregar los nuevos listeners
                setupMemberCardListeners();
                console.log('‚úÖ [PROFILE CORRECTION] Listeners de tarjetas configurados');
            }, 1500); // M√°s tiempo para asegurar que todo est√© cargado
        });

        // Tambi√©n inicializar cuando se rendericen nuevos miembros
        // Esto se puede llamar desde la funci√≥n renderMembers existente
        window.setupMemberCardListeners = setupMemberCardListeners;

        // Observador para detectar cuando se agregan nuevas tarjetas din√°micamente
        const cardObserver = new MutationObserver(function(mutations) {
            let cardsAdded = false;
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList && node.classList.contains('member-card')) {
                                cardsAdded = true;
                            } else if (node.querySelectorAll) {
                                const cards = node.querySelectorAll('.member-card');
                                if (cards.length > 0) cardsAdded = true;
                            }
                        }
                    });
                }
            });

            if (cardsAdded) {
                setTimeout(() => {
                    setupMemberCardListeners();
                    console.log('‚úÖ [PROFILE CORRECTION] Nuevas tarjetas detectadas, listeners reconfigurados');
                }, 100);
            }
        });

        // Observar el contenedor principal de miembros
        const memberContainer = document.getElementById('membersList') || document.querySelector('.members-container') || document.body;
        if (memberContainer) {
            cardObserver.observe(memberContainer, {
                childList: true,
                subtree: true
            });
        }

        // Sobrescribir funciones globales para evitar conflictos
        window.openUserProfile = openUserProfile;
        window.closeUserProfile = closeUserProfile;
        window.getUserData = getUserData;
        window.populateProfileModal = populateProfileModal;
        window.showProfileModalSkeleton = showProfileModalSkeleton;
        window.showProfileError = showProfileError;
        window.handleMemberCardClick = handleMemberCardClick;

        console.log('‚úÖ [PROFILE CORRECTION] Correcciones del modal aplicadas exitosamente');
    </script>

    <!-- SCRIPT DE CORRECCI√ìN FINAL DEL MODAL DE PERFIL -->
    <script>
        // ====================================================================
        // CORRECCI√ìN DEFINITIVA DEL MODAL DE PERFIL DE USUARIO
        // ====================================================================

        // Limpiar todas las definiciones previas y crear un sistema funcional
        (function() {
            'use strict';

            console.log('üöÄ [MODAL FIX] Iniciando correcci√≥n definitiva del modal de perfil...');

            // Sistema de modal de perfil limpio y funcional
            class ProfileModalFixed {
                constructor() {
                    this.modal = null;
                    this.isOpen = false;
                    this.currentUserId = null;
                    this.init();
                }

                init() {
                    // Esperar a que el DOM est√© completamente cargado
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', () => this.setup());
                    } else {
                        this.setup();
                    }
                }

                setup() {
                    console.log('üîß [MODAL FIX] Configurando modal...');

                    this.modal = document.getElementById('userProfileModal');
                    if (!this.modal) {
                        console.error('‚ùå [MODAL FIX] Modal no encontrado');
                        return;
                    }

                    this.setupEventListeners();
                    this.observeMemberCards();

                    console.log('‚úÖ [MODAL FIX] Modal configurado correctamente');
                }

                setupEventListeners() {
                    // Cerrar con bot√≥n X
                    const closeBtn = document.getElementById('closeProfileModal');

                    if (closeBtn) {
                        closeBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.close();
                        });
                    }

                    // Cerrar con overlay
                    const overlay = document.getElementById('modalOverlay');
                    if (overlay) {
                        overlay.addEventListener('click', () => this.close());
                    }

                    // Cerrar con ESC
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            this.close();
                        }
                    });

                    // Cerrar clickeando fuera
                    this.modal.addEventListener('click', (e) => {
                        if (e.target === this.modal) {
                            this.close();
                        }
                    });
                }

                observeMemberCards() {
                    const membersList = document.getElementById('membersList');
                    if (!membersList) return;

                    // Observer para nuevas tarjetas
                    const observer = new MutationObserver(() => {
                        this.bindMemberCards();
                    });

                    observer.observe(membersList, {
                        childList: true,
                        subtree: true
                    });

                    // Configurar tarjetas iniciales
                    this.bindMemberCards();
                }

                bindMemberCards() {
                    const cards = document.querySelectorAll('.member-card[data-user-id]');

                    cards.forEach(card => {
                        // Remover listener previo
                        card.removeEventListener('click', this.memberCardHandler);

                        // Agregar nuevo listener
                        card.addEventListener('click', (e) => this.memberCardHandler(e, card));
                    });

                    console.log(`üîó [MODAL FIX] ${cards.length} tarjetas configuradas`);
                }

                memberCardHandler(e, card) {
                    e.preventDefault();
                    e.stopPropagation();

                    const memberId = card.getAttribute('data-user-id');
                    if (memberId) {
                        console.log(`üîç [MODAL FIX] Abriendo modal para miembro ID: ${memberId}`);
                        this.open(memberId);
                    } else {
                        console.warn('‚ö†Ô∏è [MODAL FIX] No se encontr√≥ data-user-id en la tarjeta');
                    }
                }

                async open(memberId) {
                    console.log(`üë§ [MODAL FIX] Abriendo perfil para miembro: ${memberId}`);

                    this.currentUserId = memberId;
                    this.isOpen = true;

                    // Mostrar modal con skeleton
                    this.showModal();
                    this.showSkeleton();

                    try {
                        // Cargar datos del miembro y usuario
                        const userData = await this.loadUserData(memberId);

                        if (userData) {
                            this.renderUserData(userData);
                        } else {
                            this.showError('Usuario no encontrado');
                        }
                    } catch (error) {
                        console.error('‚ùå [MODAL FIX] Error:', error);
                        this.showError('Error cargando el perfil');
                    }
                }

                async loadUserData(memberId) {
                    if (!window.supabase) {
                        console.warn('‚ö†Ô∏è [MODAL FIX] Supabase no disponible');
                        return null;
                    }

                    try {
                        console.log('üîç [MODAL FIX] Buscando datos para memberId:', memberId);

                        // Primero obtener el member con sus datos de usuario
                        const { data: memberData, error: memberError } = await window.supabase
                            .from('community_members')
                            .select(`
                                *,
                                users:user_id (
                                    id,
                                    email,
                                    display_name,
                                    first_name,
                                    last_name,
                                    username,
                                    profile_picture_url,
                                    created_at
                                )
                            `)
                            .eq('id', memberId)
                            .single();

                        if (memberError) {
                            console.error('‚ùå [MODAL FIX] Error consultando miembro:', memberError);
                            return null;
                        }

                        if (!memberData || !memberData.users) {
                            console.error('‚ùå [MODAL FIX] No se encontraron datos del usuario para el miembro');
                            return null;
                        }

                        // Combinar datos del miembro y del usuario
                        const userData = {
                            ...memberData.users,
                            // Agregar datos espec√≠ficos del miembro
                            member_id: memberData.id,
                            community_id: memberData.community_id,
                            member_role: memberData.role,
                            joined_at: memberData.joined_at,
                            member_points: memberData.points || 0,
                            is_active: memberData.is_active
                        };

                        console.log('‚úÖ [MODAL FIX] Datos del usuario obtenidos:', userData);
                        return userData;

                    } catch (error) {
                        console.error('‚ùå [MODAL FIX] Error en loadUserData:', error);
                        return null;
                    }
                }

                renderUserData(userData) {
                    console.log('üìù [MODAL FIX] Redirigiendo a loadRealUserProfile para datos reales:', userData);

                    // üö® ELIMINAR COMPLETAMENTE DATOS HARDCODEADOS/SIMULADOS
                    // Esta funci√≥n ahora usa SOLO datos reales de la base de datos

                    if (userData && userData.id) {
                        // Usar la nueva funci√≥n que carga datos reales
                        console.log('‚úÖ [MODAL FIX] Llamando a loadRealUserProfile con userId:', userData.id);
                        loadRealUserProfile(userData.id);
                    } else {
                        console.error('‚ùå [MODAL FIX] No se pudo obtener ID de usuario para cargar datos reales');
                        showProfileError('No se pudo cargar el perfil del usuario');
                    }

                    // Finalizar carga
                    this.hideSkeleton();
                }

            setText(elementId, text) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                } else {
                    console.warn(`‚ö†Ô∏è [MODAL FIX] Elemento '${elementId}' no encontrado`);
                }
            }

            setAvatar(avatarUrl) {
                // Validaci√≥n menos estricta para mejorar compatibilidad del perfil
                if (!avatarUrl || avatarUrl.trim() === '' || avatarUrl === 'null') {
                    console.log('‚ÑπÔ∏è [AVATAR] URL de avatar vac√≠a o nula, usando fallback');
                    return;
                }
                
                // Crear objeto usuario temporal para usar la funci√≥n mejorada
                const tempUser = { profile_picture_url: avatarUrl };
                updateProfileAvatar(tempUser);
            }

            setRole(role) {
                const roleElement = document.getElementById('profileRole');
                if (roleElement) {
                    if (role && role !== 'member') {
                        roleElement.textContent = role === 'admin' ? 'Admin' : 'Moderador';
                        roleElement.style.display = 'inline-block';
                    } else {
                        roleElement.style.display = 'none';
                    }
                }
            }

            getDisplayName(userData) {
                const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
                return fullName || userData.display_name || userData.username || 'Usuario';
            }

            formatDate(dateString) {
                if (!dateString) return '--';

                const date = new Date(dateString);
                const now = new Date();
                const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (days < 1) return 'Hoy';
                if (days < 7) return `${days} d√≠as`;
                if (days < 30) return `${Math.floor(days / 7)} semanas`;
                if (days < 365) return `${Math.floor(days / 30)} meses`;
                return `${Math.floor(days / 365)} a√±os`;
            }

            calculateLeague(points) {
                if (points >= 1000) return 'Liga Diamante';
                if (points >= 500) return 'Liga Platino';
                return 'Liga Oro';
            }

            simpleHash(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash);
            }

            showModal() {
                this.modal.style.display = 'flex';
                this.modal.classList.add('active');
            }

            showSkeleton() {
                this.modal.classList.add('loading');
            }

            hideSkeleton() {
                this.modal.classList.remove('loading');
            }

            showError(message) {
                this.modal.classList.remove('loading');

                const profileCard = this.modal.querySelector('.profile-card');
                if (profileCard) {
                    profileCard.innerHTML = `
                        <button class="close-btn" id="closeProfileModal">√ó</button>
                        <div style="padding: 40px 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f39c12; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 10px; color: var(--text-primary);">Error</h3>
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">${message}</p>
                            <button class="btn-secondary" onclick="window.profileModalFixed.close()">Cerrar</button>
                        </div>
                    `;

                    // Re-configurar listener del bot√≥n de cierre
                    const closeBtn = profileCard.querySelector('#closeProfileModal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => this.close());
                    }
                }
            }

            close() {
                console.log('‚úÖ [MODAL FIX] Cerrando modal');

                this.modal.classList.remove('active', 'loading');
                this.modal.style.display = 'none';
                this.isOpen = false;
                this.currentUserId = null;
            }
        }

        // Instanciar el sistema corregido
        window.profileModalFixed = new ProfileModalFixed();

        // Sobrescribir funciones globales para asegurar compatibilidad
        window.openUserProfile = (memberId) => window.profileModalFixed.open(memberId);
        window.closeUserProfile = () => window.profileModalFixed.close();

        console.log('‚úÖ [MODAL FIX] Sistema del modal de perfil corregido e instalado');

    })();
    </script>

    <!-- Modal de Perfil de Usuario -->
    <div class="user-profile-modal" id="userProfileModal">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="profile-card">
            <button class="close-btn" id="closeProfileModal">√ó</button>

            <!-- Header del Perfil -->
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatarContainer">
                    <img src="" alt="Usuario" class="avatar-img" id="profileAvatar" style="display: none;">
                    <div class="avatar-fallback" id="profileAvatarFallback">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="online-status" id="onlineStatus"></div>
                </div>
                <div class="profile-info">
                    <h2 class="profile-name" id="profileName">Nombre Completo</h2>
                    <p class="profile-username" id="profileUsername">@username</p>
                    <div class="profile-badges">
                        <span class="role-badge" id="profileRole" style="display: none;">Admin</span>
                        <span class="league-badge" id="profileLeague">Cargando...</span>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas del Perfil -->
            <div class="profile-section">
                <h3 class="section-title dante99">Estad√≠sticas</h3>
                <div class="profile-stats-horizontal">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <span class="stat-label">Miembro desde</span>
                            <span class="stat-value" id="profileJoinDate">--</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-star"></i></div>
                        <div class="stat-info">
                            <span class="stat-label">Puntos</span>
                            <span class="stat-value" id="profilePoints">0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="stat-info">
                            <span class="stat-label">Rango</span>
                            <span class="stat-value" id="profileRank">#--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Personal -->
            <div class="profile-section">
                <h3 class="section-title dante99">Informaci√≥n Personal</h3>
                <div class="profile-info-horizontal">
                    <div class="info-card">
                        <div class="info-icon"><i class="fas fa-envelope"></i></div>
                        <div class="info-content">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="profileEmail">--</span>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="info-content">
                            <span class="info-label">Ubicaci√≥n</span>
                            <span class="info-value" id="profileLocation">--</span>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="info-content">
                            <span class="info-label">Biograf√≠a</span>
                            <span class="info-value" id="profileBio">Sin biograf√≠a</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actividad en la Comunidad -->
            <div class="profile-section">
                <h3 class="section-title dante99">Actividad en la Comunidad</h3>
                <div class="activity-stats-horizontal">
                    <div class="activity-card">
                        <div class="activity-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="activity-content">
                            <span class="activity-number" id="profilePosts">0</span>
                            <span class="activity-label">Publicaciones</span>
                        </div>
                    </div>
                    <div class="activity-card">
                        <div class="activity-icon"><i class="fas fa-comment"></i></div>
                        <div class="activity-content">
                            <span class="activity-number" id="profileComments">0</span>
                            <span class="activity-label">Comentarios</span>
                        </div>
                    </div>
                    <div class="activity-card">
                        <div class="activity-icon"><i class="fas fa-thumbs-up"></i></div>
                        <div class="activity-content">
                            <span class="activity-number" id="profileReactions">0</span>
                            <span class="activity-label">Reacciones</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ===================================================================
         MODAL DE VIDEO DE INTRODUCCI√ìN
         Muestra videos desde la base de datos (tabla community_videos)
         ================================================================ -->
    <div class="video-modal" id="introVideoModal" style="display: none;">
        <div class="video-modal-overlay" id="videoModalOverlay"></div>
        <div class="video-modal-content">
            <div class="video-modal-header">
                <h3 id="videoModalTitle">Video de Introducci√≥n</h3>
                <button class="video-modal-close" id="closeVideoModal" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="video-modal-body">
                <div class="video-player-wrapper" id="videoPlayerWrapper">
                    <!-- El iframe del video se insertar√° aqu√≠ din√°micamente -->
                    <div class="video-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Cargando video...</p>
                    </div>
                </div>
                <div class="video-description" id="videoDescription"></div>
            </div>
        </div>
    </div>

</body>
</html>


